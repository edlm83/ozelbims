<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cloud Shift Register V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- Ø¥Ø¶Ø§ÙØ© FontAwesome Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f3f4f6; }
        
        /* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ --- */
        .table-container { overflow-x: auto; max-height: 70vh; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        thead th { position: sticky; top: 0; z-index: 10; background-color: #1e3a8a; color: white; }
        
        .select-none { user-select: none; -webkit-user-select: none; }

        /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„Ø§Øª */
        .status-present { background-color: #dcfce7; color: #166534; }
        .status-absent { background-color: #fee2e2; color: #991b1b; }
        .status-vacation { background-color: #fef3c7; color: #92400e; }
        .status-holiday { background-color: #f3e8ff; color: #6b21a8; }
        
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        td input, td select { text-align: center !important; text-align-last: center !important; }
        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø³Ù‡Ù… ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        td input[type=number]::-webkit-inner-spin-button, 
        td input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        td input[type=number] { -moz-appearance: textfield; }

        /* Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø³Ù‡Ù… ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„Ø³Ù†Ø© ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (Ø§Ø­ØªÙŠØ§Ø·) */
        #repYearInput::-webkit-inner-spin-button, 
        #repYearInput::-webkit-outer-spin-button { -webkit-appearance: inner-spin-button !important; opacity: 1 !important; }
        
        /* ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© */
        input:disabled, select:disabled { 
            background-color: #f8fafc; cursor: default; color: #000000 !important; 
            border-color: #cbd5e1; opacity: 1 !important; -webkit-text-fill-color: #000000 !important; font-weight: 700; 
        }
        select:disabled { appearance: none; background-image: none !important; }
        
        /* Ø§Ù„Ù†ÙˆØ§ÙØ° */
        .overlay { position: fixed; inset: 0; background: rgba(17, 24, 39, 0.95); z-index: 50; display: flex; justify-content: center; align-items: center; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 40; display: flex; justify-content: center; align-items: center; padding: 1rem; }
        .hidden { display: none !important; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .fade-in-down { animation: fadeInDown 0.3s ease-out forwards; }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª */
        .draggable-row { cursor: grab; }
        .draggable-row.dragging { opacity: 0.5; background-color: #e0f2fe; }
        .drag-handle { cursor: grab; color: #9ca3af; font-size: 1.2rem; margin-left: 0.5rem; }
        .drag-handle:hover { color: #2563eb; }
        .drag-over { border-top: 2px solid #2563eb; }

        /* ØªØ­Ø³ÙŠÙ† Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù„ØºØ© */
        .lang-btn {
            transition: all 0.3s ease;
            filter: grayscale(100%);
            opacity: 0.6;
            border: 2px solid transparent;
            transform: scale(0.9);
        }
        .lang-btn:hover {
            filter: grayscale(0%);
            opacity: 0.8;
            transform: scale(1);
        }
        .lang-active {
            filter: grayscale(0%) !important;
            opacity: 1 !important;
            border-color: #22c55e !important; /* Green-500 */
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.3);
            animation: pulse-green 2s infinite;
            transform: scale(1.1) !important;
        }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        /* ========================================
           Mega Icon Card v2 (Premium Glass Style)
           ========================================
        */
        .mega-icon-card {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 12px 28px;
            background: rgba(255, 255, 255, 0.05); /* Ø´ÙØ§ÙÙŠØ© Ø¹Ø§Ù„ÙŠØ© */
            border-radius: 50px; /* ÙƒØ¨Ø³ÙˆÙ„Ø© ÙƒØ§Ù…Ù„Ø© */
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            text-decoration: none;
            overflow: hidden;
            position: relative;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.3);
            cursor: default; /* Ø§Ù„Ù†Øµ ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù†Ù‚Ø± */
            direction: ltr;
        }

        /* ØªØ¹Ø±ÙŠÙ Ø­Ø±ÙƒØ© Ø§Ù„Ù„Ù…Ø¹Ø§Ù† Ø§Ù„Ù…Ø³ØªÙ…Ø± */
        @keyframes continuous-shine {
            0% { left: -100%; opacity: 0; }
            10% { opacity: 1; }
            50% { left: 200%; opacity: 0; }
            100% { left: 200%; opacity: 0; }
        }

        /* Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ù„Ø§Ù…Ø¹Ø© Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© */
        .mega-icon-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
            transform: skewX(-25deg);
            pointer-events: none;
            /* ØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ© Ø¨Ø´ÙƒÙ„ Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠ ÙƒÙ„ 3.5 Ø«Ø§Ù†ÙŠØ© */
            animation: continuous-shine 3.5s infinite ease-in-out;
        }

        .mega-icon-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
        }

        .mega-icon-card i {
            font-size: 1.5rem;
            color: #60a5fa; /* Ø§Ù„Ø£Ø²Ø±Ù‚ */
            transition: transform 0.3s ease;
        }

        .mega-icon-card span {
            color: #ffffff;
            font-weight: 700;
            font-size: 0.9rem;
            letter-spacing: 1px;
            font-family: 'Segoe UI', sans-serif;
            text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ³Ø¨ÙˆÙƒ */
        .fb-icon-link {
            color: #60a5fa; /* Ø§Ù„Ø£Ø²Ø±Ù‚ */
            font-size: 1.6rem;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .fb-icon-link:hover {
            color: #1877F2; /* ÙÙŠØ³Ø¨ÙˆÙƒ Ø§Ù„Ø£ØµÙ„ÙŠ */
            transform: scale(1.2) rotate(10deg);
            filter: drop-shadow(0 0 8px rgba(24, 119, 242, 0.6));
        }

        /* ØªØ®ØµÙŠØµ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­ (Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚) - ØªØ­Ø³ÙŠÙ†Ø§Øª Ù‚ÙˆÙŠØ© */
        .mega-icon-card.light-mode {
            /* Ø®Ù„ÙÙŠØ© Ù…ØªØ¯Ø±Ø¬Ø© Ø®ÙÙŠÙØ© Ø¬Ø¯Ø§Ù‹ Ù„Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ø²Ø¬Ø§Ø¬ */
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(240, 242, 245, 0.4));
            /* Ø­Ø¯ÙˆØ¯ Ø£Ù‚ÙˆÙ‰ ÙˆØ£ÙˆØ¶Ø­ */
            border: 1px solid rgba(255, 255, 255, 0.9);
            /* Ø¸Ù„ Ù‚ÙˆÙŠ ÙˆÙ†Ø§Ø¹Ù… Ù„ÙØµÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¹Ù† Ø§Ù„Ø®Ù„ÙÙŠØ© */
            box-shadow: 
                0 10px 15px -3px rgba(0, 0, 0, 0.1), 
                0 4px 6px -2px rgba(0, 0, 0, 0.05),
                inset 0 0 20px rgba(255, 255, 255, 0.5); /* Ø¥Ø¶Ø§Ø¡Ø© Ø¯Ø§Ø®Ù„ÙŠØ© */
        }
        
        /* ØªØ¹Ø¯ÙŠÙ„ Ù„ÙˆÙ† Ø§Ù„Ù„Ù…Ø¹Ø§Ù† Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­ Ù„ÙŠÙƒÙˆÙ† Ø£ÙˆØ¶Ø­ */
        .mega-icon-card.light-mode::before {
             background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.9), transparent);
        }
        
        .mega-icon-card.light-mode span {
            color: #475569; /* Ù„ÙˆÙ† Ø±Ù…Ø§Ø¯ÙŠ Ù…Ø²Ø±Ù‚ Ø£Ù†ÙŠÙ‚ */
            text-shadow: none;
            font-weight: 800;
        }
        
        .mega-icon-card.light-mode .fb-icon-link {
            color: #3b82f6;
        }
        
        .mega-icon-card.light-mode .fb-icon-link:hover {
            color: #1877F2;
            filter: drop-shadow(0 0 5px rgba(24, 119, 242, 0.4));
        }

        /* Zoom In Animation */
        [data-aos="zoom-in"] {
            animation: zoomIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            opacity: 0;
        }
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Ù…ÙˆØ¨Ø§ÙŠÙ„ (Card View) - ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± */
        @media (max-width: 768px) {
            .table-container, .overflow-auto { background: transparent; box-shadow: none; overflow: visible !important; max-height: none !important; border: none; }
            #monthlyReportOverlay .overflow-auto { overflow-y: auto !important; -webkit-overflow-scrolling: touch; max-height: 70vh !important; }
            table, thead, tbody, th, td, tr { display: block; width: 100%; }
            thead { display: none; }
            
            /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ø§Ù…Ø© */
            tr { background: white; margin-bottom: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); padding: 0; border: 1px solid #e5e7eb; overflow: hidden; }
            
            /* Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
            td { padding: 0.8rem 1.2rem; border-bottom: 1px solid #f8f9fa; display: flex; justify-content: space-between; align-items: center; text-align: start; min-height: 50px; }
            td:last-child { border-bottom: none; }
            
            /* Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Label) */
            td::before { 
                content: attr(data-label); 
                font-weight: 600; 
                color: #6b7280; 
                font-size: 0.9rem; 
                flex-basis: 40%; 
                text-align: start; 
            }
            
            /* Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù (Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©) */
            td[data-label-type="name"] { background: linear-gradient(to left, #eff6ff, #ffffff); padding: 1rem; justify-content: center; color: #1e40af; font-size: 1.1rem; font-weight: 800; border-bottom: 2px solid #dbeafe; border-top: 4px solid #3b82f6; }
            td[data-label-type="name"]::before { display: none; } 
            
            td[data-label-type="index"] { display: none; }
            td input, td select { width: 55% !important; max-width: none !important; padding: 0.6rem; background-color: #fff; }
            td.delete-col { background: #fef2f2; justify-content: center; padding: 0.8rem; }
            td.delete-col button { width: 100%; color: #ef4444; font-weight: bold; }
            td.delete-col::before { display: none; }

            /* --- ØªØ­Ø³ÙŠÙ†Ø§Øª Ø®Ø§ØµØ© Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ --- */
            /* ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© */
            #reportTableBody td[data-label*="Ø§Ù„Ø­Ø¶ÙˆØ±"]::before, #reportTableBody td[data-label*="Present"]::before { color: #15803d; } /* Ø£Ø®Ø¶Ø± */
            #reportTableBody td[data-label*="Ø§Ù„ØºÙŠØ§Ø¨"]::before, #reportTableBody td[data-label*="Absent"]::before { color: #b91c1c; } /* Ø£Ø­Ù…Ø± */
            #reportTableBody td[data-label*="Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©"]::before, #reportTableBody td[data-label*="Vacation"]::before { color: #a16207; } /* Ø£ØµÙØ± ØºØ§Ù…Ù‚ */
            #reportTableBody td[data-label*="Ø§Ù„ØªØ£Ø®ÙŠØ±"]::before, #reportTableBody td[data-label*="Delay"]::before { color: #dc2626; } /* Ø£Ø­Ù…Ø± ÙØ§ØªØ­ */
        }
    </style>
</head>
<body class="p-4 md:p-6 text-gray-800 transition-all duration-300">

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div id="loadingScreen" class="overlay hidden" style="z-index: 60; background: rgba(255,255,255,0.9);">
        <div class="flex flex-col items-center">
            <div class="loader mb-4 border-t-blue-600"></div>
            <p class="text-blue-900 font-bold" id="loadingText" data-i18n="loading_processing">Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginOverlay" class="overlay flex-col gap-10">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center relative">
            <!-- Ø£Ø¹Ù„Ø§Ù… Ø§Ù„Ù„ØºØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø±Ø¨Ø¹ -->
            <div class="flex justify-center gap-4 mb-6">
                <button id="btn-tr" onclick="changeLanguage('tr')" class="lang-btn w-10 h-10 rounded-full bg-white p-0.5 overflow-hidden" title="TÃ¼rkÃ§e">
                    <img src="https://flagcdn.com/w80/tr.png" class="w-full h-full object-cover rounded-full">
                </button>
                <button id="btn-ar" onclick="changeLanguage('ar')" class="lang-btn lang-active w-10 h-10 rounded-full bg-white p-0.5 overflow-hidden" title="Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">
                    <img src="https://flagcdn.com/w80/sy.png" class="w-full h-full object-cover rounded-full">
                </button>
            </div>

            <h2 class="text-2xl font-bold text-gray-800 mb-2" data-i18n="login_title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <p class="text-gray-500 mb-6 text-sm">Cloud Shift Register <span class="text-xs bg-blue-100 text-blue-800 px-1 rounded">V3</span></p>
            <input type="password" id="accessCode" class="w-full p-3 border border-gray-300 rounded-lg mb-4 text-center text-lg tracking-widest focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Code">
            <button onclick="checkLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition mb-4" data-i18n="login_btn">Ø¯Ø®ÙˆÙ„</button>
            
            <div class="text-xs text-gray-400 bg-gray-50 p-3 rounded border text-start space-y-2">
                <p data-i18n="role_admin">Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…: 56401</p>
                <p data-i18n="role_shift_b_man">Ù…Ø¯ÙŠØ± Ø§Ù„ÙˆØ±Ø¯ÙŠØ© B ÙÙ‚Ø·: 2222</p>
                <p data-i18n="role_accountant">Ø§Ù„Ù…Ø­Ø§Ø³Ø¨: 3838</p>
            </div>
            <p id="loginError" class="text-red-500 text-sm mt-2 hidden" data-i18n="wrong_code">Ø±Ù…Ø² Ø®Ø§Ø·Ø¦</p>
        </div>

        <!-- Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (ØªØµÙ…ÙŠÙ… Mega Icon Card) -->
        <div class="mega-icon-card" data-aos="zoom-in">
            <span>Developed by EMAD ALLAHAM</span>
            <a href="https://www.facebook.com/emad.allahaam" target="_blank" class="fb-icon-link" title="Visit Facebook Page">
                <i class="fa-brands fa-facebook"></i>
            </a>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù -->
    <div id="addEmployeeOverlay" class="modal-overlay hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4" id="empModalTitle" data-i18n="add_emp_title">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</h3>
            <input type="hidden" id="editEmployeeId">
            <input type="text" id="newEmployeeName" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ" data-i18n-ph="ph_employee_name">
            
            <div class="mb-4">
                <label class="text-xs font-bold text-gray-500 mb-1 block" data-i18n="lbl_shift">Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</label>
                <select id="newEmployeeShift" class="w-full p-2 border border-gray-300 rounded-lg">
                    <option value="shift_A" data-i18n="val_shift_a">Ø§Ù„ÙˆØ±Ø¯ÙŠØ© A</option>
                    <option value="shift_B" data-i18n="val_shift_b">Ø§Ù„ÙˆØ±Ø¯ÙŠØ© B</option>
                </select>
            </div>

            <div class="flex gap-2">
                <button onclick="saveEmployeeToMasterList()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition" data-i18n="save">Ø­ÙØ¸</button>
                <button onclick="toggleModal('addEmployeeOverlay', false)" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 rounded-lg transition" data-i18n="cancel">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Backup/Restore) -->
    <div id="dataManagerOverlay" class="modal-overlay hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-md w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span>ğŸ’¾</span> <span data-i18n="data_management">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
            </h3>
            
            <!-- Ù‚Ø³Ù… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… -->
            <div class="mb-6 bg-orange-50 p-3 rounded border border-orange-200">
                <h4 class="font-bold text-orange-800 text-sm mb-2" data-i18n="legacy_import_title">ğŸ“¥ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… (V2)</h4>
                <p class="text-xs text-orange-600 mb-3" data-i18n="legacy_import_desc">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ù…Ù† Ù…Ù„ÙØ§Øª Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø§Ø¶ÙŠØ©.</p>
                <button onclick="importLegacyEmployees()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 rounded text-sm shadow" data-i18n="btn_import_legacy">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø³Ø¬Ù„Ø§Øª</button>
            </div>

            <!-- Ù‚Ø³Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ -->
            <div class="space-y-3">
                <button onclick="exportBackup()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded flex justify-center items-center gap-2">
                    <span>â¬‡ï¸</span> <span data-i18n="btn_backup_download">ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (JSON)</span>
                </button>
                
                <div class="relative">
                    <input type="file" id="restoreFile" class="hidden" onchange="restoreBackup(this)">
                    <button onclick="document.getElementById('restoreFile').click()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded flex justify-center items-center gap-2">
                        <span>â¬†ï¸</span> <span data-i18n="btn_restore_upload">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø© Ù…Ø­ÙÙˆØ¸Ø©</span>
                    </button>
                </div>
            </div>

            <button onclick="toggleModal('dataManagerOverlay', false)" class="w-full mt-4 text-gray-500 hover:bg-gray-100 py-2 rounded" data-i18n="close">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
    <div id="monthlyReportOverlay" class="modal-overlay hidden" style="align-items: flex-start; padding-top: 2rem;">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl flex flex-col max-h-[90vh] md:h-[90vh]">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold text-gray-800" data-i18n="reports_title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h3>
                <button onclick="toggleModal('monthlyReportOverlay', false)" class="text-red-500 hover:bg-red-50 px-3 py-1 rounded" data-i18n="close">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
            <div class="flex flex-wrap gap-3 p-4 bg-gray-50 border-b items-center">
                <div class="flex items-center gap-2">
                    <div class="flex flex-col">
                        <label class="text-xs font-bold text-gray-500" data-i18n="lbl_year">Ø§Ù„Ø³Ù†Ø©</label>
                         <!-- ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ø¨Ø£Ø²Ø±Ø§Ø± ØªØ­ÙƒÙ… + Ùˆ - Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
                        <div class="flex items-center">
                            <button onclick="adjustRepYear(1)" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-3 rounded-r-md transition">+</button>
                            <input type="number" id="repYearInput" class="p-2 border-y w-16 text-center font-bold outline-none border-gray-200" style="border-radius: 0;">
                            <button onclick="adjustRepYear(-1)" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-3 rounded-l-md transition">-</button>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <label class="text-xs font-bold text-gray-500" data-i18n="lbl_month">Ø§Ù„Ø´Ù‡Ø±</label>
                        <select id="repMonthSelect" onchange="generateReport('monthly')" class="p-2 border rounded w-28 font-bold cursor-pointer">
                            <option value="01">01</option> <option value="02">02</option> <option value="03">03</option>
                            <option value="04">04</option> <option value="05">05</option> <option value="06">06</option>
                            <option value="07">07</option> <option value="08">08</option> <option value="09">09</option>
                            <option value="10">10</option> <option value="11">11</option> <option value="12">12</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-2 flex-grow justify-end">
                    <button onclick="generateReport('monthly')" class="bg-blue-600 text-white px-3 py-2 rounded text-xs md:text-sm font-bold hover:bg-blue-700" data-i18n="btn_monthly_report">Ø´Ù‡Ø±ÙŠ</button>
                    <button onclick="generateReport('annual')" class="bg-indigo-600 text-white px-3 py-2 rounded text-xs md:text-sm font-bold hover:bg-indigo-700" data-i18n="btn_annual_report">Ø³Ù†ÙˆÙŠ</button>
                    <button onclick="exportReportToCSV()" class="bg-green-600 text-white px-3 py-2 rounded text-xs md:text-sm font-bold hover:bg-green-700" data-i18n="export_excel">Excel</button>
                </div>
            </div>
            <div id="reportTitleDisplay" class="text-center font-bold text-lg text-blue-900 py-2 border-b bg-blue-50/50"></div>
            <div class="flex-1 overflow-auto p-2 relative bg-gray-50">
                <table class="w-full text-start text-sm border-collapse bg-white shadow-sm rounded-lg">
                    <thead class="bg-blue-100 text-gray-800 sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="p-3 border border-gray-200 text-start" data-i18n="th_name">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                            <th class="p-3 border border-gray-200 text-center" data-i18n="th_present">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</th>
                            <th class="p-3 border border-gray-200 text-center" data-i18n="th_absent">Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨</th>
                            <th class="p-3 border border-gray-200 text-center" data-i18n="th_vacation">Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©</th>
                            <th class="p-3 border border-gray-200 text-center text-purple-700" data-i18n="th_holiday">Ø¹Ø·Ù„</th>
                            <th class="p-3 border border-gray-200 text-center" data-i18n="th_total_overtime">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</th>
                            <th class="p-3 border border-gray-200 text-center text-red-600" data-i18n="th_total_delay">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ£Ø®ÙŠØ±</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div id="appContainer" class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-4 md:p-6 hidden h-full md:h-auto min-h-screen md:min-h-0 flex flex-col">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b pb-4 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-blue-900 flex items-center gap-2">
                    <span data-i18n="app_title">Ø³Ø¬Ù„ Ø§Ù„ÙˆØ±Ø¯ÙŠØ§Øª</span>
                    <span id="shiftBadge" class="hidden text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full" data-i18n="badge_shift_b">Ø§Ù„ÙˆØ±Ø¯ÙŠØ© B</span>
                </h1>
                <div class="flex items-center gap-2 mt-1">
                    <span id="connectionDot" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <p id="connectionText" class="text-green-600 text-xs font-bold" data-i18n="status_online">Ù…ØªØµÙ„ ÙˆØ¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                 <!-- Ø²Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
                 <button id="dataBtn" onclick="toggleModal('dataManagerOverlay', true)" class="hidden bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded shadow flex items-center gap-2 transition text-sm">
                    <span>ğŸ’¾</span> <span class="hidden md:inline" data-i18n="data_btn">Ø¨ÙŠØ§Ù†Ø§Øª</span>
                </button>
                 <button onclick="openReportModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded shadow flex items-center gap-2 transition text-sm">
                    <span data-i18n="reports_title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
                </button>
                <button onclick="logout()" class="text-gray-500 hover:text-red-600 text-sm underline px-2" data-i18n="logout">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-end md:items-center mb-4 gap-4 bg-blue-50 p-4 rounded-lg border border-blue-100">
            <div class="flex flex-wrap gap-4 items-end w-full md:w-auto">
                <div class="flex flex-col gap-1">
                    <label class="text-xs font-bold text-blue-800" data-i18n="shift_date">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ±Ø¯ÙŠØ©:</label>
                    <input type="date" id="currentDateInput" onchange="changeDate()" class="p-2 border border-blue-300 rounded-lg text-lg font-bold text-gray-700 outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ±Ø¯ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
                <div id="shiftSelectorContainer" class="flex flex-col gap-1 hidden">
                    <label class="text-xs font-bold text-blue-800" data-i18n="lbl_shift">Ø§Ù„ÙˆØ±Ø¯ÙŠØ©:</label>
                    <select id="shiftFilter" onchange="applyShiftFilter()" class="p-2 border border-blue-300 rounded-lg font-bold text-gray-700 outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                        <option value="all" data-i18n="val_all_shifts">Ø§Ù„ÙƒÙ„</option>
                        <option value="shift_A" data-i18n="val_shift_a">Ø§Ù„ÙˆØ±Ø¯ÙŠØ© A</option>
                        <option value="shift_B" data-i18n="val_shift_b">Ø§Ù„ÙˆØ±Ø¯ÙŠØ© B</option>
                    </select>
                </div>
            </div>

            <div id="dayInfo" class="text-center hidden md:block">
                <span id="dayNameDisplay" class="text-xl font-bold text-blue-900 block">--</span>
                <span id="dateDisplay" class="text-sm text-blue-600">--</span>
            </div>

            <div id="adminControls" class="flex gap-2">
                <button onclick="openAddEmployeeModal()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded shadow text-sm transition flex items-center gap-1">
                    <span data-i18n="new_employee">+ Ù…ÙˆØ¸Ù</span>
                </button>
            </div>
        </div>

        <div id="employeeStatsCard" class="hidden mb-4 bg-white border-r-4 ltr:border-r-0 ltr:border-l-4 border-indigo-500 shadow-lg p-5 rounded-lg fade-in-down border border-gray-100"></div>

        <div class="table-container border bg-white relative flex-grow">
            <table class="w-full text-start border-collapse md:min-w-[1000px]">
                <thead>
                    <tr>
                        <th class="p-3 w-12 bg-blue-900 text-center">#</th>
                        <th class="p-3 w-48 bg-blue-900 text-start" data-i18n="th_name">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                        <th class="p-3 w-32 bg-blue-900 text-center" data-i18n="th_status">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th class="p-3 w-28 bg-blue-900 text-center" data-i18n="th_entry">Ø¯Ø®ÙˆÙ„</th>
                        <th class="p-3 w-28 bg-blue-900 text-center" data-i18n="th_exit">Ø®Ø±ÙˆØ¬</th>
                        <th class="p-3 w-24 bg-blue-900 text-center" data-i18n="th_break">Ø§Ø³ØªØ±Ø§Ø­Ø©</th>
                        <th class="p-3 w-24 bg-blue-900 text-red-200 text-center" data-i18n="th_delay">ØªØ£Ø®ÙŠØ±</th>
                        <th class="p-3 w-24 bg-blue-900 text-center" data-i18n="th_overtime">Ø¥Ø¶Ø§ÙÙŠ</th>
                        <th class="p-3 bg-blue-900 text-center" data-i18n="th_notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                        <th class="p-3 w-16 bg-blue-900 text-center delete-col" data-i18n="th_delete">Ø­Ø°Ù</th>
                    </tr>
                </thead>
                <tbody id="dailyTableBody" class="text-gray-700 text-sm font-medium"></tbody>
            </table>
            <div id="emptyState" class="hidden text-center p-8 text-gray-400" data-i18n="no_data">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ†.</div>
        </div>

        <!-- Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (ØªØµÙ…ÙŠÙ… Mega Icon Card Ø§Ù„ÙØ§ØªØ­) -->
        <div class="mega-icon-card light-mode" data-aos="zoom-in" style="margin-top: 4rem; align-self: center; margin-bottom: 2rem;">
            <span>Developed by EMAD ALLAHAM</span>
            <a href="https://www.facebook.com/emad.allahaam" target="_blank" class="fb-icon-link" title="Visit Facebook Page">
                <i class="fa-brands fa-facebook"></i>
            </a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, writeBatch, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ±Ø¬Ù…Ø© ---
        const translations = {
            ar: {
                app_title: "Ø³Ø¬Ù„ Ø§Ù„ÙˆØ±Ø¯ÙŠØ§Øª",
                login_title: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
                login_btn: "Ø¯Ø®ÙˆÙ„",
                status_online: "Ù…ØªØµÙ„ ÙˆØ¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„",
                status_offline: "ØºÙŠØ± Ù…ØªØµÙ„",
                reports_title: "Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±",
                logout: "Ø®Ø±ÙˆØ¬",
                shift_date: "ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ±Ø¯ÙŠØ©:",
                new_employee: "+ Ù…ÙˆØ¸Ù",
                viewer_mode: "ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©",
                add_emp_title: "Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¸Ù",
                save: "Ø­ÙØ¸",
                cancel: "Ø¥Ù„ØºØ§Ø¡",
                monthly_report: "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ",
                annual_report: "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù†ÙˆÙŠ",
                btn_monthly_report: "Ø´Ù‡Ø±ÙŠ",
                btn_annual_report: "Ø³Ù†ÙˆÙŠ",
                lbl_year: "Ø§Ù„Ø³Ù†Ø©",
                lbl_month: "Ø§Ù„Ø´Ù‡Ø±",
                close: "Ø¥ØºÙ„Ø§Ù‚",
                export_excel: "ØªØµØ¯ÙŠØ± Excel",
                th_name: "Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù",
                th_status: "Ø§Ù„Ø­Ø§Ù„Ø©",
                th_entry: "Ø¯Ø®ÙˆÙ„",
                th_exit: "Ø®Ø±ÙˆØ¬",
                th_break: "Ø§Ø³ØªØ±Ø§Ø­Ø©",
                th_delay: "ØªØ£Ø®ÙŠØ±",
                th_overtime: "Ø¥Ø¶Ø§ÙÙŠ",
                th_notes: "Ù…Ù„Ø§Ø­Ø¸Ø§Øª",
                th_delete: "Ø­Ø°Ù",
                no_data: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ†.",
                val_present: "Ø­Ø¶ÙˆØ±", val_absent: "ØºÙŠØ§Ø¨", val_vacation: "Ø¥Ø¬Ø§Ø²Ø©", val_holiday: "Ø¹Ø·Ù„Ø©", val_choose: "--",
                th_present: "Ø­Ø¶ÙˆØ±", th_absent: "ØºÙŠØ§Ø¨", th_vacation: "Ø¥Ø¬Ø§Ø²Ø©", th_holiday: "Ø¹Ø·Ù„Ø©", th_total_overtime: "Ø³.Ø¥Ø¶Ø§ÙÙŠ", th_total_delay: "Ø³.ØªØ£Ø®ÙŠØ±",
                sum_title: "Ù…Ù„Ø®Øµ", sum_emp: "Ù„Ù€", sum_days: "ÙŠÙˆÙ…", sum_hrs: "Ø³",
                day_sunday: "Ø§Ù„Ø£Ø­Ø¯", day_monday: "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", day_tuesday: "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", day_wednesday: "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", day_thursday: "Ø§Ù„Ø®Ù…ÙŠØ³", day_friday: "Ø§Ù„Ø¬Ù…Ø¹Ø©", day_saturday: "Ø§Ù„Ø³Ø¨Øª",
                lbl_shift: "Ø§Ù„ÙˆØ±Ø¯ÙŠØ©", val_all_shifts: "Ø§Ù„ÙƒÙ„",
                val_shift_a: "Ø§Ù„ÙˆØ±Ø¯ÙŠØ© A", val_shift_b: "Ø§Ù„ÙˆØ±Ø¯ÙŠØ© B",
                role_admin: "Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…: 56401", role_shift_b_man: "Ù…Ø¯ÙŠØ± Ø§Ù„ÙˆØ±Ø¯ÙŠØ© B ÙÙ‚Ø·: 2222", role_accountant: "Ø§Ù„Ù…Ø­Ø§Ø³Ø¨: 3838",
                data_btn: "Ø¨ÙŠØ§Ù†Ø§Øª", data_management: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
                legacy_import_title: "ğŸ“¥ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… (V2)",
                legacy_import_desc: "Ø§Ø¶ØºØ· Ù‡Ù†Ø§ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ù…Ù† Ù…Ù„ÙØ§Øª Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø§Ø¶ÙŠØ©.",
                btn_import_legacy: "Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø³Ø¬Ù„Ø§Øª",
                btn_backup_download: "ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (JSON)",
                btn_restore_upload: "Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø© Ù…Ø­ÙÙˆØ¸Ø©",
                loading_processing: "Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...",
                msg_wrong_code: "Ø±Ù…Ø² Ø®Ø§Ø·Ø¦",
                msg_confirm_delete: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ",
                msg_confirm_restore: "ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø³ØªØ³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ",
                msg_restore_success: "ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.",
                msg_file_error: "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ù„Ù: ",
                msg_import_confirm: "Ø³ÙŠØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… (2026) Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯. Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¯ ØªØ£Ø®Ø° Ø«ÙˆØ§Ù†Ù. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ",
                msg_no_legacy_data: "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù….",
                msg_import_success: "ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ø¬Ø¯Ø¯ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!",
                loading_importing: "Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...",
                loading_backup: "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©...",
                loading_restoring: "Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...",
                badge_shift_b: "Ø§Ù„ÙˆØ±Ø¯ÙŠØ© B",
                ph_employee_name: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ"
            },
            tr: {
                app_title: "Vardiya Sistemi",
                login_title: "GiriÅŸ",
                login_btn: "GiriÅŸ",
                status_online: "BaÄŸlÄ± ve HazÄ±r",
                status_offline: "BaÄŸlantÄ± Yok",
                reports_title: "Raporlar",
                logout: "Ã‡Ä±kÄ±ÅŸ",
                shift_date: "Tarih:",
                new_employee: "+ Personel",
                viewer_mode: "Ä°zleme",
                add_emp_title: "Personel Ekle/DÃ¼zenle",
                save: "Kaydet",
                cancel: "Ä°ptal",
                monthly_report: "AylÄ±k Rapor",
                annual_report: "YÄ±llÄ±k Rapor",
                btn_monthly_report: "AylÄ±k",
                btn_annual_report: "YÄ±llÄ±k",
                lbl_year: "YÄ±l",
                lbl_month: "Ay",
                close: "Kapat",
                export_excel: "Excel",
                th_name: "Personel",
                th_status: "Durum",
                th_entry: "GiriÅŸ",
                th_exit: "Ã‡Ä±kÄ±ÅŸ",
                th_break: "Mola",
                th_delay: "Gecikme",
                th_overtime: "Mesai",
                th_notes: "Not",
                th_delete: "Sil",
                no_data: "KayÄ±t yok.",
                val_present: "Mevcut", val_absent: "Yok", val_vacation: "Ä°zinli", val_holiday: "Tatil", val_choose: "--",
                th_present: "Geldi", th_absent: "Gelmedi", th_vacation: "Ä°zin", th_holiday: "Tatil", th_total_overtime: "Mesai", th_total_delay: "Gecikme",
                sum_title: "Ã–zet", sum_emp: "Personel:", sum_days: "GÃ¼n", sum_hrs: "S",
                day_sunday: "Pazar", day_monday: "Pazartesi", day_tuesday: "SalÄ±", day_wednesday: "Ã‡arÅŸamba", day_thursday: "PerÅŸembe", day_friday: "Cuma", day_saturday: "Cumartesi",
                lbl_shift: "Vardiya", val_all_shifts: "TÃ¼mÃ¼",
                val_shift_a: "Vardiya A", val_shift_b: "Vardiya B",
                role_admin: "Genel MÃ¼dÃ¼r: 56401", role_shift_b_man: "Sadece B Vardiya MÃ¼dÃ¼rÃ¼: 2222", role_accountant: "Muhasebeci: 3838",
                data_btn: "Veri", data_management: "Veri YÃ¶netimi",
                legacy_import_title: "ğŸ“¥ Eski Sistemden GeÃ§iÅŸ (V2)",
                legacy_import_desc: "Bu butonu sadece geÃ§en yÄ±lÄ±n dosyalarÄ±ndan personel ve devam verilerini getirmek istiyorsanÄ±z kullanÄ±n.",
                btn_import_legacy: "Personel ve KayÄ±tlarÄ± Ä°Ã§e Aktar",
                btn_backup_download: "Yedek Ä°ndir (JSON)",
                btn_restore_upload: "YedeÄŸi Geri YÃ¼kle",
                loading_processing: "Veriler iÅŸleniyor...",
                msg_wrong_code: "HatalÄ± Kod",
                msg_confirm_delete: "Bu personeli kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?",
                msg_confirm_restore: "UyarÄ±: Bu iÅŸlem mevcut verileri dosyadaki verilerle deÄŸiÅŸtirecektir. Emin misiniz?",
                msg_restore_success: "Geri yÃ¼kleme baÅŸarÄ±lÄ±! Sayfa yenilenecek.",
                msg_file_error: "Dosya hatasÄ±: ",
                msg_import_confirm: "Ä°simler ve devam kayÄ±tlarÄ± eski sistemden (2026) yeni sisteme aktarÄ±lacak. Ä°ÅŸlem birkaÃ§ saniye sÃ¼rebilir. Emin misiniz?",
                msg_no_legacy_data: "Bu yÄ±l iÃ§in eski sistemde veri bulunamadÄ±.",
                msg_import_success: "Yeni personeller iÃ§e aktarÄ±ldÄ± ve kayÄ±tlar baÅŸarÄ±yla gÃ¼ncellendi!",
                loading_importing: "Ä°simler ve veriler iÃ§e aktarÄ±lÄ±yor...",
                loading_backup: "Yedek hazÄ±rlanÄ±yor...",
                loading_restoring: "Veriler geri yÃ¼kleniyor...",
                badge_shift_b: "Vardiya B",
                ph_employee_name: "Ad Soyad"
            }
        };

        // ØªØ­Ø¯ÙŠØ¯ Ù„ØºØ© Ø§Ù„Ù…ØªØµÙØ­: Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©ØŒ ÙˆØ§Ù„ØªØ±ÙƒÙŠØ© Ù„Ù„ØªØ±ÙƒÙŠØ© Ø£Ùˆ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø£Ùˆ ØºÙŠØ±Ù‡Ø§
        const browserLang = navigator.language || navigator.userLanguage || 'ar';
        let currentLang = browserLang.startsWith('ar') ? 'ar' : 'tr';

        function t(key) { return translations[currentLang][key] || key; }
        
        window.changeLanguage = function(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            
            const btnAr = document.getElementById('btn-ar');
            const btnTr = document.getElementById('btn-tr');
            
            if (lang === 'ar') { 
                btnAr.classList.add('lang-active');
                btnTr.classList.remove('lang-active');
            } else { 
                btnTr.classList.add('lang-active');
                btnAr.classList.remove('lang-active');
            }
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) el.innerText = translations[lang][key];
            });

            // Handle placeholders
            document.querySelectorAll('[data-i18n-ph]').forEach(el => {
                const key = el.getAttribute('data-i18n-ph');
                if (translations[lang][key]) el.placeholder = translations[lang][key];
            });

            renderDailyTable();
        };

        // --- ØªÙ‡ÙŠØ¦Ø© Firebase ---
        let firebaseConfig;
        let appId = 'cloud-shift-register';
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            if(typeof __app_id !== 'undefined' && __app_id) appId = __app_id;
        } else {
             // Fallback for preview if needed, normally this would be your hardcoded keys
            firebaseConfig = {
                apiKey: "AIzaSyDzRczKA0tVr57TVFmnrr3F57REDTF4xHQ",
                authDomain: "cloud-shift-register.firebaseapp.com",
                projectId: "cloud-shift-register",
                storageBucket: "cloud-shift-register.firebasestorage.app",
                messagingSenderId: "823312208352",
                appId: "1:823312208352:web:fc0889a737e58482ce1b85"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (State) ---
        let userRole = ''; // 'admin', 'shift_b_manager', 'viewer'
        let currentUserShift = 'all'; // 'all', 'shift_b'
        let currentSelectedShift = 'all'; // Ù„Ù„ÙÙ„ØªØ±Ø© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        
        let masterEmployees = {}; // { "id1": {name: "Ali", shift: "shift_A"}, ... }
        let currentMonthData = {}; // { "id1": { "2026-01-01": { status: ... } } }
        let loadedYearMonth = ''; 

        // Ù…Ø³Ø§Ø±Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (V3 Structure)
        // Public Data: /artifacts/{appId}/public/data/...
        const EMPLOYEES_DOC = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'employees');
        const getMonthDoc = (year, month) => doc(db, 'artifacts', appId, 'public', 'data', 'months', `data_${year}_${month}`);
        // Ù…Ø³Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ (Legacy)
        const getLegacyYearDoc = (year) => doc(db, 'attendance_data', firebaseConfig.projectId === 'YOUR_PROJECT_ID' ? 'demo-app' : firebaseConfig.projectId, 'years', `data_${year}`);

        // --- Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ---
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                document.getElementById('loadingText').innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: " + error.message;
            }
        }
        initAuth();

        // --- Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ---
        function updateOnlineStatus() {
            const isOnline = navigator.onLine;
            const dot = document.getElementById('connectionDot');
            const text = document.getElementById('connectionText');
            
            if (isOnline) {
                dot.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
                text.className = "text-green-600 text-xs font-bold";
                text.innerText = t('status_online');
                text.setAttribute('data-i18n', 'status_online');
            } else {
                dot.className = "w-2 h-2 rounded-full bg-red-500";
                text.className = "text-red-600 text-xs font-bold";
                text.innerText = t('status_offline');
                text.setAttribute('data-i18n', 'status_offline');
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // Initial check
        updateOnlineStatus();

        // --- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
        window.checkLogin = function() {
            const code = document.getElementById('accessCode').value;
            const errorMsg = document.getElementById('loginError');
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            document.getElementById('shiftSelectorContainer').classList.add('hidden');
            document.getElementById('dataBtn').classList.add('hidden');
            document.getElementById('shiftBadge').classList.add('hidden');
            
            if (code === '56401') {
                userRole = 'admin';
                currentUserShift = 'all';
                document.getElementById('shiftSelectorContainer').classList.remove('hidden'); // ÙŠØ±Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ±Ø¯ÙŠØ§Øª
                document.getElementById('dataBtn').classList.remove('hidden'); // ÙŠØ±Ù‰ Ø²Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            } else if (code === '2222') {
                userRole = 'shift_b_manager';
                currentUserShift = 'shift_B';
                document.getElementById('shiftBadge').classList.remove('hidden');
                document.getElementById('shiftBadge').innerText = t('badge_shift_b'); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ±Ø¬Ù…Ø©
            } else if (code === '3838') {
                userRole = 'viewer';
                currentUserShift = 'all';
                setupViewerUI();
                // Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ ÙŠØ±Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„ÙˆØ±Ø¯ÙŠØ§Øª Ø§Ù„Ø¢Ù†
                document.getElementById('shiftSelectorContainer').classList.remove('hidden'); 
            } else {
                errorMsg.classList.remove('hidden');
                return;
            }

            // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            document.getElementById('loadingScreen').classList.remove('hidden');
            
            // 1. ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Ø§Ù„Ø£Ø³Ø§Ø³)
            const unsubEmp = onSnapshot(EMPLOYEES_DOC, (snap) => {
                if (snap.exists()) {
                    masterEmployees = snap.data().list || {};
                } else {
                    masterEmployees = {};
                }
                renderDailyTable();
            });

            // 2. ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
            const today = new Date();
            const dateInput = document.getElementById('currentDateInput');
            dateInput.value = today.toISOString().split('T')[0];
            
            changeDate(); // Ø³ÙŠÙ‚ÙˆÙ… Ø¨ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø± ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ù„ÙˆØ¯Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡

            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
        };

        function setupViewerUI() {
            document.getElementById('adminControls').innerHTML = 
                `<div class="bg-orange-100 text-orange-800 px-3 py-2 rounded border border-orange-200 font-bold text-sm">${t('viewer_mode')}</div>`;
            const style = document.createElement('style');
            style.innerHTML = '.delete-col { display: none; }'; // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø­Ø°Ù
            document.head.appendChild(style);
        }

        window.logout = function() { location.reload(); };

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© ---
        let unsubscribeMonth = null;

        window.changeDate = function() {
            const dateStr = document.getElementById('currentDateInput').value;
            if(!dateStr) return;
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙŠÙˆÙ…
            const dateObj = new Date(dateStr);
            const daysKey = ['day_sunday', 'day_monday', 'day_tuesday', 'day_wednesday', 'day_thursday', 'day_friday', 'day_saturday'];
            document.getElementById('dayNameDisplay').innerText = t(daysKey[dateObj.getDay()]);
            document.getElementById('dateDisplay').innerText = dateStr;

            const year = dateStr.split('-')[0];
            const month = dateStr.split('-')[1];
            const yearMonth = `${year}_${month}`;

            // ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø´Ù‡Ø± Ø¥Ø°Ø§ ØªØºÙŠØ±
            if (loadedYearMonth !== yearMonth) {
                loadMonthData(year, month);
            } else {
                renderDailyTable();
            }
        };

        function loadMonthData(year, month) {
            if (unsubscribeMonth) unsubscribeMonth();
            
            document.getElementById('loadingText').innerText = t('loading_processing');
            document.getElementById('loadingScreen').classList.remove('hidden');
            loadedYearMonth = `${year}_${month}`;
            
            const monthDocRef = getMonthDoc(year, month);
            
            unsubscribeMonth = onSnapshot(monthDocRef, (snap) => {
                document.getElementById('loadingScreen').classList.add('hidden');
                if (snap.exists()) {
                    currentMonthData = snap.data().records || {};
                } else {
                    currentMonthData = {};
                }
                renderDailyTable();
            });
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ÙˆØ±Ø¯ÙŠØ§Øª ---
        window.applyShiftFilter = function() {
            currentSelectedShift = document.getElementById('shiftFilter').value;
            renderDailyTable();
        };

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª (Ø¬Ø¯ÙŠØ¯) ---
        let dragSrcEl = null;

        window.handleDragStart = function(e) {
            if (userRole !== 'admin') return;
            this.classList.add('dragging');
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.getAttribute('data-emp-id'));
        };

        window.handleDragOver = function(e) {
            if (e.preventDefault) e.preventDefault();
            if (userRole !== 'admin') return;
            this.classList.add('drag-over');
            e.dataTransfer.dropEffect = 'move';
            return false;
        };

        window.handleDragLeave = function(e) {
            this.classList.remove('drag-over');
        };

        window.handleDrop = function(e) {
            if (e.stopPropagation) e.stopPropagation();
            if (dragSrcEl === this || userRole !== 'admin') return;

            this.classList.remove('drag-over');
            dragSrcEl.classList.remove('dragging');

            const sourceId = e.dataTransfer.getData('text/plain');
            const targetId = this.getAttribute('data-emp-id');
            
            // Reorder Logic
            reorderEmployees(sourceId, targetId);

            return false;
        };

        async function reorderEmployees(sourceId, targetId) {
            // ØªØ­ÙˆÙŠÙ„ Map Ø¥Ù„Ù‰ Array Ù„Ù„ØªØ±ØªÙŠØ¨
            let empArray = Object.entries(masterEmployees).map(([id, data]) => ({
                id: id,
                ...data,
                order: data.order || 9999
            })).sort((a, b) => (a.order || 0) - (b.order || 0) || a.name.localeCompare(b.name));

            const sourceIndex = empArray.findIndex(e => e.id === sourceId);
            const targetIndex = empArray.findIndex(e => e.id === targetId);

            if (sourceIndex > -1 && targetIndex > -1) {
                // Move item in array
                const [movedItem] = empArray.splice(sourceIndex, 1);
                empArray.splice(targetIndex, 0, movedItem);

                // Re-assign order numbers
                const updates = {};
                empArray.forEach((emp, index) => {
                    const newOrder = index + 1;
                    masterEmployees[emp.id].order = newOrder; // Update local state immediately
                    updates[`list.${emp.id}.order`] = newOrder;
                });

                renderDailyTable(); // Re-render immediately for responsiveness
                
                // Save to cloud
                try {
                    await updateDoc(EMPLOYEES_DOC, updates);
                } catch (e) {
                    console.error("Order save failed", e);
                }
            }
        }

        // --- Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Core UI Logic) ---
        window.renderDailyTable = function() {
            const tbody = document.getElementById('dailyTableBody');
            tbody.innerHTML = '';
            
            const dateStr = document.getElementById('currentDateInput').value;
            if (!dateStr) return;

            // 1. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Map) Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ù„Ù„ÙØ±Ø²
            let empArray = Object.entries(masterEmployees).map(([id, data]) => ({
                id: id,
                name: data.name,
                shift: data.shift || 'shift_A', // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ A
                order: data.order || 9999
            }));

            // 2. Ø§Ù„ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙˆØ±Ø¯ÙŠØ©
            if (userRole === 'shift_b_manager') {
                empArray = empArray.filter(e => e.shift === 'shift_B');
            } else if ((userRole === 'admin' || userRole === 'viewer') && currentSelectedShift !== 'all') {
                empArray = empArray.filter(e => e.shift === currentSelectedShift);
            }

            // 3. Ø§Ù„ØªØ±ØªÙŠØ¨: Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø¹Ù„Ù‰ OrderØŒ ÙˆØ§Ù„Ø«Ø§Ù†ÙˆÙŠ Ø£Ø¨Ø¬Ø¯ÙŠ
            empArray.sort((a, b) => (a.order || 0) - (b.order || 0) || a.name.localeCompare(b.name));

            if (empArray.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }
            document.getElementById('emptyState').classList.add('hidden');

            // 4. Ø±Ø³Ù… Ø§Ù„ØµÙÙˆÙ
            empArray.forEach((emp, index) => {
                const empId = emp.id;
                const empName = emp.name;
                
                // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… Ù…Ù† Ù…Ù„Ù Ø§Ù„Ø´Ù‡Ø±
                const empMonthRecord = currentMonthData[empId] || {};
                const dayData = empMonthRecord[dateStr] || { status: '', entry: '', exit: '', breakDuration: '0', shortage: '', overtime: '', notes: '' };

                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 border-b transition duration-150";
                
                // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù„Ù„Ù…Ø¯ÙŠØ±
                if (userRole === 'admin') {
                    tr.setAttribute('draggable', 'true');
                    tr.classList.add('draggable-row');
                    tr.setAttribute('data-emp-id', empId);
                    tr.addEventListener('dragstart', handleDragStart);
                    tr.addEventListener('dragover', handleDragOver);
                    tr.addEventListener('dragleave', handleDragLeave);
                    tr.addEventListener('drop', handleDrop);
                }

                // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
                if(dayData.status === 'absent') tr.classList.add('bg-red-50');
                if(dayData.status === 'vacation') tr.classList.add('bg-yellow-50');
                if(dayData.status === 'present') tr.classList.add('bg-green-50');
                if(dayData.status === 'holiday') tr.classList.add('status-holiday');

                // ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø­Ù‚ÙˆÙ„
                const isViewer = userRole === 'viewer';
                const isInputsFrozen = !dayData.status || (dayData.status !== 'present' && dayData.status !== 'holiday');
                const inputsDisabled = isInputsFrozen || isViewer ? 'disabled' : '';
                const isDisabled = isViewer ? 'disabled' : '';

                // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³Ø­Ø¨
                const dragIcon = userRole === 'admin' ? '<span class="drag-handle" title="Ø§Ø³Ø­Ø¨ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨">â˜°</span>' : '';

                tr.innerHTML = `
                    <td class="p-3 text-center text-gray-500 flex justify-center items-center" data-label="#" data-label-type="index">
                        ${index + 1} ${dragIcon}
                    </td>
                    <td class="p-3 font-bold text-gray-800 cursor-pointer hover:bg-blue-50 transition-colors select-none group" 
                        onclick="showEmployeeSummary('${empId}')" 
                        data-label="${t('th_name')}" data-label-type="name">
                        <div class="flex items-center justify-between">
                            <span class="hover:text-blue-600">${empName}</span>
                            ${userRole === 'admin' ? `
                            <button onclick="event.stopPropagation(); openEditEmployeeModal('${empId}')" class="text-gray-400 hover:text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity px-1 text-lg" title="ØªØ¹Ø¯ÙŠÙ„">
                                âœ
                            </button>
                            ` : ''}
                        </div>
                    </td>
                    
                    <td class="p-3" data-label="${t('th_status')}">
                        <select onchange="saveData('${empId}', '${dateStr}', 'status', this.value)" ${isDisabled}
                                class="w-full p-2 border rounded bg-white text-sm focus:ring-2 focus:ring-blue-400 outline-none cursor-pointer">
                            <option value="">${t('val_choose')}</option>
                            <option value="present" ${dayData.status === 'present' ? 'selected' : ''}>${t('val_present')}</option>
                            <option value="absent" ${dayData.status === 'absent' ? 'selected' : ''}>${t('val_absent')}</option>
                            <option value="vacation" ${dayData.status === 'vacation' ? 'selected' : ''}>${t('val_vacation')}</option>
                            <option value="holiday" ${dayData.status === 'holiday' ? 'selected' : ''}>${t('val_holiday')}</option>
                        </select>
                    </td>

                    <td class="p-3" data-label="${t('th_entry')}">
                        <input type="text" value="${dayData.entry || ''}" placeholder="--:--" onchange="handleSmartTimeInput(this, '${empId}', '${dateStr}', 'entry')" ${inputsDisabled} class="w-full p-2 border rounded bg-white text-sm text-center ltr placeholder-gray-300">
                    </td>
                    <td class="p-3" data-label="${t('th_exit')}">
                        <input type="text" value="${dayData.exit || ''}" placeholder="--:--" onchange="handleSmartTimeInput(this, '${empId}', '${dateStr}', 'exit')" ${inputsDisabled} class="w-full p-2 border rounded bg-white text-sm text-center ltr placeholder-gray-300">
                    </td>
                    <td class="p-3" data-label="${t('th_break')}">
                        <input type="number" step="0.5" min="0" value="${dayData.breakDuration || '0'}" onchange="saveData('${empId}', '${dateStr}', 'breakDuration', this.value)" ${inputsDisabled} class="w-full p-2 border rounded bg-white text-sm text-center">
                    </td>
                    <td class="p-3" data-label="${t('th_delay')}">
                        <input type="number" step="0.5" max="0" value="${dayData.shortage || ''}" onchange="if(this.value > 0) this.value = -this.value; saveData('${empId}', '${dateStr}', 'shortage', this.value)" ${inputsDisabled} class="w-full p-2 border rounded bg-white text-sm text-center text-red-600 placeholder-red-300" placeholder="-">
                    </td>
                    <td class="p-3" data-label="${t('th_overtime')}">
                        <input type="number" step="0.5" value="${dayData.overtime || ''}" onchange="saveData('${empId}', '${dateStr}', 'overtime', this.value)" ${inputsDisabled} class="w-full p-2 border rounded bg-white text-sm text-center" placeholder="0">
                    </td>
                    <td class="p-3" data-label="${t('th_notes')}">
                        <input type="text" value="${dayData.notes || ''}" onchange="saveData('${empId}', '${dateStr}', 'notes', this.value)" ${isDisabled} class="w-full p-2 border rounded bg-white text-sm" placeholder="...">
                    </td>
                    
                    ${userRole === 'admin' ? 
                    `<td class="p-3 text-center delete-col" data-label="${t('th_delete')}"><button onclick="deleteEmployee('${empId}')" class="text-red-400 hover:text-red-700 font-bold px-2">Ã—</button></td>` 
                    : '<td class="p-3"></td>'}
                `;
                tbody.appendChild(tr);
            });
        };

        // --- Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Transactions) ---
        window.saveData = async function(empId, date, field, value) {
            if (userRole === 'viewer') return;
            const year = date.split('-')[0];
            const month = date.split('-')[1];
            
            // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ Ø³Ø±ÙŠØ¹ (Optimistic UI)
            if (!currentMonthData[empId]) currentMonthData[empId] = {};
            if (!currentMonthData[empId][date]) currentMonthData[empId][date] = {};
            currentMonthData[empId][date][field] = value;

            // Ù…Ù†Ø·Ù‚ Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠ
            const record = currentMonthData[empId][date];
            if (field === 'status') {
                if (value === 'absent' || value === 'vacation') {
                    record.entry = ''; record.exit = ''; record.breakDuration = '0'; record.shortage = ''; record.overtime = '';
                }
                if (value === 'present') {
                    record.breakDuration = '0.5';
                }
            }

            const updatePath = `records.${empId}.${date}`;
            const updates = {};
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­
            updates[`records.${empId}.${date}.${field}`] = value;
            if (field === 'status' && (value === 'absent' || value === 'vacation')) {
                updates[`records.${empId}.${date}.entry`] = '';
                updates[`records.${empId}.${date}.exit`] = '';
                updates[`records.${empId}.${date}.breakDuration`] = '0';
                updates[`records.${empId}.${date}.shortage`] = '';
                updates[`records.${empId}.${date}.overtime`] = '';
            }
            if (field === 'status' && value === 'present') {
                updates[`records.${empId}.${date}.breakDuration`] = '0.5';
            }
            // Ø¥Ø°Ø§ Ø£Ø¯Ø®Ù„ ÙˆÙ‚Øª Ø¯Ø®ÙˆÙ„/Ø®Ø±ÙˆØ¬ Ø¨Ø¯ÙˆÙ† Ø­Ø§Ù„Ø©ØŒ Ø­ÙˆÙ‘Ù„Ù‡Ø§ Ù„Ø­Ø¶ÙˆØ±
            if ((field === 'entry' || field === 'exit') && value && !record.status) {
                updates[`records.${empId}.${date}.status`] = 'present';
            }

            try {
                const docRef = getMonthDoc(year, month);
                await updateDoc(docRef, updates);
            } catch (e) {
                // Ø¥Ø°Ø§ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (Ø£ÙˆÙ„ Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ø´Ù‡Ø±)ØŒ Ù†Ø³ØªØ®Ø¯Ù… setDoc Ù…Ø¹ merge
                const docRef = getMonthDoc(year, month);
                // ÙŠØ¬Ø¨ Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒØ§Ø¦Ù† Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù€ setDoc
                const deepObj = { records: { [empId]: { [date]: record } } };
                await setDoc(docRef, deepObj, { merge: true });
            }
        };

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (CRUD) ---
        window.openAddEmployeeModal = function() {
            document.getElementById('empModalTitle').innerText = t('add_emp_title');
            document.getElementById('editEmployeeId').value = '';
            document.getElementById('newEmployeeName').value = '';
            
            const shiftSelect = document.getElementById('newEmployeeShift');
            if (userRole === 'shift_b_manager') {
                shiftSelect.value = 'shift_B';
                shiftSelect.disabled = true;
            } else {
                shiftSelect.value = 'shift_A';
                shiftSelect.disabled = false;
            }
            
            toggleModal('addEmployeeOverlay', true);
        };

        window.openEditEmployeeModal = function(empId) {
            const emp = masterEmployees[empId];
            if(!emp) return;
            document.getElementById('empModalTitle').innerText = t('add_emp_title');
            document.getElementById('editEmployeeId').value = empId;
            document.getElementById('newEmployeeName').value = emp.name;
            
            const shiftSelect = document.getElementById('newEmployeeShift');
            shiftSelect.value = emp.shift || 'shift_A';
            
            if (userRole === 'shift_b_manager') {
                shiftSelect.disabled = true;
            } else {
                shiftSelect.disabled = false;
            }

            toggleModal('addEmployeeOverlay', true);
        };

        window.saveEmployeeToMasterList = async function() {
            const id = document.getElementById('editEmployeeId').value;
            const name = document.getElementById('newEmployeeName').value.trim();
            const shift = document.getElementById('newEmployeeShift').value;

            if (!name) return;

            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            let newOrder = 9999;
            if (!id) { // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯
                 const orders = Object.values(masterEmployees).map(e => e.order || 0);
                 const maxOrder = Math.max(...orders, 0);
                 newOrder = maxOrder + 1;
            }

            const updates = {};
            if (id) {
                // ØªØ¹Ø¯ÙŠÙ„
                updates[`list.${id}.name`] = name;
                updates[`list.${id}.shift`] = shift;
            } else {
                // Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯ (Generate ID)
                const newId = 'emp_' + Date.now();
                updates[`list.${newId}`] = { name: name, shift: shift, order: newOrder };
            }

            try {
                await updateDoc(EMPLOYEES_DOC, updates);
            } catch (e) {
                // Ø¥Ø°Ø§ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
                const deepObj = { list: {} };
                const newId = id || 'emp_' + Date.now();
                deepObj.list[newId] = { name: name, shift: shift, order: newOrder };
                await setDoc(EMPLOYEES_DOC, deepObj, { merge: true });
            }
            toggleModal('addEmployeeOverlay', false);
        };

        window.deleteEmployee = async function(empId) {
            if (!confirm(t('msg_confirm_delete'))) return;
            const newMap = { ...masterEmployees };
            delete newMap[empId];
            await setDoc(EMPLOYEES_DOC, { list: newMap });
        };

        // --- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ (Advanced Logic) ---
        
        // 1. Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰ (Ù…Ø­Ø¯Ø« Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙŠØ¶Ø§Ù‹)
        window.importLegacyEmployees = async function() {
            if(!confirm(t('msg_import_confirm'))) return;
            
            document.getElementById('loadingText').innerText = t('loading_importing');
            document.getElementById('loadingScreen').classList.remove('hidden');

            const currentYear = new Date().getFullYear(); // 2026

            try {
                // 1. Fetch Legacy Data
                const legacyDocRef = getLegacyYearDoc(currentYear);
                const snap = await getDoc(legacyDocRef);
                
                if (!snap.exists()) {
                    alert(t('msg_no_legacy_data'));
                    document.getElementById('loadingScreen').classList.add('hidden');
                    return;
                }

                const legacyData = snap.data();
                const legacyEmployees = legacyData.employees || []; // ["Ahmed", "Ali"]
                const legacyRecords = legacyData.records || {}; // { "Ahmed": { "2026-01-01": {...} } }

                // 2. Map Legacy Names to New IDs
                const nameToIdMap = {};
                const empUpdates = {};
                let newEmpCount = 0;
                
                // Ø­Ø³Ø§Ø¨ Ø£Ø¹Ù„Ù‰ ØªØ±ØªÙŠØ¨ Ø­Ø§Ù„ÙŠ
                const orders = Object.values(masterEmployees).map(e => e.order || 0);
                let currentMaxOrder = Math.max(...orders, 0);

                // First, check existing master employees
                // masterEmployees = { "emp_123": {name: "Ahmed", ...} }
                Object.entries(masterEmployees).forEach(([id, data]) => {
                    nameToIdMap[data.name] = id;
                });

                // Create IDs for missing employees
                legacyEmployees.forEach(name => {
                    if (!nameToIdMap[name]) {
                        const newId = 'emp_legacy_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
                        nameToIdMap[name] = newId;
                        currentMaxOrder++;
                        empUpdates[`list.${newId}`] = { name: name, shift: 'shift_A', order: currentMaxOrder }; // Default to A
                        newEmpCount++;
                    }
                });

                // Save new employees if any
                if (newEmpCount > 0) {
                     await updateDoc(EMPLOYEES_DOC, empUpdates).catch(async () => {
                         // Fallback if doc doesn't exist
                         const deepObj = { list: {} };
                         Object.keys(empUpdates).forEach(k => {
                             const key = k.split('.')[1];
                             deepObj.list[key] = empUpdates[k];
                         });
                         await setDoc(EMPLOYEES_DOC, deepObj, { merge: true });
                     });
                     // Update local masterEmployees to include new ones immediately for this session
                     Object.keys(empUpdates).forEach(k => {
                         const id = k.split('.')[1];
                         masterEmployees[id] = empUpdates[k];
                     });
                }

                // 3. Process Records and Group by Month
                // Structure: { "01": { records: { "empId": { "2026-01-01": ... } } }, "02": ... }
                const monthlyUpdates = {}; 

                Object.keys(legacyRecords).forEach(empName => {
                    const empId = nameToIdMap[empName];
                    if (!empId) return; // Should not happen

                    const empDates = legacyRecords[empName];
                    Object.keys(empDates).forEach(date => {
                        // date = "2026-01-01"
                        const [y, m, d] = date.split('-');
                        if (y != currentYear) return;

                        if (!monthlyUpdates[m]) monthlyUpdates[m] = {};
                        if (!monthlyUpdates[m][empId]) monthlyUpdates[m][empId] = {};

                        monthlyUpdates[m][empId][date] = empDates[date];
                    });
                });

                // 4. Write to Monthly Docs
                const monthsToUpdate = Object.keys(monthlyUpdates);
                let recordsCount = 0;

                for (const m of monthsToUpdate) {
                    const monthDocRef = getMonthDoc(currentYear, m);
                    // We use setDoc with merge: true to avoid overwriting existing V3 data if any
                    // Structure to write: { records: { empId: { date: data } } }
                    await setDoc(monthDocRef, { records: monthlyUpdates[m] }, { merge: true });
                    recordsCount += Object.keys(monthlyUpdates[m]).length; // Rough count of employees updated in that month
                }

                alert(t('msg_import_success'));
                
                // Refresh view
                changeDate(); 

            } catch (e) {
                console.error(e);
                alert(t('msg_file_error') + e.message);
            } finally {
                document.getElementById('loadingScreen').classList.add('hidden');
                toggleModal('dataManagerOverlay', false);
            }
        };

        // 2. ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (JSON)
        window.exportBackup = async function() {
            document.getElementById('loadingText').innerText = t('loading_backup');
            document.getElementById('loadingScreen').classList.remove('hidden');
            
            const backupData = {
                version: "3.0",
                date: new Date().toISOString(),
                employees: masterEmployees,
                months: {}
            };

            // Loop through months of current year
            const year = new Date().getFullYear();
            for (let m = 1; m <= 12; m++) {
                const mm = String(m).padStart(2, '0');
                try {
                    const snap = await getDoc(getMonthDoc(year, mm));
                    if (snap.exists()) {
                        backupData.months[`${year}_${mm}`] = snap.data();
                    }
                } catch(e) {}
            }

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "backup_shift_register_v3.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();

            document.getElementById('loadingScreen').classList.add('hidden');
        };

        // 3. Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø©
        window.restoreBackup = function(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const content = e.target.result;
                try {
                    const data = JSON.parse(content);
                    if (!data.employees) throw new Error("Invalid File");

                    if (!confirm(t('msg_confirm_restore'))) return;

                    document.getElementById('loadingText').innerText = t('loading_restoring');
                    document.getElementById('loadingScreen').classList.remove('hidden');

                    // 1. Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
                    await setDoc(EMPLOYEES_DOC, { list: data.employees });

                    // 2. Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø´Ù‡ÙˆØ±
                    const batch = writeBatch(db); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Batch Ù„Ù„ÙƒÙØ§Ø¡Ø©
                    let opCount = 0;
                    
                    for (const [key, monthData] of Object.entries(data.months)) {
                        // key is YYYY_MM
                        const [y, m] = key.split('_');
                        const docRef = getMonthDoc(y, m);
                        batch.set(docRef, monthData);
                        opCount++;
                    }
                    
                    if(opCount > 0) await batch.commit();

                    alert(t('msg_restore_success'));
                    location.reload();

                } catch (err) {
                    alert(t('msg_file_error') + err.message);
                    document.getElementById('loadingScreen').classList.add('hidden');
                }
            };
            reader.readAsText(file);
        };

        // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
        window.toggleModal = function(id, show) {
            const el = document.getElementById(id);
            if(show) { 
                el.classList.remove('hidden'); 
                document.body.style.overflow = 'hidden'; 
            } else { 
                el.classList.add('hidden'); 
                document.body.style.overflow = ''; 
            }
        };

        window.handleSmartTimeInput = function(input, empId, dateStr, field) {
            let val = input.value.trim();
            if(!val) { saveData(empId, dateStr, field, ''); return; }
            val = val.replace(/[^0-9:]/g, '');
            if (val.indexOf(':') === -1) {
                if (val.length <= 2) {
                    let hour = parseInt(val);
                    if (hour >= 0 && hour <= 23) val = val.padStart(2, '0') + ":00";
                } else if (val.length === 3) {
                    val = "0" + val.substring(0, 1) + ":" + val.substring(1);
                } else if (val.length === 4) {
                    val = val.substring(0, 2) + ":" + val.substring(2);
                }
            }
            // Validate time format HH:MM
            if (/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(val)) {
                input.value = val;
                saveData(empId, dateStr, field, val);
            }
        };

        // ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¶Ø¨Ø· Ø§Ù„Ø³Ù†Ø© ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
        window.adjustRepYear = function(delta) {
            const input = document.getElementById('repYearInput');
            let val = parseInt(input.value) || new Date().getFullYear();
            input.value = val + delta;
        };

        // --- Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (Ù…Ø­Ø¯Ø«Ø© Ù„Ø¯Ø¹Ù… IDs) ---
        window.openReportModal = function() {
            const today = new Date();
            document.getElementById('repYearInput').value = today.getFullYear();
            document.getElementById('repMonthSelect').value = String(today.getMonth() + 1).padStart(2, '0');
            toggleModal('monthlyReportOverlay', true);
            generateReport('monthly');
        };

        let currentReportType = 'monthly';

        window.generateReport = async function(type) {
            currentReportType = type;
            const year = document.getElementById('repYearInput').value;
            const month = document.getElementById('repMonthSelect').value;
            const tbody = document.getElementById('reportTableBody');
            
            tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4"><div class="loader mx-auto"></div></td></tr>';
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            let reportData = {}; // { empId: { present: 0, ... } }
            
            // ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
            Object.keys(masterEmployees).forEach(id => {
                reportData[id] = { 
                    name: masterEmployees[id].name, 
                    shift: masterEmployees[id].shift,
                    order: masterEmployees[id].order || 9999,
                    present: 0, absent: 0, vacation: 0, holiday: 0, overtime: 0, delay: 0 
                };
            });

            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¬Ù„Ø¨Ù‡Ø§
            let monthsToFetch = [];
            if (type === 'monthly') {
                monthsToFetch.push(month);
            } else {
                monthsToFetch = ['01','02','03','04','05','06','07','08','09','10','11','12'];
            }

            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§
            for (const m of monthsToFetch) {
                // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø¨Ø·ÙŠØ¦Ø§Ù‹ Ù„Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù†ÙˆÙŠØŒ ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ¬Ù…ÙŠØ¹ (Aggregation)
                try {
                    const snap = await getDoc(getMonthDoc(year, m));
                    if (snap.exists()) {
                        const records = snap.data().records || {};
                        Object.keys(records).forEach(empId => {
                            if (!reportData[empId]) return; // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø­Ø°ÙˆÙÙŠÙ† Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                            const days = records[empId];
                            Object.values(days).forEach(day => {
                                if (day.status === 'present') reportData[empId].present++;
                                if (day.status === 'absent') reportData[empId].absent++;
                                if (day.status === 'vacation') reportData[empId].vacation++;
                                if (day.status === 'holiday') reportData[empId].holiday++;
                                reportData[empId].overtime += parseFloat(day.overtime) || 0;
                                reportData[empId].delay += parseFloat(day.shortage) || 0; // Ø§Ù„Ù‚ÙŠÙ… Ù…Ø®Ø²Ù†Ø© Ø¨Ø§Ù„Ø³Ø§Ù„Ø¨ Ù„Ù„ØªØ£Ø®ÙŠØ±ØŒ Ù†Ø¬Ù…Ø¹Ù‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ Ø£Ùˆ Ù†Ø¹ÙƒØ³Ù‡Ø§ Ù„Ù„Ø¹Ø±Ø¶
                            });
                        });
                    }
                } catch(e) {}
            }

            // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            tbody.innerHTML = '';
            document.getElementById('reportTitleDisplay').innerText = 
                type === 'monthly' ? `${t('monthly_report')} (${year}-${month})` : `${t('annual_report')} (${year})`;

            // ÙØ±Ø² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ±ØªÙŠØ¨ ÙˆØ§Ù„Ø§Ø³Ù…
            const sortedReportData = Object.values(reportData).sort((a, b) => {
                return (a.order || 0) - (b.order || 0) || a.name.localeCompare(b.name);
            });

            sortedReportData.forEach(d => {
                // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙˆØ±Ø¯ÙŠØ© Ù„Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† (Ù…Ø­Ø¯Ø«Ø© Ù„ØªØ´Ù…Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©)
                if (userRole === 'shift_b_manager' && d.shift !== 'shift_B') return;
                if ((userRole === 'admin' || userRole === 'viewer') && currentSelectedShift !== 'all' && d.shift !== currentSelectedShift) return;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-3 border font-bold bg-gray-50" data-label="${t('th_name')}" data-label-type="name">${d.name}</td>
                    <td class="p-3 border text-center text-green-700 font-bold" data-label="${t('th_present')}">${d.present}</td>
                    <td class="p-3 border text-center text-red-700 font-bold" data-label="${t('th_absent')}">${d.absent}</td>
                    <td class="p-3 border text-center text-yellow-700 font-bold" data-label="${t('th_vacation')}">${d.vacation}</td>
                    <td class="p-3 border text-center text-purple-700 font-bold" data-label="${t('th_holiday')}">${d.holiday}</td>
                    <td class="p-3 border text-center text-blue-700 font-bold" data-label="${t('th_total_overtime')}">${d.overtime}</td>
                    <td class="p-3 border text-center text-red-600 font-bold" data-label="${t('th_total_delay')}"><span dir="ltr">${Math.abs(d.delay)}</span></td>
                `;
                tbody.appendChild(tr);
            });
        };

        window.exportReportToCSV = function() {
            // Ø¨Ø³ÙŠØ·Ø©: Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ DOM
            const rows = document.querySelectorAll('#reportTableBody tr');
            if (rows.length === 0) return;
            
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += `${t('th_name')},${t('th_present')},${t('th_absent')},${t('th_vacation')},${t('th_holiday')},${t('th_total_overtime')},${t('th_total_delay')}\n`;

            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                const rowData = Array.from(cols).map(c => `"${c.innerText}"`).join(",");
                csvContent += rowData + "\n";
            });

            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        window.showEmployeeSummary = function(empId) {
            const empName = masterEmployees[empId]?.name || 'Unknown';
            const dateStr = document.getElementById('currentDateInput').value;
            const currentMonth = dateStr.slice(0, 7); 
            
            let present = 0, absent = 0, vacation = 0, holiday = 0, totalOvertime = 0, totalShortage = 0;
            const empData = currentMonthData[empId] || {};
            
            Object.values(empData).forEach(d => {
                if (d.status === 'present') present++;
                if (d.status === 'absent') absent++;
                if (d.status === 'vacation') vacation++;
                if (d.status === 'holiday') holiday++; 
                totalOvertime += parseFloat(d.overtime) || 0;
                totalShortage += parseFloat(d.shortage) || 0;
            });
            
            const statsContainer = document.getElementById('employeeStatsCard');
            statsContainer.classList.remove('hidden');
            statsContainer.innerHTML = `
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <h3 class="font-bold text-xl text-blue-900 flex items-center gap-2">
                            <span class="bg-blue-100 p-1 rounded text-blue-600">ğŸ‘¤</span>
                            ${t('sum_title')} ${t('sum_emp')} <span class="text-indigo-600 underline">${empName}</span>
                        </h3>
                    </div>
                    <div class="flex flex-wrap gap-4 text-sm font-bold">
                        <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-2 rounded-lg text-center">
                            <span class="text-xs block text-green-500">${t('th_present')}</span> ${present}
                        </div>
                        <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-2 rounded-lg text-center">
                            <span class="text-xs block text-red-500">${t('th_absent')}</span> ${absent}
                        </div>
                         <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-2 rounded-lg text-center">
                            <span class="text-xs block text-yellow-600">${t('th_vacation')}</span> ${vacation}
                        </div>
                        <div class="bg-blue-50 border border-blue-200 text-blue-800 px-4 py-2 rounded-lg text-center">
                            <span class="text-xs block text-blue-500">${t('th_overtime')}</span> ${totalOvertime}
                        </div>
                        <div class="bg-orange-50 border border-orange-200 text-orange-800 px-4 py-2 rounded-lg text-center">
                            <span class="text-xs block text-orange-500">${t('th_delay')}</span> <span dir="ltr">${Math.abs(totalShortage)}</span>
                        </div>
                    </div>
                    <button onclick="document.getElementById('employeeStatsCard').classList.add('hidden')" class="bg-gray-100 px-3 py-1 rounded">Ã—</button>
                </div>
            `;
            // Ø¥Ø¶Ø§ÙØ© Ø®Ø§ØµÙŠØ© Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø©
            statsContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        };

        // Ù…ÙØªØ§Ø­ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
        document.getElementById('accessCode').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') window.checkLogin();
        });

        // Initialize language
        changeLanguage(currentLang);

    </script>
</body>
</html>
