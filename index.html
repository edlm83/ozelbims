<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cloud Shift Register</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f3f4f6; }
        
        /* تنسيقات الجدول للشاشات الكبيرة */
        .table-container { overflow-x: auto; max-height: 70vh; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        thead th { position: sticky; top: 0; z-index: 10; background-color: #1e3a8a; color: white; }
        
        /* ألوان الحالات */
        .status-present { background-color: #dcfce7; color: #166534; }
        .status-absent { background-color: #fee2e2; color: #991b1b; }
        .status-vacation { background-color: #fef3c7; color: #92400e; }
        
        input:disabled, select:disabled { background-color: #f3f4f6; cursor: not-allowed; color: #9ca3af; border-color: #e5e7eb; }
        .overlay { position: fixed; inset: 0; background: rgba(17, 24, 39, 0.95); z-index: 50; display: flex; justify-content: center; align-items: center; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 40; display: flex; justify-content: center; align-items: center; padding: 1rem; }
        .hidden { display: none !important; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ========================================= */
        /* تنسيقات الجوال (نظام البطاقات) - هام جداً */
        /* ========================================= */
        @media (max-width: 768px) {
            /* إلغاء خصائص الجدول التقليدي */
            .table-container, .overflow-auto { 
                background: transparent; box-shadow: none; overflow: visible !important; max-height: none !important; border: none; 
            }
            
            /* السماح بالسكرول داخل نافذة التقرير فقط */
            #monthlyReportOverlay .overflow-auto {
                overflow-y: auto !important;
                max-height: 65vh !important;
            }

            table, thead, tbody, th, td, tr { display: block; width: 100%; }
            thead { display: none; } /* إخفاء الرأس */
            
            /* البطاقة */
            tr {
                background: white;
                margin-bottom: 1rem;
                border-radius: 1rem;
                box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
                border: 1px solid #e5e7eb;
                overflow: hidden;
            }

            /* خلايا البطاقة */
            td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem;
                border-bottom: 1px solid #f3f4f6;
                text-align: start; /* محاذاة حسب اللغة */
            }
            td:last-child { border-bottom: none; }

            /* العنوان الجانبي (يأخذ القيمة من data-label) */
            td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #6b7280;
                font-size: 0.9rem;
                flex-basis: 40%;
            }

            /* تخصيص اسم الموظف كعنوان */
            td[data-label-type="name"] {
                background: #eff6ff;
                justify-content: center;
                font-weight: 800;
                color: #1e3a8a;
                font-size: 1.1rem;
                border-bottom: 2px solid #bfdbfe;
            }
            td[data-label-type="name"]::before { display: none; }
            td[data-label-type="index"] { display: none; }

            /* تحسين عرض الحقول */
            td input, td select {
                width: 55% !important;
                text-align: center;
                border: 1px solid #d1d5db;
                border-radius: 0.375rem;
                padding: 0.4rem;
            }
            
            /* زر الحذف */
            td.delete-col { justify-content: center; background: #fef2f2; }
            td.delete-col button { width: 100%; color: #dc2626; font-weight: bold; }
            td.delete-col::before { display: none; }
        }
    </style>
</head>
<body class="p-4 md:p-6 text-gray-800">

    <!-- شاشة التحميل -->
    <div id="loadingScreen" class="overlay" style="z-index: 60; background: white;">
        <div class="flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p class="text-gray-600 font-bold" data-i18n="connecting">جاري الاتصال بقاعدة البيانات...</p>
        </div>
    </div>

    <!-- 1. شاشة تسجيل الدخول -->
    <div id="loginOverlay" class="overlay hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center relative">
            
            <!-- أزرار اللغة (سوريا وتركيا) -->
            <div class="absolute top-4 right-4 flex gap-3">
                <button id="btn-tr" onclick="changeLanguage('tr')" class="w-10 h-10 rounded-full overflow-hidden border-4 border-transparent hover:scale-105 transition-all shadow-md" title="Türkçe">
                    <img src="https://flagcdn.com/w40/tr.png" alt="Turkish" class="w-full h-full object-cover">
                </button>
                <button id="btn-ar" onclick="changeLanguage('ar')" class="w-10 h-10 rounded-full overflow-hidden border-4 border-transparent hover:scale-105 transition-all shadow-md" title="العربية">
                    <!-- علم سوريا -->
                    <img src="https://flagcdn.com/w40/sy.png" alt="Arabic" class="w-full h-full object-cover">
                </button>
            </div>

            <h2 class="text-2xl font-bold text-gray-800 mb-2 mt-8" data-i18n="login_title">تسجيل الدخول</h2>
            <p class="text-gray-500 mb-6 text-sm" data-i18n="app_title">نظام إدارة الورديات (أونلاين)</p>
            <input type="password" id="accessCode" class="w-full p-3 border border-gray-300 rounded-lg mb-4 text-center text-lg tracking-widest focus:ring-2 focus:ring-blue-500 outline-none">
            <button onclick="checkLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition mb-4" data-i18n="login_btn">دخول</button>
            <div class="text-xs text-gray-400 bg-gray-50 p-2 rounded border text-start">
                <p><strong data-i18n="admin_role">المدير:</strong> 1111</p>
                <p><strong data-i18n="viewer_role">المحاسب:</strong> 2222</p>
            </div>
            <p id="loginError" class="text-red-500 text-sm mt-2 hidden" data-i18n="wrong_code">رمز خاطئ</p>
        </div>
    </div>

    <!-- 2. نافذة إضافة موظف -->
    <div id="addEmployeeOverlay" class="modal-overlay hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4" data-i18n="add_emp_title">إضافة موظف جديد للوردية</h3>
            <input type="text" id="newEmployeeName" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 outline-none">
            <div class="flex gap-2">
                <button onclick="confirmAddEmployee()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition" data-i18n="save">حفظ</button>
                <button onclick="toggleModal('addEmployeeOverlay', false)" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 rounded-lg transition" data-i18n="cancel">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- 3. نافذة التقرير الشهري/السنوي -->
    <div id="monthlyReportOverlay" class="modal-overlay hidden" style="align-items: flex-start; padding-top: 2rem;">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold text-gray-800" data-i18n="reports_title">التقارير</h3>
                <button onclick="toggleModal('monthlyReportOverlay', false)" class="text-red-500 hover:bg-red-50 px-3 py-1 rounded" data-i18n="close">إغلاق</button>
            </div>
            
            <div class="flex flex-wrap gap-4 p-4 items-center bg-gray-50 border-b justify-between">
                <div class="flex items-center gap-2">
                    <!-- قوائم السنة والشهر مع التحديث التلقائي -->
                    <div class="flex flex-col">
                         <label class="text-xs font-bold text-gray-500" data-i18n="lbl_year">السنة</label>
                         <input type="number" id="repYearInput" onchange="generateReport(currentReportType)" class="p-2 border rounded w-24 text-center font-bold">
                    </div>
                    <div class="flex flex-col">
                        <label class="text-xs font-bold text-gray-500" data-i18n="lbl_month">الشهر</label>
                        <select id="repMonthSelect" onchange="generateReport(currentReportType)" class="p-2 border rounded w-32 font-bold cursor-pointer">
                            <option value="01">01</option> <option value="02">02</option> <option value="03">03</option>
                            <option value="04">04</option> <option value="05">05</option> <option value="06">06</option>
                            <option value="07">07</option> <option value="08">08</option> <option value="09">09</option>
                            <option value="10">10</option> <option value="11">11</option> <option value="12">12</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button onclick="generateReport('monthly')" class="bg-blue-600 text-white px-3 py-2 rounded text-xs md:text-sm hover:bg-blue-700 transition font-bold" data-i18n="btn_monthly_report">شهري</button>
                    <button onclick="generateReport('annual')" class="bg-indigo-600 text-white px-3 py-2 rounded text-xs md:text-sm hover:bg-indigo-700 transition font-bold" data-i18n="btn_annual_report">سنوي</button>
                    <button onclick="exportReportToCSV()" class="bg-green-600 text-white px-3 py-2 rounded text-xs md:text-sm hover:bg-green-700 transition font-bold" data-i18n="export_excel">Excel</button>
                </div>
            </div>

            <div id="reportTitleDisplay" class="text-center font-bold text-lg text-blue-900 py-2 bg-blue-50/50"></div>

            <div class="flex-1 overflow-auto p-2 relative bg-gray-50">
                <table class="w-full text-start text-sm border-collapse bg-white shadow-sm rounded-lg">
                    <thead class="bg-blue-100 text-gray-800 sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="p-3 border border-gray-200 text-start" data-i18n="th_name">الموظف</th>
                            <th class="p-3 border border-gray-200 text-center" data-i18n="th_present">أيام الحضور</th>
                            <th class="p-3 border border-gray-200 text-center" data-i18n="th_absent">أيام الغياب</th>
                            <th class="p-3 border border-gray-200 text-center" data-i18n="th_vacation">أيام الإجازة</th>
                            <th class="p-3 border border-gray-200 text-center" data-i18n="th_total_overtime">إجمالي الإضافي</th>
                            <!-- عمود التأخير المضاف -->
                            <th class="p-3 border border-gray-200 text-center text-red-600" data-i18n="th_total_delay">إجمالي التأخير</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 4. الواجهة الرئيسية -->
    <div id="appContainer" class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-4 md:p-6 hidden h-full md:h-auto min-h-screen md:min-h-0">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b pb-4 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-blue-900" data-i18n="app_title">سجل الورديات السحابي</h1>
                <div class="flex items-center gap-2 mt-1">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <p class="text-green-600 text-xs font-bold" data-i18n="status_online">متصل: Cloud Shift Register</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                 <button onclick="openReportModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded shadow flex items-center gap-2 transition text-sm">
                    <span data-i18n="reports_title">التقارير</span>
                </button>
                <button onclick="logout()" class="text-gray-500 hover:text-red-600 text-sm underline px-2" data-i18n="logout">خروج</button>
            </div>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-end md:items-center mb-4 gap-4 bg-blue-50 p-4 rounded-lg border border-blue-100">
            <div class="flex flex-col gap-1 w-full md:w-auto">
                <label class="text-xs font-bold text-blue-800" data-i18n="shift_date">تاريخ الوردية:</label>
                <input type="date" id="currentDateInput" onchange="changeDate()" class="p-2 border border-blue-300 rounded-lg text-lg font-bold text-gray-700 outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div id="dayInfo" class="text-center hidden md:block">
                <span id="dayNameDisplay" class="text-xl font-bold text-blue-900 block">--</span>
                <span id="dateDisplay" class="text-sm text-blue-600">--</span>
            </div>
            <div id="adminControls" class="flex gap-2">
                <button onclick="toggleModal('addEmployeeOverlay', true)" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded shadow text-sm transition flex items-center gap-1">
                    <span data-i18n="new_employee">+ موظف جديد</span>
                </button>
                <div id="viewerBadge" class="hidden bg-orange-100 text-orange-800 px-3 py-2 rounded border border-orange-200 font-bold text-sm" data-i18n="viewer_mode">وضع المشاهدة</div>
            </div>
        </div>

        <div class="table-container border bg-white relative">
            <table class="w-full text-start border-collapse md:min-w-[1000px]">
                <thead>
                    <tr>
                        <th class="p-3 w-12 bg-blue-900 text-center">#</th>
                        <th class="p-3 w-48 bg-blue-900 text-start" data-i18n="th_name">اسم الموظف</th>
                        <th class="p-3 w-32 bg-blue-900 text-center" data-i18n="th_status">الحالة</th>
                        <th class="p-3 w-28 bg-blue-900 text-center" data-i18n="th_entry">دخول</th>
                        <th class="p-3 w-28 bg-blue-900 text-center" data-i18n="th_exit">خروج</th>
                        <th class="p-3 w-24 bg-blue-900 text-center" data-i18n="th_break">استراحة</th>
                        <th class="p-3 w-24 bg-blue-900 text-red-200 text-center" data-i18n="th_delay">تأخير</th>
                        <th class="p-3 w-24 bg-blue-900 text-center" data-i18n="th_overtime">إضافي</th>
                        <th class="p-3 bg-blue-900 text-center" data-i18n="th_notes">ملاحظات</th>
                        <th class="p-3 w-16 bg-blue-900 text-center delete-col" data-i18n="th_delete">حذف</th>
                    </tr>
                </thead>
                <tbody id="dailyTableBody" class="text-gray-700 text-sm font-medium"></tbody>
            </table>
            <div id="emptyState" class="hidden text-center p-8 text-gray-400" data-i18n="no_data">لا يوجد موظفين مسجلين حالياً.</div>
        </div>
    </div>

    <!-- Firebase & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // 1. نظام اللغات والترجمة (Updated)
        // ==========================================
        const translations = {
            ar: {
                app_title: "نظام إدارة الورديات والموظفين",
                login_title: "تسجيل الدخول",
                login_btn: "دخول",
                login_placeholder: "رمز الدخول",
                admin_role: "المدير:", viewer_role: "المحاسب:",
                wrong_code: "رمز خاطئ", connecting: "جاري الاتصال...",
                status_online: "متصل: Cloud Shift Register",
                reports_title: "التقارير", logout: "خروج",
                shift_date: "التاريخ:", new_employee: "+ موظف",
                viewer_mode: "وضع المشاهدة",
                add_emp_title: "إضافة موظف", emp_placeholder: "الاسم",
                save: "حفظ", cancel: "إلغاء",
                monthly_report: "تقرير شهري", annual_report: "تقرير سنوي",
                btn_monthly_report: "شهري", btn_annual_report: "سنوي",
                lbl_year: "سنة", lbl_month: "شهر",
                close: "إغلاق", export_excel: "Excel",
                th_name: "الاسم", th_present: "حضور", th_absent: "غياب",
                th_vacation: "إجازة", th_total_overtime: "إضافي", th_total_delay: "تأخير",
                th_status: "الحالة", th_entry: "دخول", th_exit: "خروج",
                th_break: "استراحة", th_delay: "تأخير", th_overtime: "إضافي",
                th_notes: "ملاحظات", th_delete: "حذف",
                no_data: "لا يوجد بيانات.",
                val_present: "حضور", val_absent: "غياب", val_vacation: "إجازة", val_choose: "--",
                day_sunday: "الأحد", day_monday: "الإثنين", day_tuesday: "الثلاثاء", day_wednesday: "الأربعاء", day_thursday: "الخميس", day_friday: "الجمعة", day_saturday: "السبت"
            },
            tr: {
                app_title: "Vardiya Sistemi",
                login_title: "Giriş", login_btn: "Giriş",
                login_placeholder: "Kod",
                admin_role: "Yönetici:", viewer_role: "Muhasebe:",
                wrong_code: "Hatalı Kod", connecting: "Bağlanıyor...",
                status_online: "Çevrimiçi",
                reports_title: "Raporlar", logout: "Çıkış",
                shift_date: "Tarih:", new_employee: "Yeni Personel",
                viewer_mode: "İzleme",
                add_emp_title: "Personel Ekle", emp_placeholder: "Ad Soyad",
                save: "Kaydet", cancel: "İptal",
                monthly_report: "Aylık Rapor", annual_report: "Yıllık Rapor",
                btn_monthly_report: "Aylık", btn_annual_report: "Yıllık",
                lbl_year: "Yıl", lbl_month: "Ay",
                close: "Kapat", export_excel: "Excel",
                th_name: "Ad Soyad", th_present: "Geldi", th_absent: "Gelmedi",
                th_vacation: "İzin", th_total_overtime: "T. Mesai", th_total_delay: "T. Gecikme",
                th_status: "Durum", th_entry: "Giriş", th_exit: "Çıkış",
                th_break: "Mola", th_delay: "Gecikme", th_overtime: "Mesai",
                th_notes: "Notlar", th_delete: "Sil",
                no_data: "Kayıt yok.",
                val_present: "Mevcut", val_absent: "Yok", val_vacation: "İzinli", val_choose: "--",
                day_sunday: "Pazar", day_monday: "Pazartesi", day_tuesday: "Salı", day_wednesday: "Çarşamba", day_thursday: "Perşembe", day_friday: "Cuma", day_saturday: "Cumartesi"
            }
        };

        let currentLang = 'tr'; 

        function detectLanguage() {
            const userLang = navigator.language || navigator.userLanguage;
            if (userLang.startsWith('ar')) { setLanguage('ar'); } else { setLanguage('tr'); }
        }

        window.changeLanguage = function(lang) {
            setLanguage(lang);
            if (!document.getElementById('appContainer').classList.contains('hidden')) { renderDailyTable(); }
        };

        function setLanguage(lang) {
            currentLang = lang;
            const dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.documentElement.lang = lang;
            document.documentElement.dir = dir;

            // تحديث إطار العلم
            const btnAr = document.getElementById('btn-ar');
            const btnTr = document.getElementById('btn-tr');
            btnAr.classList.remove('border-green-500', 'border-transparent', 'scale-110');
            btnTr.classList.remove('border-green-500', 'border-transparent', 'scale-110');
            
            if (lang === 'ar') { 
                btnAr.classList.add('border-green-500', 'scale-110'); 
                btnTr.classList.add('border-transparent'); 
            } else { 
                btnTr.classList.add('border-green-500', 'scale-110'); 
                btnAr.classList.add('border-transparent'); 
            }

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) { el.innerText = translations[lang][key]; }
            });
            document.getElementById('accessCode').placeholder = translations[lang].login_placeholder;
            document.getElementById('newEmployeeName').placeholder = translations[lang].emp_placeholder;
        }

        function t(key) { return translations[currentLang][key] || key; }

        // ==========================================
        // 2. إعدادات Firebase (الأصلية)
        // ==========================================
        let firebaseConfig;
        let appId = 'cloud-shift-register'; 

        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            if(typeof __app_id !== 'undefined' && __app_id) appId = __app_id;
        } else {
            firebaseConfig = {
                apiKey: "AIzaSyDzRczKA0tVr57TVFmnrr3F57REDTF4xHQ",
                authDomain: "cloud-shift-register.firebaseapp.com",
                projectId: "cloud-shift-register",
                storageBucket: "cloud-shift-register.firebasestorage.app",
                messagingSenderId: "823312208352",
                appId: "1:823312208352:web:0e9c6dbf7a568651ce1b85",
                measurementId: "G-48TZGWPQ53"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const dbFirestore = getFirestore(app);

        detectLanguage(); // تفعيل اللغة فوراً

        // متغيرات التطبيق
        const currentYear = new Date().getFullYear();
        let globalDb = {};
        let globalEmployees = [];
        let userRole = '';
        
        // المسار الأصلي (للأمان)
        const collectionPath = `artifacts/${appId}/public/data/attendance_app`;
        const dataDocPath = `data_${currentYear}`;
        const dataDocRef = doc(dbFirestore, collectionPath, dataDocPath);

        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                alert("Auth Failed: " + error.message);
            }
        }

        if(auth) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('loginOverlay').classList.remove('hidden');
                    
                    onSnapshot(dataDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            globalDb = data.records || {};
                            globalEmployees = data.employees || [];
                            if (!document.getElementById('appContainer').classList.contains('hidden')) {
                                renderDailyTable();
                            }
                        }
                    });
                }
            });
        }
        initAuth();

        // ==========================================
        // 3. المنطق
        // ==========================================

        window.checkLogin = function() {
            const code = document.getElementById('accessCode').value;
            if (code === '1111') { userRole = 'admin'; startApp(); }
            else if (code === '2222') { userRole = 'viewer'; startApp(); }
            else { document.getElementById('loginError').classList.remove('hidden'); }
        };

        window.logout = function() { location.reload(); };

        window.startApp = function() {
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            if (userRole === 'viewer') {
                document.getElementById('adminControls').innerHTML = 
                    `<div class="bg-orange-100 text-orange-800 px-3 py-2 rounded border border-orange-200 font-bold text-sm">${t('viewer_mode')}</div>`;
                const style = document.createElement('style');
                style.innerHTML = '.delete-col { display: none; }';
                document.head.appendChild(style);
            }
            // ضبط التاريخ والتقرير
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            document.getElementById('currentDateInput').value = todayStr;
            document.getElementById('repYearInput').value = today.getFullYear();
            document.getElementById('repMonthSelect').value = String(today.getMonth() + 1).padStart(2, '0');
            
            renderDailyTable();
        };

        window.changeDate = function() {
            renderDailyTable();
        };

        // --- تقارير (محسنة) ---
        let currentReportType = 'monthly';

        window.openReportModal = function() {
            toggleModal('monthlyReportOverlay', true);
            generateReport('monthly'); // توليد تلقائي
        };

        window.generateReport = function(type) {
            currentReportType = type;
            const year = document.getElementById('repYearInput').value;
            const month = document.getElementById('repMonthSelect').value;
            
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = '';

            let titleText = '';
            if (type === 'monthly') {
                titleText = `${t('monthly_report')} - ${year}/${month}`;
                document.getElementById('repMonthSelect').disabled = false;
            } else {
                titleText = `${t('annual_report')} - ${year}`;
                document.getElementById('repMonthSelect').disabled = true;
            }
            document.getElementById('reportTitleDisplay').innerText = titleText;

            const prefix = type === 'monthly' ? `${year}-${month}` : `${year}`;

            globalEmployees.forEach(empName => {
                let present = 0, absent = 0, vacation = 0, totalOvertime = 0, totalDelay = 0;
                const empData = globalDb[empName] || {};
                
                Object.keys(empData).forEach(dateKey => {
                    if (dateKey.startsWith(prefix)) {
                        const d = empData[dateKey];
                        if (d.status === 'present') present++;
                        if (d.status === 'absent') absent++;
                        if (d.status === 'vacation') vacation++;
                        if (d.overtime) totalOvertime += parseFloat(d.overtime) || 0;
                        if (d.shortage) totalDelay += parseFloat(d.shortage) || 0;
                    }
                });

                const tr = document.createElement('tr');
                // Added Data Labels for Mobile
                tr.innerHTML = `
                    <td class="p-3 border border-gray-300 font-bold text-start bg-gray-50" data-label-type="name">${empName}</td>
                    <td class="p-3 border border-gray-300 text-center text-green-700 font-bold" data-label="${t('th_present')}">${present}</td>
                    <td class="p-3 border border-gray-300 text-center text-red-700 font-bold" data-label="${t('th_absent')}">${absent}</td>
                    <td class="p-3 border border-gray-300 text-center text-yellow-700 font-bold" data-label="${t('th_vacation')}">${vacation}</td>
                    <td class="p-3 border border-gray-300 text-center text-blue-700 font-bold" dir="ltr" data-label="${t('th_total_overtime')}">${totalOvertime}</td>
                    <td class="p-3 border border-gray-300 text-center text-red-600 font-bold" dir="ltr" data-label="${t('th_total_delay')}">${totalDelay}</td>
                `;
                tbody.appendChild(tr);
            });
        };

        window.exportReportToCSV = function() {
            const year = document.getElementById('repYearInput').value;
            const month = document.getElementById('repMonthSelect').value;
            const title = document.getElementById('reportTitleDisplay').innerText || 'Report';
            
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += `${title}\n`;
            csvContent += `${t('th_name')},${t('th_present')},${t('th_absent')},${t('th_vacation')},${t('th_total_overtime')},${t('th_total_delay')}\n`;
            
            const prefix = currentReportType === 'monthly' ? `${year}-${month}` : `${year}`;
            globalEmployees.forEach(empName => {
                let present = 0, absent = 0, vacation = 0, totalOvertime = 0, totalDelay = 0;
                const empData = globalDb[empName] || {};
                Object.keys(empData).forEach(dateKey => {
                    if (dateKey.startsWith(prefix)) {
                        const d = empData[dateKey];
                        if (d.status === 'present') present++;
                        if (d.status === 'absent') absent++;
                        if (d.status === 'vacation') vacation++;
                        if (d.overtime) totalOvertime += parseFloat(d.overtime) || 0;
                        if (d.shortage) totalDelay += parseFloat(d.shortage) || 0;
                    }
                });
                csvContent += `"${empName}",${present},${absent},${vacation},${totalOvertime},${totalDelay}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Report_${prefix}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        window.handleSmartTimeInput = function(input, empName, dateStr, field) {
            let val = input.value.trim();
            if(!val) { saveDataToCloud(empName, dateStr, field, ''); return; }
            val = val.replace(/[^0-9:]/g, '');
            if (val.indexOf(':') === -1) {
                if (val.length === 1 || val.length === 2) {
                    let hour = parseInt(val);
                    if (hour >= 0 && hour <= 23) val = val.padStart(2, '0') + ":00";
                } else if (val.length === 3) {
                    val = "0" + val.substring(0, 1) + ":" + val.substring(1);
                } else if (val.length === 4) {
                    val = val.substring(0, 2) + ":" + val.substring(2);
                }
            }
            const timeRegex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
            if (timeRegex.test(val)) {
                input.value = val;
                saveDataToCloud(empName, dateStr, field, val);
            }
        };

        window.confirmAddEmployee = async function() {
            const name = document.getElementById('newEmployeeName').value.trim();
            if (!name) return;
            if (globalEmployees.includes(name)) { alert("Exists / موجود"); return; }
            try {
                await setDoc(dataDocRef, { employees: arrayUnion(name) }, { merge: true });
                document.getElementById('newEmployeeName').value = '';
                toggleModal('addEmployeeOverlay', false);
            } catch (e) { console.error(e); }
        };

        window.deleteEmployee = async function(name) {
            if (userRole !== 'admin') return;
            if (!confirm(t('th_delete') + " ?")) return;
            try {
                await updateDoc(dataDocRef, { employees: arrayRemove(name) });
            } catch (e) { console.error(e); }
        };

        window.saveDataToCloud = async function(empName, date, field, value) {
            if (userRole !== 'admin') return;
            const updatePath = `records.${empName}.${date}`;
            let updates = {};
            updates[`${updatePath}.${field}`] = value;

            if (field === 'status' && (value === 'absent' || value === 'vacation')) {
                updates[`${updatePath}.entry`] = '';
                updates[`${updatePath}.exit`] = '';
                updates[`${updatePath}.breakDuration`] = '0';
                updates[`${updatePath}.shortage`] = '';
                updates[`${updatePath}.overtime`] = '';
            }
            if ((field === 'entry' || field === 'exit') && value) {
                const currentStatus = globalDb[empName]?.[date]?.status;
                if (!currentStatus) updates[`${updatePath}.status`] = 'present';
            }
            try {
                await updateDoc(dataDocRef, updates);
            } catch (e) {
                let deepObject = {};
                if(!deepObject[empName]) deepObject[empName] = {};
                if(!deepObject[empName][date]) deepObject[empName][date] = {};
                deepObject[empName][date][field] = value;
                await setDoc(dataDocRef, { records: deepObject }, { merge: true });
            }
        };

        window.renderDailyTable = function() {
            const dateStr = document.getElementById('currentDateInput').value;
            if(!dateStr) return;

            const dateObj = new Date(dateStr);
            const daysKey = ['day_sunday', 'day_monday', 'day_tuesday', 'day_wednesday', 'day_thursday', 'day_friday', 'day_saturday'];
            document.getElementById('dayNameDisplay').innerText = t(daysKey[dateObj.getDay()]);
            document.getElementById('dateDisplay').innerText = dateStr;

            const tbody = document.getElementById('dailyTableBody');
            tbody.innerHTML = '';

            if (!globalEmployees || globalEmployees.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }
            document.getElementById('emptyState').classList.add('hidden');

            globalEmployees.forEach((empName, index) => {
                const empRecords = globalDb[empName] || {};
                const dayData = empRecords[dateStr] || { status: '', entry: '', exit: '', breakDuration: '0', shortage: '', overtime: '', notes: '' };

                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 border-b transition duration-150";

                const isFrozen = (dayData.status === 'absent' || dayData.status === 'vacation');
                const isInputsFrozen = !dayData.status || dayData.status !== 'present';
                const isDisabled = (userRole === 'viewer') ? 'disabled' : '';
                const inputsDisabled = isInputsFrozen || userRole === 'viewer' ? 'disabled' : '';

                let rowBg = '';
                if(dayData.status === 'absent') rowBg = 'bg-red-50';
                if(dayData.status === 'vacation') rowBg = 'bg-yellow-50';
                if(dayData.status === 'present') rowBg = 'bg-green-50';
                if(rowBg) tr.classList.add(rowBg);

                const breakVal = dayData.breakDuration || '0';
                const shortageVal = dayData.shortage || '';

                tr.innerHTML = `
                    <td class="p-3 text-center text-gray-500" data-label="#" data-label-type="index">${index + 1}</td>
                    <td class="p-3 font-bold text-gray-800" data-label="${t('th_name')}" data-label-type="name">${empName}</td>
                    <td class="p-3" data-label="${t('th_status')}">
                        <select onchange="saveDataToCloud('${empName}', '${dateStr}', 'status', this.value)" ${isDisabled}
                                class="w-full p-2 border rounded bg-white text-sm focus:ring-2 focus:ring-blue-400 outline-none cursor-pointer">
                            <option value="">${t('val_choose')}</option>
                            <option value="present" ${dayData.status === 'present' ? 'selected' : ''}>${t('val_present')}</option>
                            <option value="absent" ${dayData.status === 'absent' ? 'selected' : ''}>${t('val_absent')}</option>
                            <option value="vacation" ${dayData.status === 'vacation' ? 'selected' : ''}>${t('val_vacation')}</option>
                        </select>
                    </td>
                    <td class="p-3" data-label="${t('th_entry')}">
                        <input type="text" value="${dayData.entry || ''}" placeholder="--:--" onchange="handleSmartTimeInput(this, '${empName}', '${dateStr}', 'entry')" ${inputsDisabled} class="w-full p-2 border rounded bg-white text-sm text-center placeholder-gray-300 focus:ring-2 focus:ring-blue-400 outline-none ltr" style="direction: ltr;">
                    </td>
                    <td class="p-3" data-label="${t('th_exit')}">
                        <input type="text" value="${dayData.exit || ''}" placeholder="--:--" onchange="handleSmartTimeInput(this, '${empName}', '${dateStr}', 'exit')" ${inputsDisabled} class="w-full p-2 border rounded bg-white text-sm text-center placeholder-gray-300 focus:ring-2 focus:ring-blue-400 outline-none ltr" style="direction: ltr;">
                    </td>
                    <td class="p-3" data-label="${t('th_break')}">
                        <input type="number" step="0.5" min="0" value="${breakVal}" onchange="saveDataToCloud('${empName}', '${dateStr}', 'breakDuration', this.value)" ${inputsDisabled} class="w-full p-2 border rounded bg-white text-sm text-center focus:ring-2 focus:ring-blue-400 outline-none">
                    </td>
                    <td class="p-3" data-label="${t('th_delay')}">
                        <input type="number" step="0.5" max="0" value="${shortageVal}" onchange="if(this.value > 0) this.value = -this.value; saveDataToCloud('${empName}', '${dateStr}', 'shortage', this.value)" ${inputsDisabled} class="w-full p-2 border rounded bg-white text-sm text-center text-red-600 focus:ring-2 focus:ring-red-400 outline-none placeholder-red-300" placeholder="-">
                    </td>
                    <td class="p-3" data-label="${t('th_overtime')}"><input type="number" step="0.5" value="${dayData.overtime || ''}" onchange="saveDataToCloud('${empName}', '${dateStr}', 'overtime', this.value)" ${inputsDisabled} class="w-full p-2 border rounded bg-white text-sm text-center" placeholder="0"></td>
                    <td class="p-3" data-label="${t('th_notes')}"><input type="text" value="${dayData.notes || ''}" onchange="saveDataToCloud('${empName}', '${dateStr}', 'notes', this.value)" ${isDisabled} class="w-full p-2 border rounded bg-white text-sm" placeholder="..."></td>
                    ${userRole === 'admin' ? 
                    `<td class="p-3 text-center delete-col" data-label="${t('th_delete')}"><button onclick="deleteEmployee('${empName}')" class="text-red-400 hover:text-red-700 font-bold px-2">×</button></td>` 
                    : '<td class="p-3"></td>'}
                `;
                tbody.appendChild(tr);
            });
        };

        window.toggleModal = function(id, show) {
            const el = document.getElementById(id);
            if(show) { 
                el.classList.remove('hidden'); 
                if(id === 'addEmployeeOverlay') document.getElementById('newEmployeeName').focus(); 
            } else { 
                el.classList.add('hidden'); 
            }
        };

        document.getElementById('accessCode').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') window.checkLogin();
        });

    </script>
</body>
</html>
