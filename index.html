<!DOCTYPE html>
<html lang="ar" dir="rtl" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- 1. عنوان المتصفح الجديد بالأحرف الكبيرة -->
    <title>OZELBIMS</title>
    
    <!-- 2. أيقونة المتصفح (Favicon) -->
    <link rel="icon" type="image/png" href="https://i.imgur.com/623NMYe.png">
    
    <!-- 3. أيقونة تطبيق الموبايل (عند الإضافة للشاشة الرئيسية) -->
    <link rel="apple-touch-icon" href="https://i.imgur.com/623NMYe.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Cairo', 'sans-serif'],
                    },
                    colors: {
                        dark: {
                            bg:     '#05091A',
                            card:   '#0C1535',
                            text:   '#E2E8F0',
                            border: '#1E3A8A',
                            input:  '#0A1040'
                        },
                        accent: {
                            cyan:   '#38BDF8',
                            violet: '#A78BFA',
                            emerald:'#34D399',
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&family=Exo+2:ital,wght@0,300;0,400;0,600;0,800;0,900;1,400&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* ============================================
           NEXUS COMMAND — Design System v1.0
           ============================================ */

        :root {
            /* Light Mode Palette */
            --bg-base:       #EFF4FF;
            --bg-card:       #FFFFFF;
            --bg-glass:      rgba(255,255,255,0.85);
            --bg-toolbar:    #F0F6FF;
            --bg-header:     linear-gradient(135deg, #1E3A8A 0%, #1D4ED8 50%, #2563EB 100%);
            --accent:        #2563EB;
            --accent-glow:   rgba(37,99,235,0.35);
            --accent2:       #7C3AED;
            --text-primary:  #0F172A;
            --text-secondary:#475569;
            --text-muted:    #94A3B8;
            --border:        rgba(37,99,235,0.18);
            --shadow-card:   0 8px 32px rgba(37,99,235,0.12), 0 2px 8px rgba(0,0,0,0.06);
            --shadow-lg:     0 20px 60px rgba(37,99,235,0.2);
            --radius:        14px;
            --radius-sm:     8px;
        }

        .dark {
            --bg-base:       #080E28;
            --bg-card:       #0F1B40;
            --bg-glass:      rgba(15,27,64,0.92);
            --bg-toolbar:    #0B1432;
            --bg-header:     linear-gradient(135deg, #080C2A 0%, #0C1445 50%, #0F1840 100%);
            --accent:        #38BDF8;
            --accent-glow:   rgba(56,189,248,0.35);
            --accent2:       #A78BFA;
            --text-primary:  #E2E8F0;
            --text-secondary:#94A3B8;
            --text-muted:    #5A6785;
            --border:        rgba(56,189,248,0.2);
            --shadow-card:   0 8px 40px rgba(0,0,0,0.5), 0 0 0 1px rgba(56,189,248,0.12);
            --shadow-lg:     0 24px 80px rgba(0,0,0,0.7);
        }

        /* ---- Base ---- */
        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-base);
            color: var(--text-primary);
            transition: background 0.4s ease, color 0.3s ease;
            min-height: 100vh;
        }

        /* Animated background mesh */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            z-index: -1;
            background:
                radial-gradient(ellipse 80% 50% at 10% 15%, rgba(37,99,235,0.08) 0%, transparent 60%),
                radial-gradient(ellipse 60% 40% at 90% 80%, rgba(124,58,237,0.07) 0%, transparent 60%),
                var(--bg-base);
            pointer-events: none;
        }

        .dark body::before {
            background:
                radial-gradient(ellipse 80% 50% at 10% 15%, rgba(56,189,248,0.07) 0%, transparent 60%),
                radial-gradient(ellipse 60% 40% at 90% 80%, rgba(167,139,250,0.06) 0%, transparent 60%),
                var(--bg-base);
        }

        /* ---- Typography ---- */
        h1, h2, h3, h4 { font-family: 'Cairo', sans-serif; font-weight: 700; }
        .font-brand { font-family: 'Exo 2', sans-serif; }

        /* ---- Scrollbar ---- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 99px; opacity: 0.5; }
        ::-webkit-scrollbar-thumb:hover { opacity: 1; }

        /* ---- Utilities ---- */
        .select-none { user-select: none; -webkit-user-select: none; }
        .hidden { display: none !important; }

        /* ---- Loading Overlay ---- */
        .overlay {
            position: fixed; inset: 0; z-index: 50;
            display: flex; justify-content: center; align-items: center;
            background-color: rgba(5,9,26,0.96) ;
            backdrop-filter: blur(12px);
        }
        .loader {
            width: 44px; height: 44px;
            border-radius: 50%;
            border: 3px solid rgba(56,189,248,0.15);
            border-top-color: var(--accent);
            animation: spin 0.8s linear infinite;
            box-shadow: 0 0 20px var(--accent-glow);
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ---- Modal Overlay ---- */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 40;
            display: flex; justify-content: center; align-items: center;
            padding: 1rem;
            background-color: rgba(5,9,26,0.7) ;
            backdrop-filter: blur(8px);
        }

        /* ============================================
           LOGIN SCREEN — Light & Dark modes
           ============================================ */

        /* The overlay class already handles: fixed inset-0 flex center */
        /* We only override the background gradient here */

        /* === LIGHT MODE === */
        #loginOverlay {
            background:
                radial-gradient(ellipse 80% 50% at 50% 0%, rgba(37,99,235,0.12) 0%, transparent 55%),
                radial-gradient(ellipse 60% 40% at 0% 80%, rgba(124,58,237,0.08) 0%, transparent 60%),
                #EFF4FF !important;
        }

        /* Grid overlay — light mode subtle */
        #loginOverlay::before {
            content: '';
            position: absolute; inset: 0; z-index: 0; pointer-events: none;
            background-image:
                linear-gradient(rgba(37,99,235,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(37,99,235,0.05) 1px, transparent 1px);
            background-size: 44px 44px;
        }

        #loginOverlay > * { position: relative; z-index: 1; }

        /* === LIGHT MODE Card === */
        #loginOverlay > div:first-of-type {
            background-color: rgba(255,255,255,0.92) !important;
            border: 1px solid rgba(37,99,235,0.18) !important;
            border-radius: 24px !important;
            box-shadow:
                0 0 0 1px rgba(37,99,235,0.07),
                0 25px 70px rgba(37,99,235,0.15),
                inset 0 1px 0 rgba(255,255,255,1) !important;
            backdrop-filter: blur(24px);
            padding: 2.5rem !important;
        }

        /* === DARK MODE Background === */
        .dark #loginOverlay {
            background:
                radial-gradient(ellipse 90% 60% at 50% -10%, rgba(56,189,248,0.18) 0%, transparent 55%),
                radial-gradient(ellipse 70% 50% at -10% 50%, rgba(124,58,237,0.12) 0%, transparent 60%),
                radial-gradient(ellipse 60% 40% at 110% 80%, rgba(56,189,248,0.1) 0%, transparent 60%),
                #05091A !important;
        }
        .dark #loginOverlay::before {
            background-image:
                linear-gradient(rgba(56,189,248,0.04) 1px, transparent 1px),
                linear-gradient(90deg, rgba(56,189,248,0.04) 1px, transparent 1px);
            background-size: 44px 44px;
        }

        /* === DARK MODE Card === */
        .dark #loginOverlay > div:first-of-type {
            background-color: rgba(12,21,53,0.88) !important;
            border: 1px solid rgba(56,189,248,0.22) !important;
            box-shadow:
                0 0 0 1px rgba(56,189,248,0.08),
                0 25px 80px rgba(0,0,0,0.7),
                inset 0 1px 0 rgba(255,255,255,0.06) !important;
        }

        /* === Dark Mode Toggle Button === */
        .fixed-top-left {
            position: absolute;
            top: 1rem;
            left: 1rem !important;
            right: auto !important;
            border-radius: 50%;
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
            /* Light mode style */
            background-color: rgba(37,99,235,0.1) !important;
            border: 1px solid rgba(37,99,235,0.25) !important;
            color: #2563EB !important;
        }
        .fixed-top-left:hover {
            background-color: rgba(37,99,235,0.18) !important;
            box-shadow: 0 0 18px rgba(37,99,235,0.25) !important;
            transform: rotate(15deg) scale(1.1);
        }
        .dark .fixed-top-left {
            background-color: rgba(56,189,248,0.1) !important;
            border-color: rgba(56,189,248,0.2) !important;
            color: #38BDF8 !important;
        }
        .dark .fixed-top-left:hover {
            background-color: rgba(56,189,248,0.2) !important;
            box-shadow: 0 0 18px rgba(56,189,248,0.3) !important;
        }

        /* === Login Title === */
        #loginOverlay h2 {
            color: #1E3A8A !important;
            font-size: 1.6rem;
            font-weight: 800;
            letter-spacing: 0.5px;
        }
        .dark #loginOverlay h2 { color: #E2E8F0 !important; }

        #loginOverlay p { color: #64748B !important; }
        .dark #loginOverlay p { color: #94A3B8 !important; }

        /* Version Badge */
        #loginOverlay .bg-blue-100 {
            background-color: rgba(37,99,235,0.1) !important;
            color: #2563EB !important;
            border-radius: 99px !important;
            font-weight: 700 !important;
        }
        .dark #loginOverlay .bg-blue-100 {
            background-color: rgba(56,189,248,0.15) !important;
            color: #38BDF8 !important;
        }

        /* === Login Input === */
        /* Hide browser's native password reveal button (Chrome/Edge/Safari) */
        #accessCode::-ms-reveal,
        #accessCode::-ms-clear,
        #accessCode::-webkit-contacts-auto-fill-button,
        #accessCode::-webkit-credentials-auto-fill-button {
            display: none !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }

        #accessCode {
            border-radius: 10px !important;
            font-size: 1rem !important;
            letter-spacing: 0.3em !important;
            text-align: center !important;
            /* symmetric padding so text stays centered */
            padding: 0.65rem 2.5rem !important;
            transition: all 0.3s ease !important;
            width: 100%;
            /* Light mode */
            background-color: rgba(239,244,255,0.8) !important;
            border: 1px solid rgba(37,99,235,0.22) !important;
            color: #1E3A8A !important;
            caret-color: #2563EB;
            /* Prevent browser from adding its own icons */
            -webkit-appearance: none;
            appearance: none;
        }
        #accessCode::placeholder {
            color: rgba(37,99,235,0.3) !important;
            letter-spacing: 0.1em;
            font-size: 0.85rem;
        }
        #accessCode:focus {
            border-color: rgba(37,99,235,0.55) !important;
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1), 0 0 16px rgba(37,99,235,0.08) !important;
            outline: none !important;
            background: #fff !important;
        }
        .dark #accessCode {
            background-color: rgba(5,9,26,0.65) !important;
            border-color: rgba(56,189,248,0.22) !important;
            color: #E2E8F0 !important;
            caret-color: #38BDF8;
        }
        .dark #accessCode::placeholder { color: rgba(148,163,184,0.28) !important; }
        .dark #accessCode:focus {
            border-color: rgba(56,189,248,0.5) !important;
            box-shadow: 0 0 0 3px rgba(56,189,248,0.12), 0 0 18px rgba(56,189,248,0.08) !important;
            background-color: rgba(5,9,26,0.85) !important;
        }

        /* Eye toggle button — sits on the right end */
        #togglePasswordBtn {
            position: absolute;
            right: 0.7rem;
            left: auto !important;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem 0.3rem;
            line-height: 1;
            border-radius: 6px;
            color: rgba(37,99,235,0.4);
            transition: color 0.2s ease, transform 0.2s ease, background 0.2s ease;
            display: flex; align-items: center; justify-content: center;
            z-index: 5;
        }
        #togglePasswordBtn:hover {
            color: #2563EB;
            background-color: rgba(37,99,235,0.08) ;
            transform: translateY(-50%) scale(1.12);
        }
        .dark #togglePasswordBtn { color: rgba(56,189,248,0.38); }
        .dark #togglePasswordBtn:hover {
            color: #38BDF8;
            background-color: rgba(56,189,248,0.1) ;
        }
        #togglePasswordBtn i { font-size: 0.92rem; }

        /* === Login Button === */
        #loginOverlay button[onclick="checkLogin()"] {
            border: none !important;
            border-radius: 12px !important;
            font-weight: 800 !important;
            font-size: 1rem !important;
            letter-spacing: 0.5px !important;
            color: white !important;
            padding: 0.85rem !important;
            transition: all 0.3s ease !important;
            position: relative !important;
            overflow: hidden !important;
            /* Light mode */
            background: linear-gradient(135deg, #1D4ED8, #2563EB) !important;
            box-shadow: 0 4px 20px rgba(37,99,235,0.4) !important;
        }
        .dark #loginOverlay button[onclick="checkLogin()"] {
            background: linear-gradient(135deg, #1D4ED8, #38BDF8) !important;
            box-shadow: 0 4px 20px rgba(56,189,248,0.35) !important;
        }
        #loginOverlay button[onclick="checkLogin()"]::before {
            content: '';
            position: absolute; inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.15), transparent);
            border-radius: inherit;
        }
        #loginOverlay button[onclick="checkLogin()"]:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 28px rgba(37,99,235,0.5) !important;
        }
        .dark #loginOverlay button[onclick="checkLogin()"]:hover {
            box-shadow: 0 8px 28px rgba(56,189,248,0.5) !important;
        }

        /* === Language Toggle === */
        #loginOverlay .bg-gray-200 {
            background-color: rgba(37,99,235,0.08) !important;
            border-color: rgba(37,99,235,0.2) !important;
        }
        .dark #loginOverlay .bg-gray-200 {
            background-color: rgba(56,189,248,0.1) !important;
            border-color: rgba(56,189,248,0.2) !important;
        }
        #lang-knob {
            background: linear-gradient(135deg, #1D4ED8, #2563EB) !important;
            box-shadow: 0 0 10px rgba(37,99,235,0.4) !important;
        }
        .dark #lang-knob {
            background: linear-gradient(135deg, #1D4ED8, #38BDF8) !important;
            box-shadow: 0 0 10px rgba(56,189,248,0.5) !important;
        }

        /* Flag labels text */
        #loginOverlay #label-tr span, #loginOverlay #label-ar span {
            color: #64748B !important;
        }
        #loginOverlay #label-ar span { color: #1E3A8A !important; font-weight: 800 !important; }
        .dark #loginOverlay #label-tr span,
        .dark #loginOverlay #label-ar span { color: #94A3B8 !important; }
        .dark #loginOverlay #label-ar span { color: #E2E8F0 !important; }

        /* Error message */
        #loginError { color: #DC2626 !important; font-weight: 700 !important; }
        .dark #loginError { color: #F87171 !important; }

        /* ============================================
           LOGO GLOW
           ============================================ */
        .logo-glow-container {
            position: relative;
            display: inline-block;
            border-radius: 20px;
            overflow: hidden;
        }
        .logo-glow-container::after {
            content: '';
            position: absolute; top: 0; left: -150%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
            transform: skewX(-25deg);
            animation: logo-shine-anim 4s infinite ease-in-out;
            pointer-events: none; z-index: 20;
        }
        @keyframes logo-shine-anim {
            0% { left: -150%; }
            20% { left: 150%; }
            100% { left: 150%; }
        }

        /* ============================================
           MAIN APP CONTAINER
           ============================================ */
        #appContainer {
            background-color: var(--bg-card) !important;
            border: 1px solid var(--border) !important;
            border-radius: 20px !important;
            box-shadow: var(--shadow-card) !important;
            padding: 1.5rem !important;
        }

        /* Header section */
        #appContainer > div:first-child {
            border-bottom: 1px solid var(--border) !important;
            padding-bottom: 1.25rem !important;
            margin-bottom: 1.25rem !important;
        }

        /* App Title */
        #appContainer h1 {
            font-size: 1.5rem !important;
            font-weight: 900 !important;
            background: linear-gradient(135deg, #1D4ED8, #38BDF8) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
            letter-spacing: -0.5px;
        }
        .dark #appContainer h1 {
            background: linear-gradient(135deg, #38BDF8, #A78BFA) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
        }

        /* Shift Badge */
        #shiftBadge {
            background: linear-gradient(135deg, rgba(124,58,237,0.2), rgba(167,139,250,0.1)) !important;
            border: 1px solid rgba(167,139,250,0.4) !important;
            color: #A78BFA !important;
            border-radius: 99px !important;
            font-weight: 700 !important;
        }

        /* Connection Dot */
        #connectionDot { box-shadow: 0 0 8px currentColor; }

        /* ============================================
           BUTTONS — Global
           ============================================ */

        /* Dark Mode Toggle */
        button[onclick="toggleDarkMode()"] {
            background-color: rgba(37,99,235,0.1) !important;
            border: 1px solid rgba(37,99,235,0.25) !important;
            color: #2563EB !important;
            border-radius: 50% !important;
            transition: all 0.3s ease !important;
        }
        button[onclick="toggleDarkMode()"]:hover {
            background-color: rgba(37,99,235,0.2) !important;
            box-shadow: 0 0 15px rgba(37,99,235,0.3) !important;
            transform: rotate(15deg) scale(1.1) !important;
        }
        .dark button[onclick="toggleDarkMode()"] {
            background-color: rgba(56,189,248,0.1) !important;
            border-color: rgba(56,189,248,0.25) !important;
            color: #38BDF8 !important;
        }
        .dark button[onclick="toggleDarkMode()"]:hover {
            box-shadow: 0 0 15px rgba(56,189,248,0.3) !important;
        }

        /* Data Button */
        #dataBtn {
            background: linear-gradient(135deg, #374151, #1F2937) !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            border-radius: 10px !important;
            font-weight: 700 !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3) !important;
        }
        #dataBtn:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4) !important;
        }

        /* Reports Button */
        button[onclick="openReportModal()"] {
            background: linear-gradient(135deg, #4F46E5, #7C3AED) !important;
            border: none !important;
            border-radius: 10px !important;
            font-weight: 700 !important;
            box-shadow: 0 4px 15px rgba(124,58,237,0.35) !important;
            transition: all 0.3s ease !important;
        }
        button[onclick="openReportModal()"]:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 25px rgba(124,58,237,0.5) !important;
        }

        /* Logout */
        button[onclick="logout()"] {
            color: var(--text-muted) !important;
            text-decoration: none !important;
            font-weight: 600 !important;
            padding: 0.4rem 0.75rem !important;
            border-radius: 8px !important;
            border: 1px solid transparent !important;
            transition: all 0.2s ease !important;
        }
        button[onclick="logout()"]:hover {
            color: #F87171 !important;
            background-color: rgba(248,113,113,0.1) !important;
            border-color: rgba(248,113,113,0.25) !important;
        }

        /* Add Employee Button */
        button[onclick="openAddEmployeeModal()"] {
            background: linear-gradient(135deg, #059669, #10B981) !important;
            border: none !important;
            border-radius: 10px !important;
            font-weight: 700 !important;
            box-shadow: 0 4px 15px rgba(16,185,129,0.35) !important;
            transition: all 0.3s ease !important;
        }
        button[onclick="openAddEmployeeModal()"]:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 25px rgba(16,185,129,0.5) !important;
        }

        /* ============================================
           TOOLBAR / FILTER AREA
           ============================================ */
        #appContainer > div:nth-child(2) {
            background-color: var(--bg-toolbar) !important;
            border: 1px solid var(--border) !important;
            border-radius: 14px !important;
            padding: 1rem !important;
        }

        /* Labels */
        label {
            font-weight: 700 !important;
            color: var(--text-secondary) !important;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            font-size: 0.65rem !important;
        }

        /* Date Input & Selects */
        input[type="date"],
        #shiftFilter, #viewerPermission {
            background-color: var(--bg-card) !important;
            border: 1px solid var(--border) !important;
            color: var(--text-primary) !important;
            border-radius: 10px !important;
            font-weight: 700 !important;
            font-family: 'Cairo', sans-serif !important;
            transition: all 0.2s ease !important;
        }
        input[type="date"]:focus,
        #shiftFilter:focus, #viewerPermission:focus {
            border-color: var(--accent) !important;
            box-shadow: 0 0 0 3px var(--accent-glow) !important;
            outline: none !important;
        }

        /* Day Display */
        #dayNameDisplay {
            background: linear-gradient(135deg, var(--accent), var(--accent2)) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
            font-size: 1.3rem !important;
            font-weight: 900 !important;
        }
        #dateDisplay { color: var(--text-secondary) !important; font-weight: 600 !important; }

        /* Bulk Controls Buttons */
        button[onclick="applyBulkAction('entry')"] {
            background: linear-gradient(135deg, #059669, #10B981) !important;
            border-radius: 8px 8px 0 0 !important;
            border: none !important;
            font-weight: 700 !important;
            box-shadow: none !important;
            transition: filter 0.2s ease !important;
        }
        button[onclick="applyBulkAction('entry')"]:hover { filter: brightness(1.15) !important; }

        button[onclick="applyBulkAction('exit')"] {
            background: linear-gradient(135deg, #1D4ED8, #38BDF8) !important;
            border-radius: 8px 8px 0 0 !important;
            border: none !important;
            font-weight: 700 !important;
            box-shadow: none !important;
            transition: filter 0.2s ease !important;
        }
        button[onclick="applyBulkAction('exit')"]:hover { filter: brightness(1.15) !important; }

        button[onclick="applyBulkAction('break')"] {
            background: linear-gradient(135deg, #D97706, #F59E0B) !important;
            border-radius: 8px 8px 0 0 !important;
            border: none !important;
            font-weight: 700 !important;
            box-shadow: none !important;
            transition: filter 0.2s ease !important;
        }
        button[onclick="applyBulkAction('break')"]:hover { filter: brightness(1.12) !important; }

        #bulkBreakInput {
            background-color: var(--bg-card) !important;
            border-top: none !important;
            font-weight: 700 !important;
            font-size: 0.9rem !important;
            border-color: rgba(245,158,11,0.4) !important;
            color: var(--text-primary) !important;
        }
        #bulkBreakInput::-webkit-inner-spin-button,
        #bulkBreakInput::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        #bulkEntryInput, #bulkExitInput {
            background-color: var(--bg-card) !important;
            border-top: none !important;
            font-weight: 700 !important;
            font-size: 0.9rem !important;
        }

        /* ============================================
           EMPLOYEE STATS CARD
           ============================================ */
        #employeeStatsCard {
            background-color: var(--bg-card) !important;
            border: none !important;
            border-radius: 14px !important;
            box-shadow: var(--shadow-card) !important;
            border-left: 3px solid var(--accent2) !important;
            padding: 1.25rem !important;
        }
        .dark #employeeStatsCard { border-left-color: #A78BFA !important; }

        /* ============================================
           MAIN TABLE
           ============================================ */
        .table-container {
            overflow-x: auto;
            max-height: 70vh;
            border-radius: 14px !important;
            border: 1px solid var(--border) !important;
            box-shadow: var(--shadow-card) !important;
            background-color: var(--bg-card) !important;
        }

        /* Table Header */
        thead th {
            position: sticky; top: 0; z-index: 10;
            background: linear-gradient(135deg, #0F2167 0%, #1E3A8A 50%, #1D4ED8 100%) !important;
            color: white !important;
            font-weight: 700 !important;
            font-size: 0.8rem !important;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0.85rem 0.75rem !important;
            border-bottom: 2px solid rgba(56,189,248,0.4) !important;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .dark thead th {
            background: linear-gradient(135deg, #05091A 0%, #0A1040 50%, #0C1535 100%) !important;
            border-bottom: 2px solid rgba(56,189,248,0.3) !important;
        }

        /* Table Rows */
        tbody tr {
            transition: all 0.2s ease !important;
            border-bottom: 1px solid var(--border) !important;
        }
        tbody tr:hover {
            background-color: rgba(37,99,235,0.05) !important;
            transform: none !important;
        }
        .dark tbody tr:hover { background-color: rgba(56,189,248,0.04) !important; }

        /* Table Cells */
        tbody td {
            padding: 0.6rem 0.75rem !important;
            color: var(--text-primary) !important;
            vertical-align: middle !important;
        }

        /* ---- Admin name cell action buttons (float, don't affect name layout) ---- */
        .admin-name-actions {
            position: absolute;
            bottom: 4px;
            left: 6px;
            display: inline-flex;
            gap: 2px;
            pointer-events: none;
        }
        .group:hover .admin-name-actions { pointer-events: auto; }
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            width: 22px; height: 22px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 4px;
            color: #94A3B8;
            transition: background 0.15s, color 0.15s;
            padding: 0;
        }
        .action-btn:hover { background-color: rgba(37,99,235,0.12) ; color: #2563EB; }
        .dark .action-btn:hover { background-color: rgba(56,189,248,0.12) ; color: #38BDF8; }

        /* ---- Disable drag on interactive elements inside draggable rows ---- */
        .draggable-row input,
        .draggable-row select,
        .draggable-row textarea,
        .draggable-row button {
            -webkit-user-drag: none !important;
            user-drag: none !important;
        }

        /* ---- Status Row Colors (vibrant) ---- */
        .status-present  { background-color: rgba(16,185,129,0.08) !important; color: #059669 !important; }
        .status-absent   { background-color: rgba(239,68,68,0.08) !important;  color: #DC2626 !important; }
        .status-vacation { background-color: rgba(245,158,11,0.08) !important; color: #D97706 !important; }
        .status-holiday  { background-color: rgba(139,92,246,0.08) !important; color: #7C3AED !important; }
        .status-sunday   { background-color: rgba(6,182,212,0.08) !important;  color: #0891B2 !important; }

        .dark .status-present  { background-color: rgba(16,185,129,0.12) !important; color: #34D399 !important; }
        .dark .status-absent   { background-color: rgba(239,68,68,0.12) !important;  color: #F87171 !important; }
        .dark .status-vacation { background-color: rgba(245,158,11,0.12) !important; color: #FBBF24 !important; }
        .dark .status-holiday  { background-color: rgba(139,92,246,0.12) !important; color: #A78BFA !important; }
        .dark .status-sunday   { background-color: rgba(6,182,212,0.12) !important;  color: #67E8F9 !important; }

        /* Row status colors via JS-added tailwind classes */
        tr.bg-green-50  { background-color: rgba(16,185,129,0.07) !important; }
        tr.bg-red-50    { background-color: rgba(239,68,68,0.07) !important; }
        tr.bg-yellow-50 { background-color: rgba(245,158,11,0.07) !important; }
        .dark tr.dark\:bg-red-900\/20    { background-color: rgba(239,68,68,0.1) !important; }
        .dark tr.dark\:bg-green-900\/20  { background-color: rgba(16,185,129,0.1) !important; }
        .dark tr.dark\:bg-yellow-900\/20 { background-color: rgba(245,158,11,0.1) !important; }

        /* ---- Table Inputs & Selects ---- */
        td input, td select { text-align: center !important; text-align-last: center !important; }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        td select, td input[type="tel"], td input[type="number"], td input[type="text"] {
            background-color: rgba(37,99,235,0.05) !important;
            border: 1px solid rgba(37,99,235,0.15) !important;
            border-radius: 8px !important;
            color: var(--text-primary) !important;
            font-family: 'Cairo', sans-serif !important;
            font-weight: 600 !important;
            font-size: 0.82rem !important;
            transition: all 0.2s ease !important;
            padding: 0.4rem 0.5rem !important;
        }
        td select:focus, td input:focus {
            border-color: var(--accent) !important;
            box-shadow: 0 0 0 2px var(--accent-glow) !important;
            outline: none !important;
            background-color: var(--bg-card) !important;
        }
        .dark td select, .dark td input[type="tel"],
        .dark td input[type="number"], .dark td input[type="text"] {
            background-color: rgba(56,189,248,0.05) !important;
            border-color: rgba(56,189,248,0.12) !important;
        }

        /* Disabled inputs */
        input:disabled, select:disabled {
            background-color: rgba(148,163,184,0.07) !important;
            cursor: default !important;
            color: var(--text-primary) !important;
            border-color: rgba(148,163,184,0.15) !important;
            opacity: 1 !important;
            -webkit-text-fill-color: var(--text-primary) !important;
            font-weight: 700 !important;
        }
        .dark input:disabled, .dark select:disabled {
            background-color: rgba(255,255,255,0.03) !important;
            color: #94A3B8 !important;
            -webkit-text-fill-color: #94A3B8 !important;
            border-color: rgba(255,255,255,0.06) !important;
        }
        select:disabled { appearance: none !important; background-image: none !important; }

        /* Note Input */
        input.note-input:disabled {
            color: #DC2626 !important;
            -webkit-text-fill-color: #DC2626 !important;
        }
        .dark input.note-input:disabled {
            color: #F87171 !important;
            -webkit-text-fill-color: #F87171 !important;
        }

        /* Name cell clickable */
        td[data-label-type="name"] {
            font-weight: 800 !important;
            font-size: 0.9rem !important;
        }
        td[data-label-type="name"]:hover { background-color: rgba(37,99,235,0.06) !important; }
        .dark td[data-label-type="name"]:hover { background-color: rgba(56,189,248,0.06) !important; }

        /* Delete button */
        td.delete-col button {
            color: #F87171 !important;
            font-size: 1.2rem !important;
            width: 28px; height: 28px;
            border-radius: 6px !important;
            display: inline-flex; align-items: center; justify-content: center;
            transition: all 0.2s ease !important;
        }
        td.delete-col button:hover {
            background-color: rgba(248,113,113,0.15) !important;
            color: #EF4444 !important;
        }

        /* Edit pencil button */
        .group button[title="تعديل"] {
            color: var(--text-muted) !important;
            border-radius: 6px !important;
            transition: all 0.2s ease !important;
        }
        .group button[title="تعديل"]:hover {
            color: var(--accent) !important;
            background: var(--accent-glow) !important;
        }

        /* ============================================
           DRAG & DROP
           ============================================ */
        .draggable-row { cursor: grab; }
        .draggable-row.dragging {
            opacity: 0.5 !important;
            background-color: rgba(37,99,235,0.1) !important;
            box-shadow: 0 8px 30px rgba(37,99,235,0.2) !important;
        }
        .dark .draggable-row.dragging { background-color: rgba(56,189,248,0.08) !important; }
        .drag-handle {
            cursor: grab;
            color: var(--text-muted) !important;
            font-size: 1.1rem !important;
            margin-left: 0.5rem !important;
            opacity: 0.5;
            transition: all 0.2s ease;
        }
        .drag-handle:hover { color: var(--accent) !important; opacity: 1 !important; }
        .drag-over { border-top: 2px solid var(--accent) !important; }

        /* ============================================
           ANIMATIONS
           ============================================ */
        .fade-in-down {
            animation: fadeInDown 0.35s cubic-bezier(0.22,1,0.36,1) forwards;
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-12px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        [data-aos="zoom-in"] {
            animation: zoomIn 0.8s cubic-bezier(0.175,0.885,0.32,1.275) forwards;
            opacity: 0;
        }
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.85); }
            to   { opacity: 1; transform: scale(1); }
        }

        /* ============================================
           MODALS (Add Employee / Data Manager / etc)
           ============================================ */
        .modal-overlay > div {
            background-color: var(--bg-card) !important;
            border: 1px solid var(--border) !important;
            border-radius: 20px !important;
            box-shadow: var(--shadow-lg) !important;
        }

        /* Modal header */
        .modal-overlay h3 {
            font-weight: 800 !important;
            color: var(--text-primary) !important;
        }

        /* Modal inputs */
        #newEmployeeName, #newEmployeeShift {
            background-color: var(--bg-base) !important;
            border: 1px solid var(--border) !important;
            color: var(--text-primary) !important;
            border-radius: 10px !important;
            font-family: 'Cairo', sans-serif !important;
            font-weight: 600 !important;
            transition: all 0.2s ease !important;
        }
        #newEmployeeName:focus, #newEmployeeShift:focus {
            border-color: var(--accent) !important;
            box-shadow: 0 0 0 3px var(--accent-glow) !important;
            outline: none !important;
        }

        /* Modal Save Button */
        button[onclick="saveEmployeeToMasterList()"] {
            background: linear-gradient(135deg, #1D4ED8, #38BDF8) !important;
            border: none !important;
            border-radius: 10px !important;
            font-weight: 700 !important;
            box-shadow: 0 4px 15px rgba(56,189,248,0.3) !important;
            transition: all 0.3s ease !important;
        }
        button[onclick="saveEmployeeToMasterList()"]:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 6px 20px rgba(56,189,248,0.4) !important;
        }

        /* Cancel Button (generic gray buttons) */
        .bg-gray-200, .dark\:bg-gray-700 {
            background-color: rgba(148,163,184,0.12) !important;
            color: var(--text-secondary) !important;
        }

        /* Modal borders */
        .border-b { border-color: var(--border) !important; }
        .border { border-color: var(--border) !important; }

        /* ============================================
           REPORT MODAL TABLE
           ============================================ */
        #monthlyReportOverlay > div {
            border-radius: 20px !important;
            overflow: hidden !important;
        }
        #monthlyReportOverlay .bg-gray-50,
        #monthlyReportOverlay .dark\:bg-gray-900 {
            background-color: var(--bg-base) !important;
        }
        #reportTitleDisplay {
            background: linear-gradient(135deg, rgba(37,99,235,0.08), rgba(124,58,237,0.05)) !important;
            color: var(--accent) !important;
            font-weight: 800 !important;
            border: none !important;
            padding: 0.75rem !important;
        }
        .dark #reportTitleDisplay { color: #38BDF8 !important; }

        /* Report buttons */
        button[onclick="generateReport('monthly')"] {
            background: linear-gradient(135deg, #1D4ED8, #2563EB) !important;
            border-radius: 8px !important; border: none !important;
            font-weight: 700 !important;
            box-shadow: 0 3px 12px rgba(37,99,235,0.35) !important;
            transition: all 0.2s ease !important;
        }
        button[onclick="generateReport('annual')"] {
            background: linear-gradient(135deg, #4F46E5, #7C3AED) !important;
            border-radius: 8px !important; border: none !important;
            font-weight: 700 !important;
            box-shadow: 0 3px 12px rgba(124,58,237,0.35) !important;
            transition: all 0.2s ease !important;
        }
        button[onclick="exportReportToCSV()"] {
            background: linear-gradient(135deg, #059669, #10B981) !important;
            border-radius: 8px !important; border: none !important;
            font-weight: 700 !important;
            box-shadow: 0 3px 12px rgba(16,185,129,0.35) !important;
            transition: all 0.2s ease !important;
        }

        /* Data Manager Buttons */
        button[onclick="viewLoginLogs()"] {
            background: linear-gradient(135deg, #0F766E, #14B8A6) !important;
            border: none !important; border-radius: 10px !important;
            font-weight: 700 !important;
            box-shadow: 0 3px 12px rgba(20,184,166,0.35) !important;
            transition: all 0.2s ease !important;
        }
        button[onclick="openRecycleBin()"] {
            background: linear-gradient(135deg, #991B1B, #EF4444) !important;
            border: none !important; border-radius: 10px !important;
            font-weight: 700 !important;
            box-shadow: 0 3px 12px rgba(239,68,68,0.35) !important;
            transition: all 0.2s ease !important;
        }
        button[onclick="exportBackup()"] {
            background: linear-gradient(135deg, #3730A3, #6366F1) !important;
            border: none !important; border-radius: 10px !important;
            font-weight: 700 !important;
            transition: all 0.2s ease !important;
        }
        button[onclick="importLegacyEmployees()"] {
            background: linear-gradient(135deg, #92400E, #F59E0B) !important;
            border: none !important; border-radius: 8px !important;
            font-weight: 700 !important;
            transition: all 0.2s ease !important;
        }

        /* Close buttons (modal headers) */
        button[data-i18n="close"] {
            background: transparent !important;
            border: 1px solid var(--border) !important;
            color: var(--text-secondary) !important;
            border-radius: 8px !important;
            font-weight: 600 !important;
            transition: all 0.2s ease !important;
        }
        button[data-i18n="close"]:hover {
            background-color: rgba(248,113,113,0.1) !important;
            border-color: rgba(248,113,113,0.3) !important;
            color: #F87171 !important;
        }

        /* ============================================
           DEVELOPER CARD — Mode-Aware
           ============================================ */
        .mega-icon-card {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 14px;
            padding: 11px 30px;
            border-radius: 50px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            text-decoration: none;
            overflow: hidden;
            position: relative;
            transition: all 0.4s cubic-bezier(0.25,0.8,0.25,1);
            cursor: default;
            direction: ltr;
        }

        /* Shine sweep animation */
        .mega-icon-card::before {
            content: '';
            position: absolute; top: 0; left: -100%;
            width: 50%; height: 100%;
            transform: skewX(-25deg);
            pointer-events: none;
            animation: continuous-shine 3.5s infinite ease-in-out;
        }
        @keyframes continuous-shine {
            0%   { left: -150%; opacity: 0; }
            10%  { opacity: 1; }
            20%  { left: 150%; opacity: 0; }
            100% { left: 150%; opacity: 0; }
        }

        /* --- LIGHT MODE card --- */
        html:not(.dark) .mega-icon-card {
            background-color: rgba(255,255,255,0.88) ;
            border: 1px solid rgba(37,99,235,0.22);
            box-shadow: 0 8px 28px rgba(37,99,235,0.14), 0 2px 8px rgba(0,0,0,0.05), inset 0 1px 0 rgba(255,255,255,1);
        }
        html:not(.dark) .mega-icon-card::before {
            background: linear-gradient(90deg, transparent, rgba(37,99,235,0.12), rgba(124,58,237,0.08), transparent);
        }
        html:not(.dark) .mega-icon-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 14px 40px rgba(37,99,235,0.22), 0 0 0 1px rgba(37,99,235,0.15);
            border-color: rgba(37,99,235,0.35);
        }
        html:not(.dark) .mega-icon-card span {
            font-weight: 800;
            font-size: 0.8rem;
            letter-spacing: 2.5px;
            font-family: 'Exo 2', sans-serif;
            text-transform: uppercase;
            background: linear-gradient(135deg, #1D4ED8 0%, #7C3AED 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* --- DARK MODE card --- */
        html.dark .mega-icon-card {
            background-color: rgba(8,15,40,0.82) ;
            border: 1px solid rgba(56,189,248,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.5), 0 0 0 1px rgba(56,189,248,0.07);
        }
        html.dark .mega-icon-card::before {
            background: linear-gradient(90deg, transparent, rgba(56,189,248,0.22), rgba(167,139,250,0.1), transparent);
        }
        html.dark .mega-icon-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 45px rgba(0,0,0,0.6), 0 0 30px rgba(56,189,248,0.12);
            border-color: rgba(56,189,248,0.38);
        }
        html.dark .mega-icon-card span {
            color: #94A3B8;
            font-weight: 700;
            font-size: 0.8rem;
            letter-spacing: 2.5px;
            font-family: 'Exo 2', sans-serif;
            text-transform: uppercase;
        }

        /* Keep .light-mode class working for devCardMain (toggled by JS) */
        .mega-icon-card.light-mode {
            background-color: rgba(255,255,255,0.88) !important;
            border: 1px solid rgba(37,99,235,0.22) !important;
            box-shadow: 0 8px 28px rgba(37,99,235,0.14), inset 0 1px 0 rgba(255,255,255,1) !important;
        }
        .mega-icon-card.light-mode::before {
            background: linear-gradient(90deg, transparent, rgba(37,99,235,0.12), rgba(124,58,237,0.08), transparent) !important;
        }
        .mega-icon-card.light-mode span {
            background: linear-gradient(135deg, #1D4ED8 0%, #7C3AED 100%) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
            font-weight: 800 !important;
            letter-spacing: 2.5px !important;
        }

        /* ============================================
           SOCIAL BUBBLES — Mode-Aware
           ============================================ */
        .social-bubble {
            width: 50px; height: 50px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            font-size: 1.35rem;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.175,0.885,0.32,1.275);
            z-index: 10;
        }
        .social-bubble i { position: relative; z-index: 20; }

        /* Light mode social bubbles */
        html:not(.dark) .social-bubble {
            background-color: rgba(255,255,255,0.75) ;
            border: 1px solid rgba(37,99,235,0.2);
            box-shadow: 0 4px 14px rgba(37,99,235,0.1);
            color: #475569 !important;
        }
        html:not(.dark) .social-bubble:hover {
            transform: translateY(-6px) scale(1.14);
            box-shadow: 0 14px 30px rgba(0,0,0,0.18);
            border-color: transparent;
            color: white !important;
        }
        /* Dark mode social bubbles */
        html.dark .social-bubble {
            background-color: rgba(56,189,248,0.07) ;
            border: 1px solid rgba(56,189,248,0.14);
            box-shadow: 0 4px 14px rgba(0,0,0,0.25);
            color: #94A3B8 !important;
        }
        html.dark .social-bubble:hover {
            transform: translateY(-6px) scale(1.14);
            box-shadow: 0 14px 32px rgba(0,0,0,0.5);
            border-color: transparent;
            color: white !important;
        }

        /* Hover brand colors */
        .social-bubble.fb:hover  { background: #1877F2 !important; box-shadow: 0 12px 28px rgba(24,119,242,0.5) !important; }
        .social-bubble.ig:hover  { background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285AEB 90%) !important; }
        .social-bubble.x:hover   { background: #0F0F0F !important; box-shadow: 0 12px 28px rgba(0,0,0,0.45) !important; }
        .social-bubble.tg:hover  { background: linear-gradient(135deg, #2AABEE, #229ED9) !important; box-shadow: 0 12px 28px rgba(42,171,238,0.5) !important; }

        /* Shine on bubbles */
        .social-bubble::after {
            content: '';
            position: absolute; top: 0; left: -200%;
            width: 100%; height: 100%;
            background: linear-gradient(120deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: skewX(-25deg);
            z-index: 1;
            animation: icon-shine-continuous 3s infinite ease-in-out;
        }
        @keyframes icon-shine-continuous {
            0%   { left: -150%; opacity: 0; }
            10%  { opacity: 0.9; }
            20%  { left: 150%; opacity: 0; }
            100% { left: 150%; opacity: 0; }
        }

        /* ============================================
           LEGACY IMPORT NOTICE
           ============================================ */
        .bg-orange-50, .dark\:bg-orange-900\/30 {
            background-color: rgba(245,158,11,0.08) !important;
            border-color: rgba(245,158,11,0.25) !important;
            border-radius: 10px !important;
        }

        /* ============================================
           EMPTY STATE
           ============================================ */
        #emptyState {
            color: var(--text-muted) !important;
            font-weight: 600 !important;
            padding: 3rem !important;
        }

        /* ============================================
           LOGIN LOG TABLE
           ============================================ */
        #loginLogOverlay thead { background-color: rgba(15,118,110,0.15) !important; }
        #loginLogOverlay thead th {
            background: linear-gradient(135deg, #0F766E, #0D9488) !important;
        }

        /* ============================================
           REPORT TABLE HEADER
           ============================================ */
        #monthlyReportOverlay thead th {
            background: linear-gradient(135deg, #1E3A8A, #2563EB) !important;
        }
        .dark #monthlyReportOverlay thead th {
            background: linear-gradient(135deg, #05091A, #0A1040) !important;
        }

        /* Adjust Year input in report modal */
        #repYearInput {
            background-color: var(--bg-base) !important;
            border: 1px solid var(--border) !important;
            border-radius: 8px !important;
            color: var(--text-primary) !important;
            font-weight: 700 !important;
        }

        /* ============================================
           VIEWER MODE BADGE
           ============================================ */
        #adminControls .bg-orange-100 {
            background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(217,119,6,0.1)) !important;
            border: 1px solid rgba(245,158,11,0.3) !important;
            border-radius: 10px !important;
            color: #F59E0B !important;
        }
        .dark #adminControls .bg-orange-100 {
            background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(217,119,6,0.1)) !important;
            color: #FBBF24 !important;
        }

        /* ============================================
           RECYCLE BIN & LOG BACKGROUNDS
           ============================================ */
        .bg-gray-50, .dark\:bg-gray-900\/50 {
            background-color: var(--bg-base) !important;
        }

        /* ============================================
           MOBILE / RESPONSIVE
           ============================================ */
        @media (max-width: 768px) {
            .table-container, .overflow-auto {
                background: transparent; box-shadow: none;
                overflow: visible !important; max-height: none !important; border: none;
            }
            #monthlyReportOverlay .overflow-auto {
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch;
                max-height: 70vh !important;
            }
            table, thead, tbody, th, td, tr { display: block; width: 100%; }
            thead { display: none; }

            tr {
                background-color: var(--bg-card) !important;
                margin-bottom: 1rem !important;
                border-radius: 14px !important;
                box-shadow: var(--shadow-card) !important;
                padding: 0 !important;
                border: 1px solid var(--border) !important;
                overflow: hidden !important;
            }

            td {
                padding: 0.75rem 1rem !important;
                border-bottom: 1px solid var(--border) !important;
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                text-align: start !important;
                min-height: 50px !important;
            }
            td:last-child { border-bottom: none !important; }

            td::before {
                content: attr(data-label);
                font-weight: 700 !important;
                color: var(--text-muted) !important;
                font-size: 0.75rem !important;
                flex-basis: 40%;
                text-align: start;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            td[data-label-type="name"] {
                background: linear-gradient(135deg, rgba(37,99,235,0.08), var(--bg-card)) !important;
                padding: 1rem !important;
                justify-content: center !important;
                color: var(--accent) !important;
                font-size: 1rem !important;
                font-weight: 900 !important;
                border-bottom: 2px solid var(--border) !important;
                border-top: 3px solid var(--accent) !important;
            }
            .dark td[data-label-type="name"] {
                background: linear-gradient(135deg, rgba(56,189,248,0.1), var(--bg-card)) !important;
                color: #38BDF8 !important;
                border-top-color: #38BDF8 !important;
            }
            td[data-label-type="name"]::before { display: none !important; }
            td[data-label-type="index"] { display: none !important; }

            td input, td select { width: 55% !important; padding: 0.5rem !important; }

            td.delete-col {
                background-color: rgba(248,113,113,0.06) !important;
                justify-content: center !important;
                padding: 0.75rem !important;
            }
            td.delete-col button { width: 100% !important; }
            td.delete-col::before { display: none !important; }
        }

        /* ============================================
           DARK SCROLLBAR
           ============================================ */
        .dark ::-webkit-scrollbar { width: 6px; height: 6px; }
        .dark ::-webkit-scrollbar-track { background-color: rgba(255,255,255,0.02) ; }
        .dark ::-webkit-scrollbar-thumb { background-color: rgba(56,189,248,0.35) ; border-radius: 99px; }
        .dark ::-webkit-scrollbar-thumb:hover { background-color: rgba(56,189,248,0.6) ; }

        /* Light mode body background */
        html.light body { background: #EFF4FF !important; }
        html.dark body  { background: #080E28 !important; }



        /* ============================================
           FIX: Prevent iOS auto-zoom on table inputs
           font-size < 16px triggers unwanted zoom on iOS
           ============================================ */
        @media (max-width: 768px) {
            td input, td select {
                font-size: 16px !important;
                touch-action: manipulation !important;
            }
        }

        /* Global border-b color in modals */
        .modal-overlay .border-b { border-bottom-color: var(--border) !important; }
        .modal-overlay .border-gray-700 { border-color: var(--border) !important; }

        /* Override any raw tailwind gray backgrounds */
        .dark .bg-gray-800  { background-color: var(--bg-card) !important; }
        .dark .bg-gray-900  { background-color: var(--bg-base) !important; }
        .dark .bg-gray-700  { background-color: rgba(255,255,255,0.04) !important; }
        .bg-white           { background-color: var(--bg-card) !important; }

        /* Report table hover rows */
        #reportTableBody tr:hover { background-color: rgba(37,99,235,0.05) !important; }
        .dark #reportTableBody tr:hover { background-color: rgba(56,189,248,0.04) !important; }

        /* Mobile report table colored label prefixes */
        @media (max-width: 768px) {
            #reportTableBody td[data-label*="حضور"]::before,
            #reportTableBody td[data-label*="Present"]::before { color: #10B981 !important; }
            #reportTableBody td[data-label*="غياب"]::before,
            #reportTableBody td[data-label*="Absent"]::before  { color: #EF4444 !important; }
            #reportTableBody td[data-label*="إجازة"]::before,
            #reportTableBody td[data-label*="Vacation"]::before{ color: #F59E0B !important; }
            #reportTableBody td[data-label*="تأخير"]::before,
            #reportTableBody td[data-label*="Delay"]::before   { color: #F87171 !important; }
        }

    </style>


</head>
<body class="text-gray-800 dark:text-gray-100 transition-colors duration-300" style="padding: 1rem 1.25rem; min-height: 100vh;">

    <div id="loadingScreen" class="overlay hidden" style="z-index: 60;">
        <div class="flex flex-col items-center gap-4">
            <div class="loader"></div>
            <p class="font-bold text-sm tracking-widest" style="color: #38BDF8; font-family:'Exo 2',sans-serif; text-transform:uppercase; letter-spacing:3px;" id="loadingText" data-i18n="loading_processing">Processing...</p>
        </div>
    </div>

    <div id="loginOverlay" class="overlay flex-col gap-10">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl max-w-sm w-full text-center relative border border-gray-200 dark:border-gray-700">
            <!-- زر الوضع الليلي مع التوهج في الوضعين -->
            <button onclick="toggleDarkMode()" class="fixed-top-left w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-yellow-400 flex items-center justify-center transition shadow-[0_0_15px_rgba(100,116,139,0.5)] dark:shadow-[0_0_15px_rgba(250,204,21,0.6)] hover:bg-gray-200 dark:hover:bg-gray-600 z-10" title="Dark Mode">
                <i class="theme-toggle-icon fa-solid fa-moon"></i>
            </button>

            <!-- Language Toggle Switch (Capsule) - Vertical Flags with Glow -->
            <!-- dir="ltr" ensures the order is always: TR - Toggle - AR -->
            <div class="flex items-center justify-center gap-3 mb-8 cursor-pointer group" onclick="toggleLanguageSwitch()" dir="ltr">
                
                <!-- Turkish Side - Centered Moon with object-position CORRECTED to 25% (Shift Left) -->
                <div class="flex flex-col items-center gap-1 transition-all duration-300 opacity-50 grayscale" id="label-tr">
                    <img src="https://flagcdn.com/w80/tr.png" class="w-8 h-8 rounded-full object-cover ring-2 ring-gray-100 dark:ring-gray-600 shadow-[0_0_15px_rgba(220,38,38,0.8)]" style="object-position: 25% center;">
                    <span class="font-bold text-gray-500 dark:text-gray-400 group-hover:text-gray-700 dark:group-hover:text-gray-200 transition-colors text-xs mt-1">Türkçe</span>
                </div>

                <!-- Toggle Track -->
                <div class="relative w-14 h-8 bg-gray-200 dark:bg-gray-700 rounded-full shadow-inner border border-gray-300 dark:border-gray-600 transition-colors mx-2">
                    <!-- Green Knob -->
                    <div id="lang-knob" class="absolute top-1 left-1 w-6 h-6 bg-green-500 rounded-full shadow-md transition-transform duration-300 transform translate-x-6">
                        <!-- Optional: Small shine on knob -->
                        <div class="absolute top-1 left-1 w-2 h-2 bg-white rounded-full opacity-30"></div>
                    </div>
                </div>

                <!-- Arabic Side - Glow Green -->
                <div class="flex flex-col items-center gap-1 transition-all duration-300 opacity-100" id="label-ar">
                    <img src="https://flagcdn.com/w80/sy.png" class="w-8 h-8 rounded-full object-cover ring-2 ring-gray-100 dark:ring-gray-600 shadow-[0_0_15px_rgba(22,163,74,0.8)]">
                    <span class="font-bold text-gray-800 dark:text-white text-xs mt-1">العربية</span>
                </div>
            </div>

            <!-- شعار الشركة في شاشة الدخول مع تأثير اللمعة -->
            <div class="flex justify-center mb-4">
                <div class="logo-glow-container">
                    <img src="https://i.imgur.com/623NMYe.png" alt="ozelBims Logo" class="w-24 h-24 object-contain drop-shadow-lg relative z-10">
                </div>
            </div>

            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2" data-i18n="login_title">تسجيل الدخول</h2>
            <p class="text-gray-500 dark:text-gray-400 mb-6 text-sm">Version <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full font-bold">V4.1</span></p>
            <div class="relative w-full mb-4">
                <input type="password" id="accessCode" inputmode="numeric" pattern="[0-9]*" class="w-full border rounded-lg text-center tracking-widest outline-none transition-colors" placeholder="Code">
                <button type="button" id="togglePasswordBtn" onclick="togglePasswordVisibility()" title="إظهار/إخفاء الرمز">
                    <i id="eyeIcon" class="fa-solid fa-eye-slash" style="font-size:1rem;"></i>
                </button>
            </div>
            <button onclick="checkLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition mb-4 shadow-lg" data-i18n="login_btn">دخول</button>
            
            <p id="loginError" class="text-red-500 text-sm mt-2 hidden" data-i18n="msg_wrong_code">رمز خاطئ</p>
        </div>

        <!-- تذييل واجهة الدخول (أيقونات) -->
        <div class="flex flex-col items-center gap-3" data-aos="zoom-in">
            <div id="devCardLogin" class="mega-icon-card">
                <span>Developed by EMAD ALLAHAM</span>
            </div>
            <!-- حاوية الأيقونات الزجاجية: dir="ltr" يجبر الترتيب يسار ليمين دائماً -->
            <div class="flex gap-4" dir="ltr">
                <!-- Facebook -->
                <a href="https://www.facebook.com/emad.allahaam" target="_blank" class="social-bubble fb" title="Facebook">
                    <i class="fa-brands fa-facebook-f"></i>
                </a>
                <!-- X (Twitter) -->
                <a href="https://x.com/edlm83" target="_blank" class="social-bubble x" title="X (Twitter)">
                    <i class="fa-brands fa-x-twitter"></i>
                </a>
                <!-- Instagram -->
                <a href="https://www.instagram.com/edlm83" target="_blank" class="social-bubble ig" title="Instagram">
                    <i class="fa-brands fa-instagram"></i>
                </a>
                <!-- Telegram -->
                <a href="https://t.me/edlm83" target="_blank" class="social-bubble tg" title="Telegram">
                    <i class="fa-brands fa-telegram"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- نافذة نقل الوردية -->
    <div id="transferShiftOverlay" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border dark:border-gray-700">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-1 flex items-center gap-2">
                <span style="font-size:1.3rem">🔄</span>
                <span>نقل الوردية</span>
                <span class="text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 px-2 py-0.5 rounded-full font-bold">Transfer</span>
            </h3>
            <input type="hidden" id="transferEmpId">
            <p id="transferEmpNameDisplay" class="text-sm text-gray-500 dark:text-gray-400 mb-5 border-b dark:border-gray-700 pb-3"></p>
            <div class="mb-5">
                <label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 block uppercase tracking-wider">الوردية الجديدة</label>
                <select id="transferShiftSelect" class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg text-base font-bold">
                    <option value="shift_A" data-i18n="val_shift_a">الوردية A</option>
                    <option value="shift_B" data-i18n="val_shift_b">الوردية B</option>
                </select>
            </div>
            <div class="flex gap-2">
                <button onclick="executeTransferShift()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 rounded-lg transition shadow-md">تأكيد النقل</button>
                <button onclick="toggleModal('transferShiftOverlay', false)" class="flex-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-bold py-2.5 rounded-lg transition">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة موظف -->
    <div id="addEmployeeOverlay" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border dark:border-gray-700">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4" id="empModalTitle" data-i18n="add_emp_title">إضافة موظف</h3>
            <input type="hidden" id="editEmployeeId">
            <input type="text" id="newEmployeeName" class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="الاسم الثلاثي" data-i18n-ph="ph_employee_name">
            
            <div class="mb-4">
                <label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block" data-i18n="lbl_shift">الوردية</label>
                <select id="newEmployeeShift" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg">
                    <option value="shift_A" data-i18n="val_shift_a">الوردية A</option>
                    <option value="shift_B" data-i18n="val_shift_b">الوردية B</option>
                </select>
            </div>

            <div class="flex gap-2">
                <button onclick="saveEmployeeToMasterList()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition" data-i18n="save">حفظ</button>
                <button onclick="toggleModal('addEmployeeOverlay', false)" class="flex-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-bold py-2 rounded-lg transition" data-i18n="cancel">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- نافذة إدارة البيانات (تحوي زر السجل وسلة المحذوفات) -->
    <div id="dataManagerOverlay" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-md w-full border dark:border-gray-700">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
                <span>💾</span> <span data-i18n="data_management">إدارة البيانات</span>
            </h3>
            
            <div class="grid grid-cols-2 gap-2 mb-6">
                <!-- زر سجل الدخول -->
                <button onclick="viewLoginLogs()" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded flex justify-center items-center gap-2 shadow-sm transition">
                    <span>📜</span> <span data-i18n="btn_login_log">سجل الدخول</span>
                </button>
                <!-- زر سلة المحذوفات -->
                <button onclick="openRecycleBin()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded flex justify-center items-center gap-2 shadow-sm transition">
                    <span>🗑️</span> <span data-i18n="btn_recycle_bin">المحذوفات</span>
                </button>
            </div>

            <div class="mb-6 bg-orange-50 dark:bg-orange-900/30 p-3 rounded border border-orange-200 dark:border-orange-800">
                <h4 class="font-bold text-orange-800 dark:text-orange-300 text-sm mb-2" data-i18n="legacy_import_title">📥 الانتقال من النظام القديم (V2)</h4>
                <p class="text-xs text-orange-600 dark:text-orange-400 mb-3" data-i18n="legacy_import_desc">اضغط هنا فقط إذا كنت تريد جلب الموظفين وبيانات الحضور من ملفات السنة الماضية.</p>
                <button onclick="importLegacyEmployees()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 rounded text-sm shadow" data-i18n="btn_import_legacy">استيراد الموظفين والسجلات</button>
            </div>

            <div class="space-y-3">
                <button onclick="exportBackup()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded flex justify-center items-center gap-2">
                    <span>⬇️</span> <span data-i18n="btn_backup_download">تحميل نسخة احتياطية (JSON)</span>
                </button>
                
                <div class="relative">
                    <input type="file" id="restoreFile" class="hidden" onchange="restoreBackup(this)">
                    <button onclick="document.getElementById('restoreFile').click()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded flex justify-center items-center gap-2">
                        <span>⬆️</span> <span data-i18n="btn_restore_upload">استعادة نسخة محفوظة</span>
                    </button>
                </div>
            </div>

            <button onclick="toggleModal('dataManagerOverlay', false)" class="w-full mt-4 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-400 py-2 rounded" data-i18n="close">إغلاق</button>
        </div>
    </div>

    <!-- نافذة سلة المحذوفات (Recycle Bin Modal) -->
    <div id="recycleBinOverlay" class="modal-overlay hidden" style="align-items: flex-start; padding-top: 2rem;">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg flex flex-col max-h-[85vh] border dark:border-gray-700 overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b dark:border-gray-700 flex-shrink-0">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white flex items-center gap-2">
                    <span>🗑️</span> <span data-i18n="recycle_bin_title">الموظفون المحذوفون</span>
                </h3>
                <button onclick="toggleModal('recycleBinOverlay', false)" class="text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-1 rounded" data-i18n="close">إغلاق</button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 relative bg-gray-50 dark:bg-gray-900/50">
                <div id="recycleBinList" class="space-y-2"></div>
                <div id="emptyRecycleBin" class="hidden text-center p-8 text-gray-400 dark:text-gray-500" data-i18n="no_deleted_emp">لا يوجد موظفين محذوفين.</div>
            </div>
        </div>
    </div>

    <!-- نافذة عرض سجلات الدخول (معدلة للموبايل) -->
    <div id="loginLogOverlay" class="modal-overlay hidden" style="align-items: flex-start; padding-top: 2rem;">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl flex flex-col max-h-[85vh] border dark:border-gray-700 overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b dark:border-gray-700 flex-shrink-0">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white" data-i18n="log_modal_title">سجل دخول المستخدمين</h3>
                <div class="flex gap-2">
                    <!-- أزرار جديدة: تصدير ومسح -->
                    <button id="btnExportLog" onclick="exportLoginLogs()" class="text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 px-3 py-1 rounded hidden" title="Export Excel">
                        <i class="fa-solid fa-download"></i>
                    </button>
                    <button id="btnClearLog" onclick="clearLoginLogs()" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 px-3 py-1 rounded hidden" title="Clear Logs">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                    <button onclick="toggleModal('loginLogOverlay', false)" class="text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-1 rounded" data-i18n="close">إغلاق</button>
                </div>
            </div>
            <!-- تم تعديل هذه المنطقة لتسمح بالتمرير الداخلي في الموبايل -->
            <div class="flex-1 overflow-y-auto p-2 relative bg-gray-50 dark:bg-gray-900/50" style="overscroll-behavior: contain;">
                <table class="w-full text-start text-sm border-collapse bg-white dark:bg-gray-800 shadow-sm rounded-lg">
                    <thead class="bg-teal-100 dark:bg-teal-900 text-gray-800 dark:text-white sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-start" data-i18n="th_role">الرتبة</th>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-center ltr" data-i18n="th_time">الوقت والتاريخ</th>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-center" data-i18n="th_device">الجهاز</th>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-start" data-i18n="th_browser">المتصفح</th>
                        </tr>
                    </thead>
                    <tbody id="loginLogTableBody" class="text-gray-700 dark:text-gray-300"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="monthlyReportOverlay" class="modal-overlay hidden" style="align-items: flex-start; padding-top: 2rem;">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-5xl flex flex-col max-h-[90vh] md:h-[90vh] border dark:border-gray-700">
            <div class="flex justify-between items-center p-4 border-b dark:border-gray-700">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white" data-i18n="reports_title">التقارير</h3>
                <button onclick="toggleModal('monthlyReportOverlay', false)" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 px-3 py-1 rounded" data-i18n="close">إغلاق</button>
            </div>
            <div class="flex flex-wrap gap-3 p-4 bg-gray-50 dark:bg-gray-900 border-b dark:border-gray-700 items-center">
                <div class="flex items-center gap-2">
                    <div class="flex flex-col">
                        <label class="text-xs font-bold text-gray-500 dark:text-gray-400" data-i18n="lbl_year">السنة</label>
                        <div class="relative flex items-center">
                            <input type="number" id="repYearInput" class="p-2 pl-6 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded w-24 text-center font-bold" style="-moz-appearance: textfield;">
                            <div class="absolute left-0 inset-y-0 flex flex-col border-r dark:border-r-gray-600 w-6 rounded-l overflow-hidden">
                                <button onclick="adjustRepYear(1)" class="h-1/2 hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 flex items-center justify-center border-b border-gray-200 dark:border-gray-600 transition-colors bg-gray-50 dark:bg-gray-700">
                                    <i class="fa-solid fa-caret-up text-[10px]"></i>
                                </button>
                                <button onclick="adjustRepYear(-1)" class="h-1/2 hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 flex items-center justify-center transition-colors bg-gray-50 dark:bg-gray-700">
                                    <i class="fa-solid fa-caret-down text-[10px]"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <label class="text-xs font-bold text-gray-500 dark:text-gray-400" data-i18n="lbl_month">الشهر</label>
                        <select id="repMonthSelect" onchange="generateReport('monthly')" class="p-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded w-28 font-bold cursor-pointer">
                            <option value="01">01</option> <option value="02">02</option> <option value="03">03</option>
                            <option value="04">04</option> <option value="05">05</option> <option value="06">06</option>
                            <option value="07">07</option> <option value="08">08</option> <option value="09">09</option>
                            <option value="10">10</option> <option value="11">11</option> <option value="12">12</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-2 flex-grow justify-end">
                    <button onclick="generateReport('monthly')" class="bg-blue-600 text-white px-3 py-2 rounded text-xs md:text-sm font-bold hover:bg-blue-700" data-i18n="btn_monthly_report">شهري</button>
                    <button onclick="generateReport('annual')" class="bg-indigo-600 text-white px-3 py-2 rounded text-xs md:text-sm font-bold hover:bg-indigo-700" data-i18n="btn_annual_report">سنوي</button>
                    <button onclick="exportReportToCSV()" class="bg-green-600 text-white px-3 py-2 rounded text-xs md:text-sm font-bold hover:bg-green-700" data-i18n="export_excel">Excel</button>
                </div>
            </div>
            <div id="reportTitleDisplay" class="text-center font-bold text-lg text-blue-900 dark:text-blue-300 py-2 border-b dark:border-gray-700 bg-blue-50/50 dark:bg-blue-900/20"></div>
            <div class="flex-1 overflow-auto p-2 relative bg-gray-50 dark:bg-gray-900/50">
                <table class="w-full text-start text-sm border-collapse bg-white dark:bg-gray-800 shadow-sm rounded-lg">
                    <thead class="bg-blue-100 dark:bg-gray-700 text-gray-800 dark:text-white sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-start" data-i18n="th_name">الموظف</th>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-center" data-i18n="th_present">أيام الحضور</th>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-center" data-i18n="th_absent">أيام الغياب</th>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-center" data-i18n="th_vacation">أيام الإجازة</th>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-center text-purple-700 dark:text-purple-300" data-i18n="th_holiday">رسمية</th>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-center text-cyan-700 dark:text-cyan-300" data-i18n="th_sunday">الأحد</th>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-center" data-i18n="th_total_overtime">إجمالي الإضافي</th>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-center text-red-600 dark:text-red-400" data-i18n="th_total_delay">إجمالي التأخير</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody" class="dark:text-gray-300"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="appContainer" class="max-w-7xl mx-auto rounded-xl hidden h-full md:h-auto min-h-screen md:min-h-0 flex flex-col" style="margin-top:1.5rem; margin-bottom:1.5rem;">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b dark:border-gray-700 pb-4 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-blue-900 dark:text-blue-300 flex items-center gap-2">
                    <span data-i18n="app_title">سجل الورديات</span>
                    <span id="shiftBadge" class="hidden text-xs bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 px-2 py-1 rounded-full" data-i18n="badge_shift_b">الوردية B</span>
                </h1>
                <div class="flex items-center gap-2 mt-1">
                    <span id="connectionDot" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <p id="connectionText" class="text-green-600 dark:text-green-400 text-xs font-bold" data-i18n="status_online">متصل وجاهز للعمل</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                 <button onclick="toggleDarkMode()" class="p-2 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-yellow-400 hover:bg-gray-200 dark:hover:bg-gray-600 transition shadow-sm">
                    <i class="theme-toggle-icon fa-solid fa-moon"></i>
                </button>

                 <button id="dataBtn" onclick="toggleModal('dataManagerOverlay', true)" class="hidden bg-gray-700 hover:bg-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 text-white px-3 py-2 rounded shadow flex items-center gap-2 transition text-sm">
                    <span>💾</span> <span class="hidden md:inline" data-i18n="data_btn">بيانات</span>
                </button>
                 <button onclick="openReportModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded shadow flex items-center gap-2 transition text-sm">
                    <span data-i18n="reports_title">التقارير</span>
                </button>
                <button onclick="logout()" class="text-gray-500 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-400 text-sm underline px-2" data-i18n="logout">خروج</button>
            </div>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-end md:items-center mb-4 gap-4 bg-blue-50 dark:bg-gray-900 p-4 rounded-lg border border-blue-100 dark:border-gray-700">
            <div class="flex flex-wrap gap-4 items-end w-full md:w-auto">
                <div class="flex flex-col gap-1">
                    <label class="text-xs font-bold text-blue-800 dark:text-blue-300" data-i18n="shift_date">تاريخ الوردية:</label>
                    <div class="relative flex items-center">
                        <input type="date" id="currentDateInput" onchange="changeDate()" class="p-2 pl-8 border border-blue-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg text-lg font-bold text-gray-700 outline-none focus:ring-2 focus:ring-blue-500">
                         <!-- Up/Down arrows for date -->
                        <div class="absolute left-0 inset-y-0 flex flex-col border-r dark:border-r-gray-600 w-6 rounded-l overflow-hidden">
                            <button onclick="adjustDate(1)" class="h-1/2 hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 flex items-center justify-center border-b border-gray-300 dark:border-gray-600 transition-colors bg-white dark:bg-gray-700">
                                <i class="fa-solid fa-caret-up text-[10px]"></i>
                            </button>
                            <button onclick="adjustDate(-1)" class="h-1/2 hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 flex items-center justify-center transition-colors bg-white dark:bg-gray-700">
                                <i class="fa-solid fa-caret-down text-[10px]"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="shiftSelectorContainer" class="flex flex-col gap-1 hidden">
                    <label class="text-xs font-bold text-blue-800 dark:text-blue-300" data-i18n="lbl_shift">الوردية (تصفية):</label>
                    <select id="shiftFilter" onchange="applyShiftFilter()" class="p-2 border border-blue-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg font-bold text-gray-700 outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                        <option value="all" data-i18n="val_all_shifts">الكل</option>
                        <option value="shift_A" data-i18n="val_shift_a">الوردية A</option>
                        <option value="shift_B" data-i18n="val_shift_b">الوردية B</option>
                    </select>
                </div>

                <!-- NEW: Admin Viewer Control -->
                <div id="adminViewerControl" class="flex flex-col gap-1 hidden">
                    <label class="text-xs font-bold text-purple-800 dark:text-purple-300" data-i18n="lbl_viewer_control">عرض المحاسب:</label>
                    <select id="viewerPermission" onchange="updateViewerPermission(this.value)" class="p-2 border border-purple-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg font-bold text-purple-700 outline-none focus:ring-2 focus:ring-purple-500 bg-white">
                        <option value="all" data-i18n="val_all_shifts">الكل</option>
                        <option value="shift_A" data-i18n="val_shift_a">الوردية A</option>
                        <option value="shift_B" data-i18n="val_shift_b">الوردية B</option>
                    </select>
                </div>
                
                <div id="bulkControls" class="flex flex-wrap gap-2 items-end hidden">
                    <div class="flex flex-col items-center">
                        <button onclick="applyBulkAction('entry')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-t shadow text-xs font-bold w-full transition" data-i18n="bulk_entry">دخول جماعي</button>
                        <input type="tel" inputmode="numeric" pattern="[0-9]*" id="bulkEntryInput" placeholder="--:--" class="p-1 border border-green-300 dark:border-green-800 dark:bg-gray-700 dark:text-white rounded-b w-full text-center text-sm ltr placeholder-gray-400 focus:ring-2 focus:ring-green-500 outline-none" onchange="validateBulkInput(this)">
                    </div>
                    <div class="flex flex-col items-center">
                        <button onclick="applyBulkAction('exit')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-t shadow text-xs font-bold w-full transition" data-i18n="bulk_exit">خروج جماعي</button>
                        <input type="tel" inputmode="numeric" pattern="[0-9]*" id="bulkExitInput" placeholder="--:--" class="p-1 border border-blue-300 dark:border-blue-800 dark:bg-gray-700 dark:text-white rounded-b w-full text-center text-sm ltr placeholder-gray-400 focus:ring-2 focus:ring-blue-500 outline-none" onchange="validateBulkInput(this)">
                    </div>
                    <div class="flex flex-col items-center">
                        <button onclick="applyBulkAction('break')" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded-t shadow text-xs font-bold w-full transition" data-i18n="bulk_break">استراحة جماعية</button>
                        <input type="number" inputmode="decimal" id="bulkBreakInput" step="0.5" min="0" value="1" placeholder="1" class="p-1 border border-orange-300 dark:border-orange-700 dark:bg-gray-700 dark:text-white rounded-b w-full text-center text-sm font-bold focus:ring-2 focus:ring-orange-400 outline-none" style="-moz-appearance:textfield;">
                    </div>
                </div>
            </div>

            <div id="dayInfo" class="text-center hidden md:block">
                <span id="dayNameDisplay" class="text-xl font-bold text-blue-900 dark:text-blue-300 block">--</span>
                <span id="dateDisplay" class="text-sm text-blue-600 dark:text-blue-400">--</span>
            </div>

            <!-- Changed class to hidden by default, handled by JS -->
            <div id="adminControls" class="flex gap-2 hidden">
                <button onclick="openAddEmployeeModal()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded shadow text-sm transition flex items-center gap-1">
                    <span data-i18n="new_employee">+ موظف</span>
                </button>
            </div>
        </div>

        <div id="employeeStatsCard" class="hidden mb-4 bg-white dark:bg-gray-700 border-r-4 ltr:border-r-0 ltr:border-l-4 border-indigo-500 shadow-lg p-5 rounded-lg fade-in-down border border-gray-100 dark:border-gray-600"></div>

        <div class="table-container border bg-white dark:bg-gray-800 relative flex-grow dark:border-gray-700">
            <table class="w-full text-start border-collapse md:min-w-[1000px]">
                <thead>
                    <tr>
                        <th class="p-3 w-12 bg-blue-900 text-center">#</th>
                        <th class="p-3 w-48 bg-blue-900 text-start" data-i18n="th_name">اسم الموظف</th>
                        <th class="p-3 w-32 bg-blue-900 text-center" data-i18n="th_status">الحالة</th>
                        <th class="p-3 w-28 bg-blue-900 text-center" data-i18n="th_entry">دخول</th>
                        <th class="p-3 w-28 bg-blue-900 text-center" data-i18n="th_exit">خروج</th>
                        <th class="p-3 w-24 bg-blue-900 text-center" data-i18n="th_break">استراحة</th>
                        <th class="p-3 w-24 bg-blue-900 text-red-200 text-center" data-i18n="th_delay">تأخير</th>
                        <th class="p-3 w-24 bg-blue-900 text-center" data-i18n="th_overtime">إضافي</th>
                        <th class="p-3 bg-blue-900 text-center" data-i18n="th_notes">ملاحظات</th>
                        <th class="p-3 w-16 bg-blue-900 text-center delete-col" data-i18n="th_delete">حذف</th>
                    </tr>
                </thead>
                <tbody id="dailyTableBody" class="text-gray-700 dark:text-gray-300 text-sm font-medium"></tbody>
            </table>
            <div id="emptyState" class="hidden text-center p-8 text-gray-400 dark:text-gray-500" data-i18n="no_data">لا يوجد موظفين.</div>
        </div>

        <!-- تذييل التطبيق الرئيسي -->
        <div class="flex flex-col items-center gap-3 mt-8 mb-4" data-aos="zoom-in">
            <div id="devCardMain" class="mega-icon-card light-mode">
                <span>Developed by EMAD ALLAHAM</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, writeBatch, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const translations = {
            ar: {
                app_title: "سجل الورديات",
                login_title: "تسجيل الدخول",
                login_btn: "دخول",
                status_online: "متصل وجاهز للعمل",
                status_offline: "غير متصل",
                reports_title: "التقارير",
                logout: "خروج",
                shift_date: "تاريخ الوردية:",
                new_employee: "+ موظف",
                viewer_mode: "وضع المشاهدة",
                add_emp_title: "إضافة / تعديل موظف",
                save: "حفظ",
                cancel: "إلغاء",
                monthly_report: "التقرير الشهري",
                annual_report: "التقرير السنوي",
                btn_monthly_report: "شهري",
                btn_annual_report: "سنوي",
                lbl_year: "السنة",
                lbl_month: "الشهر",
                close: "إغلاق",
                export_excel: "تصدير Excel",
                th_name: "اسم الموظف",
                th_status: "الحالة",
                th_entry: "دخول",
                th_exit: "خروج",
                th_break: "استراحة",
                th_delay: "تأخير",
                th_overtime: "إضافي",
                th_notes: "ملاحظات",
                th_delete: "حذف",
                no_data: "لا يوجد موظفين مسجلين.",
                val_present: "حضور", val_absent: "غياب", val_vacation: "إجازة", val_holiday: "عطلة رسمية", val_sunday: "يوم الأحد", val_choose: "--",
                th_present: "حضور", th_absent: "غياب", th_vacation: "إجازة", th_holiday: "رسمية", th_sunday: "الأحد", th_total_overtime: "س.إضافي", th_total_delay: "س.تأخير",
                sum_title: "ملخص", sum_emp: "لـ", sum_days: "يوم", sum_hrs: "س",
                day_sunday: "الأحد", day_monday: "الإثنين", day_tuesday: "الثلاثاء", day_wednesday: "الأربعاء", day_thursday: "الخميس", day_friday: "الجمعة", day_saturday: "السبت",
                lbl_shift: "الوردية", val_all_shifts: "الكل",
                val_shift_a: "الوردية A", val_shift_b: "الوردية B",
                // تم إزالة كلمات المرور من هنا للأمان
                role_admin: "المدير العام", 
                role_shift_b_man: "مدير الوردية B فقط", 
                role_accountant: "المحاسب",
                data_btn: "بيانات", data_management: "إدارة البيانات",
                legacy_import_title: "📥 الانتقال من النظام القديم (V2)",
                legacy_import_desc: "اضغط هنا فقط إذا كنت تريد جلب الموظفين وبيانات الحضور من ملفات السنة الماضية.",
                btn_import_legacy: "استيراد الموظفين والسجلات",
                btn_backup_download: "تحميل نسخة احتياطية (JSON)",
                btn_restore_upload: "استعادة نسخة محفوظة",
                loading_processing: "جاري معالجة البيانات...",
                msg_wrong_code: "رمز خاطئ",
                msg_confirm_delete: "هل أنت متأكد من حذف هذا الموظف نهائياً؟",
                msg_confirm_restore: "تحذير: هذه العملية ستستبدل البيانات الحالية بالبيانات الموجودة في الملف. هل أنت متأكد؟",
                msg_restore_success: "تمت الاستعادة بنجاح! سيتم إعادة تحميل الصفحة.",
                msg_file_error: "خطأ في الملف: ",
                msg_import_confirm: "سيتم نقل الأسماء وسجلات الحضور من النظام القديم (2026) إلى النظام الجديد. العملية قد تأخذ ثوانٍ. هل أنت متأكد؟",
                msg_no_legacy_data: "لم يتم العثور على بيانات في النظام القديم لهذا العام.",
                msg_import_success: "تم استيراد موظفين جدد وتحديث السجلات بنجاح!",
                loading_importing: "جاري استيراد الأسماء والبيانات...",
                loading_backup: "جاري تحضير النسخة الاحتياطية...",
                loading_restoring: "جاري استعادة البيانات...",
                badge_shift_b: "الوردية B",
                ph_employee_name: "الاسم الثلاثي",
                bulk_entry: "دخول جماعي",
                bulk_exit: "خروج جماعي",
                bulk_break: "استراحة جماعية",
                btn_login_log: "سجل الدخول",
                log_modal_title: "سجل دخول المستخدمين",
                th_time: "الوقت والتاريخ",
                th_role: "الرتبة",
                th_device: "الجهاز",
                th_browser: "Tarayıcı",
                btn_recycle_bin: "المحذوفات",
                recycle_bin_title: "الموظفون المحذوفون",
                btn_restore: "استعادة",
                no_deleted_emp: "لا يوجد موظفين محذوفين.",
                deleted_at: "تاريخ الحذف: "
            },
            tr: {
                app_title: "Vardiya Sistemi",
                login_title: "Giriş",
                login_btn: "Giriş",
                status_online: "Bağlı ve Hazır",
                status_offline: "Bağlantı Yok",
                reports_title: "Raporlar",
                logout: "Çıkış",
                shift_date: "Tarih:",
                new_employee: "+ Personel",
                viewer_mode: "İzleme",
                add_emp_title: "Personel Ekle/Düzenle",
                save: "Kaydet",
                cancel: "İptal",
                monthly_report: "Aylık Rapor",
                annual_report: "Yıllık Rapor",
                btn_monthly_report: "Aylık",
                btn_annual_report: "Yıllık",
                lbl_year: "Yıl",
                lbl_month: "Ay",
                close: "Kapat",
                export_excel: "Excel",
                th_name: "Personel",
                th_status: "Durum",
                th_entry: "Giriş",
                th_exit: "Çıkış",
                th_break: "Mola",
                th_delay: "Gecikme",
                th_overtime: "Mesai",
                th_notes: "Not",
                th_delete: "Sil",
                no_data: "Kayıt yok.",
                val_present: "Mevcut", val_absent: "Yok", val_vacation: "İzinli", val_holiday: "R.Tatil", val_sunday: "Pazar", val_choose: "--",
                th_present: "Geldi", th_absent: "Gelmedi", th_vacation: "İzin", th_holiday: "R.Tatil", th_sunday: "Pazar", th_total_overtime: "Mesai", th_total_delay: "Gecikme",
                sum_title: "Özet", sum_emp: "Personel:", sum_days: "Gün", sum_hrs: "S",
                day_sunday: "Pazar", day_monday: "Pazartesi", day_tuesday: "Salı", day_wednesday: "Çarşamba", day_thursday: "Perşembe", day_friday: "Cuma", day_saturday: "Cumartesi",
                lbl_shift: "Vardiya", val_all_shifts: "Tümü",
                val_shift_a: "Vardiya A", val_shift_b: "Vardiya B",
                // Passwords removed here for security
                role_admin: "Genel Müdür", 
                role_shift_b_man: "Sadece B Vardiya Müdürü", 
                role_accountant: "Muhasebeci",
                data_btn: "Veri", data_management: "Veri Yönetimi",
                legacy_import_title: "📥 Eski Sistemden Geçiş (V2)",
                legacy_import_desc: "Bu butonu sadece geçen yılın dosyalarından personel ve devam verilerini getirmek istiyorsanız kullanın.",
                btn_import_legacy: "Personel ve Kayıtları İçe Aktar",
                btn_backup_download: "Yedek İndir (JSON)",
                btn_restore_upload: "Yedeği Geri Yükle",
                loading_processing: "Veriler işleniyor...",
                msg_wrong_code: "Hatalı Kod",
                msg_confirm_delete: "Bu personeli silmek istediğinizden emin misiniz? (Geri Dönüşüm Kutusuna taşınacak)",
                msg_confirm_restore: "Uyarı: Bu işlem mevcut verileri dosyadaki verilerle değiştirecektir. Emin misiniz?",
                msg_restore_success: "Geri yükleme başarılı! Sayfa yenilenecek.",
                msg_file_error: "Dosya hatası: ",
                msg_import_confirm: "İsimler ve devam kayıtları eski sistemden (2026) yeni sisteme aktarılacak. İşlem birkaç saniye sürebilir. Emin misiniz?",
                msg_no_legacy_data: "Bu yıl için eski sistemde veri bulunamadı.",
                msg_import_success: "Yeni personeller içe aktarıldı ve kayıtlar başarıyla güncellendi!",
                loading_importing: "İsimler ve veriler içe aktarılıyor...",
                loading_backup: "Yedek hazırlanıyor...",
                loading_restoring: "Veriler geri yükleniyor...",
                badge_shift_b: "Vardiya B",
                ph_employee_name: "Ad Soyad",
                bulk_entry: "Toplu Giriş",
                bulk_exit: "Toplu Çıkış",
                bulk_break: "Toplu Mola",
                btn_login_log: "Giriş Kaydı",
                log_modal_title: "Kullanıcı Giriş Kaydı",
                th_time: "Tarih ve Saat",
                th_role: "Rol",
                th_device: "Cihaz",
                th_browser: "Tarayıcı",
                btn_recycle_bin: "Geri Dönüşüm Kutusu",
                recycle_bin_title: "Silinen Personel",
                btn_restore: "Geri Yükle",
                no_deleted_emp: "Silinen personel yok.",
                deleted_at: "Silinme Tarihi: "
            }
        };

        const browserLang = navigator.language || navigator.userLanguage || 'ar';
        let currentLang = browserLang.startsWith('ar') ? 'ar' : 'tr';

        function t(key) { return translations[currentLang][key] || key; }
        
        window.changeLanguage = function(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            
            // Toggle Logic visual update
            const knob = document.getElementById('lang-knob');
            const labelAr = document.getElementById('label-ar');
            const labelTr = document.getElementById('label-tr');
            
            if (lang === 'ar') {
                // Move knob to Right (AR side)
                knob.classList.remove('translate-x-0');
                knob.classList.add('translate-x-6');
                
                // Highlight AR label
                labelAr.classList.remove('opacity-50', 'grayscale');
                labelAr.classList.add('opacity-100');
                
                // Dim TR label
                labelTr.classList.add('opacity-50', 'grayscale');
                labelTr.classList.remove('opacity-100');
            } else {
                // Move knob to Left (TR side)
                knob.classList.remove('translate-x-6');
                knob.classList.add('translate-x-0');
                
                // Highlight TR label
                labelTr.classList.remove('opacity-50', 'grayscale');
                labelTr.classList.add('opacity-100');
                
                // Dim AR label
                labelAr.classList.add('opacity-50', 'grayscale');
                labelAr.classList.remove('opacity-100');
            }
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) el.innerText = translations[lang][key];
            });

            document.querySelectorAll('[data-i18n-ph]').forEach(el => {
                const key = el.getAttribute('data-i18n-ph');
                if (translations[lang][key]) el.placeholder = translations[lang][key];
            });

            renderDailyTable();
        };

        window.toggleLanguageSwitch = function() {
            const newLang = currentLang === 'ar' ? 'tr' : 'ar';
            changeLanguage(newLang);
        };

        // Password Visibility Toggle
        window.togglePasswordVisibility = function() {
            const input = document.getElementById('accessCode');
            const icon  = document.getElementById('eyeIcon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            }
        };

        // Dark Mode Logic
        window.toggleDarkMode = function() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            const icons = document.querySelectorAll('.theme-toggle-icon');
            const devCardMain = document.getElementById('devCardMain');
            
            if (isDark) {
                icons.forEach(icon => {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                });
                localStorage.setItem('theme', 'dark');
                // Remove light-mode class to enable the dark glass effect
                devCardMain.classList.remove('light-mode');
            } else {
                icons.forEach(icon => {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                });
                localStorage.setItem('theme', 'light');
                // Add light-mode class for white background
                devCardMain.classList.add('light-mode');
            }
        };

        // Init Dark Mode
        const savedTheme = localStorage.getItem('theme');
        const icons = document.querySelectorAll('.theme-toggle-icon');
        if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark');
            icons.forEach(icon => {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            });
            document.getElementById('devCardMain').classList.remove('light-mode');
        } else {
            document.documentElement.classList.remove('dark');
            icons.forEach(icon => {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            });
            document.getElementById('devCardMain').classList.add('light-mode');
        }


        let firebaseConfig;
        let appId = 'cloud-shift-register';
        
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            if(typeof __app_id !== 'undefined' && __app_id) appId = __app_id;
        } else {
            firebaseConfig = {
                apiKey: "AIzaSyDzRczKA0tVr57TVFmnrr3F57REDTF4xHQ",
                authDomain: "cloud-shift-register.firebaseapp.com",
                projectId: "cloud-shift-register",
                storageBucket: "cloud-shift-register.firebasestorage.app",
                messagingSenderId: "823312208352",
                appId: "1:823312208352:web:fc0889a737e58482ce1b85"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userRole = '';
        let currentUserShift = 'all'; 
        let currentSelectedShift = 'all'; 
        let viewerPermissionFilter = 'all'; // What the admin sets for the viewer
        
        let masterEmployees = {}; 
        let currentMonthData = {}; 
        let loadedYearMonth = ''; 

        const EMPLOYEES_DOC = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'employees');
        const GLOBAL_SETTINGS_DOC = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global_config');
        const LOGS_DOC = doc(db, 'artifacts', appId, 'public', 'data', 'logs', 'access_history');
        const getMonthDoc = (year, month) => doc(db, 'artifacts', appId, 'public', 'data', 'months', `data_${year}_${month}`);
        const getLegacyYearDoc = (year) => doc(db, 'attendance_data', firebaseConfig.projectId === 'YOUR_PROJECT_ID' ? 'demo-app' : firebaseConfig.projectId, 'years', `data_${year}`);

        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                document.getElementById('loadingText').innerText = "خطأ في الاتصال: " + error.message;
            }
        }
        initAuth();

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        function updateOnlineStatus() {
            const isOnline = navigator.onLine;
            const dot = document.getElementById('connectionDot');
            const text = document.getElementById('connectionText');
            
            if (isOnline) {
                dot.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
                text.className = "text-green-600 dark:text-green-400 text-xs font-bold";
                text.innerText = t('status_online');
                text.setAttribute('data-i18n', 'status_online');
            } else {
                dot.className = "w-2 h-2 rounded-full bg-red-500";
                text.className = "text-red-600 dark:text-red-400 text-xs font-bold";
                text.innerText = t('status_offline');
                text.setAttribute('data-i18n', 'status_offline');
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

        window.checkLogin = async function() {
            const code = document.getElementById('accessCode').value;
            const errorMsg = document.getElementById('loginError');
            
            const hashedCode = await sha256(code);
            
            const HASH_ADMIN = "c4a23934ebf78c703d11dae9ecb3bef502d930d585f53a2547d87e5099887729"; 
            const HASH_SHIFT_B = "edee29f882543b956620b26d0ee0e7e950399b1c4222f5de05e06425b4c995e9";
            const HASH_VIEWER = "d9cf8835e2a75f03b59e0371aacb3cdf2b71e0a471dc478742987f366cabeccc";

            document.getElementById('shiftSelectorContainer').classList.add('hidden');
            document.getElementById('dataBtn').classList.add('hidden');
            document.getElementById('shiftBadge').classList.add('hidden');
            document.getElementById('bulkControls').classList.add('hidden'); 
            document.getElementById('adminViewerControl').classList.add('hidden');
            
            let detectedRole = '';

            if (hashedCode === HASH_ADMIN) {
                userRole = 'admin';
                detectedRole = 'Admin';
                currentUserShift = 'all';
                document.getElementById('shiftSelectorContainer').classList.remove('hidden');
                document.getElementById('adminViewerControl').classList.remove('hidden'); 
                document.getElementById('dataBtn').classList.remove('hidden');
                document.getElementById('bulkControls').classList.remove('hidden'); 
                
                // Show Admin Only Buttons for Logs
                document.getElementById('btnExportLog').classList.remove('hidden');
                document.getElementById('btnClearLog').classList.remove('hidden');
                
                // Show Admin Controls (+ موظف)
                document.getElementById('adminControls').classList.remove('hidden');

                // Fetch current viewer permission setting
                getDoc(GLOBAL_SETTINGS_DOC).then(snap => {
                    if (snap.exists() && snap.data().viewerPermission) {
                        document.getElementById('viewerPermission').value = snap.data().viewerPermission;
                    }
                });

            } else if (hashedCode === HASH_SHIFT_B) {
                userRole = 'shift_b_manager';
                detectedRole = 'Shift B Manager';
                currentUserShift = 'shift_B';
                document.getElementById('shiftBadge').classList.remove('hidden');
                document.getElementById('shiftBadge').innerText = t('badge_shift_b');
                document.getElementById('bulkControls').classList.remove('hidden');
                
                // Hide Admin Controls (+ موظف) for Shift B
                document.getElementById('adminControls').classList.add('hidden'); 
                
            } else if (hashedCode === HASH_VIEWER) {
                userRole = 'viewer';
                detectedRole = 'Accountant/Viewer';
                currentUserShift = 'all';
                
                // Ensure adminControls is visible container, but content replaced by setupViewerUI
                document.getElementById('adminControls').classList.remove('hidden');
                setupViewerUI();
                listenToViewerPermission();
            } else {
                errorMsg.classList.remove('hidden');
                return;
            }

            // Log the successful login
            logAccess(detectedRole);

            document.getElementById('loadingScreen').classList.remove('hidden');
            
            const unsubEmp = onSnapshot(EMPLOYEES_DOC, (snap) => {
                if (snap.exists()) {
                    masterEmployees = snap.data().list || {};
                } else {
                    masterEmployees = {};
                }
                renderDailyTable();
            });

            const today = new Date();
            const dateInput = document.getElementById('currentDateInput');
            dateInput.value = today.toISOString().split('T')[0];
            
            changeDate();

            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
        };

        // Modified Log Access Function - Limit 20 and handles actions
        async function logAccess(role, action = null) {
            try {
                const now = new Date();
                const timestamp = now.toLocaleString('en-GB'); // DD/MM/YYYY, HH:MM:SS
                const userAgent = navigator.userAgent;
                const isMobile = /iPhone|iPad|iPod|Android/i.test(userAgent);
                const device = isMobile ? 'Mobile' : 'Desktop';
                
                let browser = 'Unknown';
                if(userAgent.indexOf("Chrome") != -1 && userAgent.indexOf("Edg") == -1) browser = 'Chrome';
                else if(userAgent.indexOf("Safari") != -1 && userAgent.indexOf("Chrome") == -1) browser = 'Safari';
                else if(userAgent.indexOf("Firefox") != -1) browser = 'Firefox';
                else if(userAgent.indexOf("Edg") != -1) browser = 'Edge';

                // If action is provided, append it to role for display purposes
                // Or store it separately. Here we keep it simple for the existing table structure
                let displayRole = role;
                if (action) {
                    displayRole = `${role} (${action})`;
                }

                const newEntry = {
                    role: displayRole,
                    time: timestamp,
                    device: device,
                    browser: browser,
                    agent: userAgent
                };

                const snap = await getDoc(LOGS_DOC);
                let history = [];
                if (snap.exists()) {
                    history = snap.data().entries || [];
                }

                history.unshift(newEntry);
                
                // REDUCED LIMIT TO 20
                if (history.length > 20) {
                    history = history.slice(0, 20);
                }

                await setDoc(LOGS_DOC, { entries: history }, { merge: true });

            } catch (e) {
                console.error("Logging failed", e);
            }
        }

        window.viewLoginLogs = async function() {
            const tbody = document.getElementById('loginLogTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4"><div class="loader mx-auto"></div></td></tr>';
            
            toggleModal('loginLogOverlay', true);

            try {
                const snap = await getDoc(LOGS_DOC);
                if (snap.exists() && snap.data().entries) {
                    const logs = snap.data().entries;
                    tbody.innerHTML = '';
                    
                    if(logs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">No logs found.</td></tr>';
                        return;
                    }

                    logs.forEach(log => {
                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition border-b dark:border-gray-700";
                        
                        let roleColor = 'text-gray-700';
                        if(log.role.includes('Admin')) roleColor = 'text-red-600 font-bold';
                        if(log.role.includes('Shift B')) roleColor = 'text-blue-600';
                        if(log.role.includes('Accountant')) roleColor = 'text-orange-600';

                        tr.innerHTML = `
                            <td class="p-3 ${roleColor} text-xs md:text-sm border-l dark:border-gray-600">${log.role}</td>
                            <td class="p-3 text-center ltr font-mono text-xs md:text-sm border-l dark:border-gray-600 text-gray-600 dark:text-gray-300">${log.time}</td>
                            <td class="p-3 text-center text-xs md:text-sm border-l dark:border-gray-600">${log.device === 'Mobile' ? '📱' : '💻'} <span class="hidden md:inline">${log.device}</span></td>
                            <td class="p-3 text-start text-xs md:text-sm text-gray-500 truncate max-w-[100px] md:max-w-none" title="${log.agent}">
                                ${log.browser}
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">No logs found.</td></tr>';
                }
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-red-500">Error: ${e.message}</td></tr>`;
            }
        };

        window.clearLoginLogs = async function() {
            if (!confirm("هل أنت متأكد من مسح سجل الدخول بالكامل؟")) return;
            try {
                await setDoc(LOGS_DOC, { entries: [] });
                viewLoginLogs(); // Refresh
            } catch (e) {
                alert("Error clearing logs: " + e.message);
            }
        };

        window.exportLoginLogs = async function() {
            try {
                const snap = await getDoc(LOGS_DOC);
                if (!snap.exists() || !snap.data().entries) {
                    alert("No logs to export");
                    return;
                }
                const logs = snap.data().entries;
                
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
                csvContent += "Role,Time,Device,Browser,UserAgent\n";
                
                logs.forEach(log => {
                    const row = `"${log.role}","${log.time}","${log.device}","${log.browser}","${log.agent}"`;
                    csvContent += row + "\n";
                });

                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", "access_logs.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (e) {
                alert("Export failed: " + e.message);
            }
        };

        function setupViewerUI() {
            document.getElementById('adminControls').innerHTML = 
                `<div class="bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200 px-3 py-2 rounded border border-orange-200 dark:border-orange-800 font-bold text-sm">${t('viewer_mode')}</div>`;
            const style = document.createElement('style');
            style.innerHTML = '.delete-col { display: none; }';
            document.head.appendChild(style);
        }

        window.updateViewerPermission = async function(val) {
            try {
                await setDoc(GLOBAL_SETTINGS_DOC, { viewerPermission: val }, { merge: true });
            } catch (e) {
                console.error("Error saving permission", e);
            }
        };

        function listenToViewerPermission() {
             onSnapshot(GLOBAL_SETTINGS_DOC, (snap) => {
                if (snap.exists()) {
                    const perm = snap.data().viewerPermission || 'all';
                    const selector = document.getElementById('shiftSelectorContainer');
                    const filter = document.getElementById('shiftFilter');

                    if (perm === 'all') {
                        selector.classList.remove('hidden');
                        if (filter.value === '' || filter.value === 'all') {
                             currentSelectedShift = 'all';
                             filter.value = 'all';
                        }
                    } else {
                        selector.classList.add('hidden');
                        currentSelectedShift = perm;
                        filter.value = perm; 
                    }
                    renderDailyTable();
                }
            });
        }

        window.logout = function() { location.reload(); };

        let unsubscribeMonth = null;

        window.changeDate = function() {
            const dateStr = document.getElementById('currentDateInput').value;
            if(!dateStr) return;
            
            const dateObj = new Date(dateStr);
            const daysKey = ['day_sunday', 'day_monday', 'day_tuesday', 'day_wednesday', 'day_thursday', 'day_friday', 'day_saturday'];
            document.getElementById('dayNameDisplay').innerText = t(daysKey[dateObj.getDay()]);
            document.getElementById('dateDisplay').innerText = dateStr;

            const year = dateStr.split('-')[0];
            const month = dateStr.split('-')[1];
            const yearMonth = `${year}_${month}`;

            if (loadedYearMonth !== yearMonth) {
                loadMonthData(year, month);
            } else {
                renderDailyTable();
            }
        };

        window.adjustDate = function(days) {
            const input = document.getElementById('currentDateInput');
            if (!input.value) return;
            const date = new Date(input.value);
            date.setDate(date.getDate() + days);
            input.value = date.toISOString().split('T')[0];
            changeDate();
        };

        function loadMonthData(year, month) {
            if (unsubscribeMonth) unsubscribeMonth();
            
            document.getElementById('loadingText').innerText = t('loading_processing');
            document.getElementById('loadingScreen').classList.remove('hidden');
            loadedYearMonth = `${year}_${month}`;
            
            const monthDocRef = getMonthDoc(year, month);
            
            unsubscribeMonth = onSnapshot(monthDocRef, (snap) => {
                document.getElementById('loadingScreen').classList.add('hidden');
                if (snap.exists()) {
                    currentMonthData = snap.data().records || {};
                } else {
                    currentMonthData = {};
                }
                renderDailyTable();
            });
        }

        window.applyShiftFilter = function() {
            currentSelectedShift = document.getElementById('shiftFilter').value;
            renderDailyTable();
        };

        window.validateBulkInput = function(input) {
            let val = input.value.trim();
            if (!val) return;
            val = val.replace(/[^0-9:]/g, '');
            if (val.indexOf(':') === -1) {
                if (val.length <= 2) {
                    let hour = parseInt(val);
                    if (hour >= 0 && hour <= 23) val = val.padStart(2, '0') + ":00";
                } else if (val.length === 3) {
                    val = "0" + val.substring(0, 1) + ":" + val.substring(1);
                } else if (val.length === 4) {
                    val = val.substring(0, 2) + ":" + val.substring(2);
                }
            }
            if (/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(val)) {
                input.value = val;
            } else {
                input.value = ''; 
            }
        };

        window.applyBulkAction = async function(actionType) {
            const dateStr = document.getElementById('currentDateInput').value;
            const year = dateStr.split('-')[0];
            const month = dateStr.split('-')[1];
            
            let timeValue = '';
            if (actionType === 'entry') {
                timeValue = document.getElementById('bulkEntryInput').value;
            } else if (actionType === 'exit') {
                timeValue = document.getElementById('bulkExitInput').value;
            } else if (actionType === 'break') {
                timeValue = document.getElementById('bulkBreakInput').value || '1';
            }

            if (actionType !== 'break' && !timeValue) {
                alert("الرجاء إدخال توقيت صحيح أولاً");
                return;
            }

            let targetEmployees = [];
            
            Object.entries(masterEmployees).forEach(([id, data]) => {
                let shouldInclude = false;
                if (userRole === 'shift_b_manager') {
                    if (data.shift === 'shift_B') shouldInclude = true;
                } else if (userRole === 'admin') {
                    if (currentSelectedShift === 'all') shouldInclude = true;
                    else if (data.shift === currentSelectedShift) shouldInclude = true;
                }

                if (shouldInclude) {
                    targetEmployees.push(id);
                }
            });

            if (targetEmployees.length === 0) return;

            document.getElementById('loadingText').innerText = "جاري تنفيذ الإجراء الجماعي...";
            document.getElementById('loadingScreen').classList.remove('hidden');

            const updates = {};
            
            targetEmployees.forEach(empId => {
                const recordPath = `records.${empId}.${dateStr}`;
                
                if (!currentMonthData[empId]) currentMonthData[empId] = {};
                if (!currentMonthData[empId][dateStr]) currentMonthData[empId][dateStr] = {};
                
                // Statuses that are "locked" — bulk actions must never override them
                const LOCKED_STATUSES = ['absent', 'vacation'];
                const currentStatus = (currentMonthData[empId][dateStr] || {}).status;
                const isLocked = LOCKED_STATUSES.includes(currentStatus);

                if (actionType === 'break') {
                    // Break: only apply to employees who are already present
                    if (currentStatus !== 'present') return;
                    updates[`${recordPath}.breakDuration`] = timeValue;
                    currentMonthData[empId][dateStr].breakDuration = timeValue;
                } else {
                    // Entry / Exit: skip any employee with a locked status
                    if (isLocked) return;
                    updates[`${recordPath}.status`] = 'present';
                    currentMonthData[empId][dateStr].status = 'present';

                    if (actionType === 'entry') {
                        updates[`${recordPath}.entry`] = timeValue;
                        updates[`${recordPath}.breakDuration`] = '0.5';
                        currentMonthData[empId][dateStr].entry = timeValue;
                        currentMonthData[empId][dateStr].breakDuration = '0.5';
                    } else {
                        updates[`${recordPath}.exit`] = timeValue;
                        currentMonthData[empId][dateStr].exit = timeValue;
                    }
                }
            });

            try {
                const docRef = getMonthDoc(year, month);
                await updateDoc(docRef, updates);
                renderDailyTable();
            } catch (e) {
                try {
                    const docRef = getMonthDoc(year, month);
                    const deepObj = { records: {} };
                    targetEmployees.forEach(empId => {
                        deepObj.records[empId] = { [dateStr]: currentMonthData[empId][dateStr] };
                    });
                    await setDoc(docRef, deepObj, { merge: true });
                    renderDailyTable();
                } catch (err) {
                    console.error("Bulk update failed", err);
                    alert("حدث خطأ أثناء التحديث الجماعي");
                }
            } finally {
                document.getElementById('loadingScreen').classList.add('hidden');
                if (actionType === 'entry') document.getElementById('bulkEntryInput').value = '';
                else if (actionType === 'exit') document.getElementById('bulkExitInput').value = '';
                // break select stays at last value (intentional UX)
            }
        };

        let dragSrcEl = null;

        window.handleDragStart = function(e) {
            if (userRole !== 'admin') return;
            // Block drag only when the click target itself is an interactive element
            // This allows dragging from the name cell or empty space, but not from inputs/buttons
            const tag = e.target.tagName;
            if (['INPUT','SELECT','TEXTAREA','BUTTON'].includes(tag)) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
            this.classList.add('dragging');
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.getAttribute('data-emp-id'));
        };

        window.handleDragOver = function(e) {
            if (e.preventDefault) e.preventDefault();
            if (userRole !== 'admin') return;
            this.classList.add('drag-over');
            e.dataTransfer.dropEffect = 'move';
            return false;
        };

        window.handleDragLeave = function(e) {
            this.classList.remove('drag-over');
        };

        window.handleDrop = function(e) {
            if (e.stopPropagation) e.stopPropagation();
            if (dragSrcEl === this || userRole !== 'admin') return;

            this.classList.remove('drag-over');
            dragSrcEl.classList.remove('dragging');

            const sourceId = e.dataTransfer.getData('text/plain');
            const targetId = this.getAttribute('data-emp-id');
            
            reorderEmployees(sourceId, targetId);

            return false;
        };

        async function reorderEmployees(sourceId, targetId) {
            let empArray = Object.entries(masterEmployees).map(([id, data]) => ({
                id: id,
                ...data,
                order: data.order || 9999
            })).sort((a, b) => (a.order || 0) - (b.order || 0) || a.name.localeCompare(b.name));

            const sourceIndex = empArray.findIndex(e => e.id === sourceId);
            const targetIndex = empArray.findIndex(e => e.id === targetId);

            if (sourceIndex > -1 && targetIndex > -1) {
                const [movedItem] = empArray.splice(sourceIndex, 1);
                empArray.splice(targetIndex, 0, movedItem);

                const updates = {};
                empArray.forEach((emp, index) => {
                    const newOrder = index + 1;
                    masterEmployees[emp.id].order = newOrder;
                    updates[`list.${emp.id}.order`] = newOrder;
                });

                renderDailyTable();
                
                try {
                    await updateDoc(EMPLOYEES_DOC, updates);
                } catch (e) {
                    console.error("Order save failed", e);
                }
            }
        }

        // Add this helper function to prevent XSS and HTML breaking
        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        window.renderDailyTable = function() {
            const tbody = document.getElementById('dailyTableBody');
            tbody.innerHTML = '';
            
            const dateStr = document.getElementById('currentDateInput').value;
            if (!dateStr) return;

            // SOFT DELETE & CREATION DATE LOGIC: Check Date Visibility
            const selectedDate = new Date(dateStr);

            let empArray = Object.entries(masterEmployees).map(([id, data]) => ({
                id: id,
                name: data.name,
                shift: data.shift || 'shift_A',
                order: data.order || 9999,
                deleted: data.deleted || false,
                deletedAt: data.deletedAt || null,
                createdAt: data.createdAt || null
            }));

            // Filter Logic
            empArray = empArray.filter(e => {
                // 1. Hide if selected date is BEFORE employee creation date
                if (e.createdAt) {
                    // Convert createdAt to Date object (YYYY-MM-DD) for comparison
                    const creationDate = new Date(e.createdAt.split('T')[0]);
                    const currentViewDate = new Date(dateStr);
                    // If viewing a date strictly BEFORE creation, hide
                    if (currentViewDate < creationDate) {
                        return false;
                    }
                }

                // 2. Hide if deleted AND selected date is AFTER end of deletion month
                if (e.deleted && e.deletedAt) {
                    const deletionDate = new Date(e.deletedAt);
                    const endOfDeletionMonth = new Date(deletionDate.getFullYear(), deletionDate.getMonth() + 1, 0); // last day of month
                    
                    if (selectedDate > endOfDeletionMonth) {
                        return false; 
                    }
                }
                return true; 
            });

            if (userRole === 'shift_b_manager') {
                empArray = empArray.filter(e => e.shift === 'shift_B');
            } else if ((userRole === 'admin' || userRole === 'viewer') && currentSelectedShift !== 'all') {
                empArray = empArray.filter(e => e.shift === currentSelectedShift);
            }

            empArray.sort((a, b) => (a.order || 0) - (b.order || 0) || a.name.localeCompare(b.name));

            if (empArray.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }
            document.getElementById('emptyState').classList.add('hidden');

            empArray.forEach((emp, index) => {
                const empId = emp.id;
                const empName = emp.name;
                
                const empMonthRecord = currentMonthData[empId] || {};
                const dayData = empMonthRecord[dateStr] || { status: '', entry: '', exit: '', breakDuration: '0', shortage: '', overtime: '', notes: '' };

                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 dark:hover:bg-gray-700 border-b transition duration-150";
                
                // Mark deleted rows visually
                if (emp.deleted) {
                    tr.classList.add('bg-gray-100', 'dark:bg-gray-800', 'opacity-75');
                }

                if (userRole === 'admin') {
                    tr.setAttribute('draggable', 'true');
                    tr.classList.add('draggable-row');
                    tr.setAttribute('data-emp-id', empId);
                    tr.addEventListener('dragstart', handleDragStart);
                    tr.addEventListener('dragover', handleDragOver);
                    tr.addEventListener('dragleave', handleDragLeave);
                    tr.addEventListener('drop', handleDrop);
                }

                if(dayData.status === 'absent') tr.classList.add('bg-red-50', 'dark:bg-red-900/20');
                if(dayData.status === 'vacation') tr.classList.add('bg-yellow-50', 'dark:bg-yellow-900/20');
                if(dayData.status === 'present') tr.classList.add('bg-green-50', 'dark:bg-green-900/20');
                if(dayData.status === 'holiday') tr.classList.add('status-holiday');
                if(dayData.status === 'sunday') tr.classList.add('status-sunday');

                const isViewer = userRole === 'viewer';
                // Also freeze inputs if employee is deleted
                const isInputsFrozen = emp.deleted || !dayData.status || (dayData.status !== 'present' && dayData.status !== 'holiday' && dayData.status !== 'sunday');
                const inputsDisabled = isInputsFrozen || isViewer ? 'disabled' : '';
                const isDisabled = isViewer || emp.deleted ? 'disabled' : '';

                const dragIcon = userRole === 'admin' ? '<span class="drag-handle" title="اسحب لإعادة الترتيب">☰</span>' : '';

                // Use escapeHtml for user-input fields
                const escapedName = escapeHtml(empName);
                const escapedNotes = escapeHtml(dayData.notes || '');
                
                // Add (Deleted) indicator if applicable
                const displayName = emp.deleted ? `<span class="text-red-500 line-through">${escapedName}</span>` : escapedName;

                tr.innerHTML = `
                    <td class="p-3 text-center text-gray-500 dark:text-gray-400 flex justify-center items-center" data-label="#" data-label-type="index">
                        ${index + 1} ${dragIcon}
                    </td>
                    <td class="p-3 font-bold text-gray-800 dark:text-gray-200 cursor-pointer hover:bg-blue-50 dark:hover:bg-gray-700 transition-colors select-none group relative" 
                        onclick="showEmployeeSummary('${empId}')" 
                        data-label="${t('th_name')}" data-label-type="name">
                        <span class="hover:text-blue-600 dark:hover:text-blue-400">${displayName}</span>
                        ${userRole === 'admin' && !emp.deleted ? `
                        <span class="admin-name-actions opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="event.stopPropagation(); openEditEmployeeModal('${empId}')" class="action-btn" title="تعديل الاسم">✎</button>
                            <button onclick="event.stopPropagation(); openTransferShiftModal('${empId}')" class="action-btn" title="نقل الوردية">🔄</button>
                        </span>
                        ` : ''}
                    </td>
                    
                    <td class="p-3" data-label="${t('th_status')}">
                        <select onchange="saveData('${empId}', '${dateStr}', 'status', this.value)" ${isDisabled}
                                class="w-full p-2 border rounded bg-white dark:bg-gray-700 text-sm focus:ring-2 focus:ring-blue-400 outline-none cursor-pointer border-gray-200 dark:border-gray-600 dark:text-white">
                            <option value="">${t('val_choose')}</option>
                            <option value="present" ${dayData.status === 'present' ? 'selected' : ''}>${t('val_present')}</option>
                            <option value="sunday" ${dayData.status === 'sunday' ? 'selected' : ''}>${t('val_sunday')}</option>
                            <option value="absent" ${dayData.status === 'absent' ? 'selected' : ''}>${t('val_absent')}</option>
                            <option value="vacation" ${dayData.status === 'vacation' ? 'selected' : ''}>${t('val_vacation')}</option>
                            <option value="holiday" ${dayData.status === 'holiday' ? 'selected' : ''}>${t('val_holiday')}</option>
                        </select>
                    </td>

                    <td class="p-3" data-label="${t('th_entry')}">
                        <input type="tel" inputmode="numeric" pattern="[0-9]*" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" value="${dayData.entry || ''}" placeholder="--:--" onchange="handleSmartTimeInput(this, '${empId}', '${dateStr}', 'entry')" ${inputsDisabled} class="w-full p-2 border rounded bg-white dark:bg-gray-700 text-sm text-center ltr placeholder-gray-300 dark:placeholder-gray-500 border-gray-200 dark:border-gray-600 dark:text-white">
                    </td>
                    <td class="p-3" data-label="${t('th_exit')}">
                        <input type="tel" inputmode="numeric" pattern="[0-9]*" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" value="${dayData.exit || ''}" placeholder="--:--" onchange="handleSmartTimeInput(this, '${empId}', '${dateStr}', 'exit')" ${inputsDisabled} class="w-full p-2 border rounded bg-white dark:bg-gray-700 text-sm text-center ltr placeholder-gray-300 dark:placeholder-gray-500 border-gray-200 dark:border-gray-600 dark:text-white">
                    </td>
                    <td class="p-3" data-label="${t('th_break')}">
                        <select onchange="saveData('${empId}', '${dateStr}', 'breakDuration', this.value)" ${inputsDisabled} class="w-full p-2 border rounded bg-white dark:bg-gray-700 text-sm text-center border-gray-200 dark:border-gray-600 dark:text-white">
                            <option value="0" ${(dayData.breakDuration||'0')==='0'?'selected':''}>0</option>
                            <option value="0.5" ${(dayData.breakDuration||'0')==='0.5'?'selected':''}>0.5</option>
                            <option value="1" ${(dayData.breakDuration||'')==='1'?'selected':''}>1</option>
                            <option value="1.5" ${(dayData.breakDuration||'')==='1.5'?'selected':''}>1.5</option>
                            <option value="2" ${(dayData.breakDuration||'')==='2'?'selected':''}>2</option>
                        </select>
                    </td>
                    <td class="p-3" data-label="${t('th_delay')}">
                        <input type="number" inputmode="decimal" autocomplete="off" step="0.5" max="0" value="${dayData.shortage || ''}" onchange="if(this.value > 0) this.value = -this.value; saveData('${empId}', '${dateStr}', 'shortage', this.value)" ${inputsDisabled} class="w-full p-2 border rounded bg-white dark:bg-gray-700 text-sm text-center text-red-600 dark:text-red-400 placeholder-red-300 dark:placeholder-red-900 border-gray-200 dark:border-gray-600" placeholder="-">
                    </td>
                    <td class="p-3" data-label="${t('th_overtime')}">
                        <input type="number" inputmode="decimal" autocomplete="off" step="0.5" value="${dayData.overtime || ''}" onchange="saveData('${empId}', '${dateStr}', 'overtime', this.value)" ${inputsDisabled} class="w-full p-2 border rounded bg-white dark:bg-gray-700 text-sm text-center border-gray-200 dark:border-gray-600 dark:text-white" placeholder="0">
                    </td>
                    <td class="p-3" data-label="${t('th_notes')}">
                        <input 
                            type="text" 
                            autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
                            value="${escapedNotes}" 
                            title="${escapedNotes}" 
                            dir="ltr"
                            onchange="saveData('${empId}', '${dateStr}', 'notes', this.value)" 
                            ${isDisabled} 
                            class="note-input w-full p-2 border rounded bg-white dark:bg-gray-700 text-sm border-gray-200 dark:border-gray-600 text-red-600 dark:text-red-400 font-bold text-left focus:bg-red-50 dark:focus:bg-red-900/10 transition-colors placeholder-red-200 dark:placeholder-red-900" 
                            placeholder="..."
                        >
                    </td>
                    
                    ${userRole === 'admin' ? 
                    `<td class="p-3 text-center delete-col" data-label="${t('th_delete')}"><button onclick="deleteEmployee('${empId}')" class="text-red-400 hover:text-red-700 font-bold px-2">${emp.deleted ? '⟳' : '×'}</button></td>` 
                    : '<td class="p-3"></td>'}
                `;
                tbody.appendChild(tr);
            });
        };

        window.saveData = async function(empId, date, field, value) {
            if (userRole === 'viewer') return;
            const year = date.split('-')[0];
            const month = date.split('-')[1];
            
            if (!currentMonthData[empId]) currentMonthData[empId] = {};
            if (!currentMonthData[empId][date]) currentMonthData[empId][date] = {};
            currentMonthData[empId][date][field] = value;

            const record = currentMonthData[empId][date];
            if (field === 'status') {
                if (value === '' || value === null) {
                    // Reset ALL fields when status cleared to default
                    record.entry = ''; record.exit = ''; record.breakDuration = '0';
                    record.shortage = ''; record.overtime = ''; record.notes = '';
                }
                if (value === 'absent' || value === 'vacation') {
                    record.entry = ''; record.exit = ''; record.breakDuration = '0'; record.shortage = ''; record.overtime = '';
                }
                if (value === 'present') {
                    record.breakDuration = '0.5';
                }
            }

            const updates = {};
            updates[`records.${empId}.${date}.${field}`] = value;
            if (field === 'status' && (value === '' || value === null)) {
                updates[`records.${empId}.${date}.entry`]         = '';
                updates[`records.${empId}.${date}.exit`]          = '';
                updates[`records.${empId}.${date}.breakDuration`] = '0';
                updates[`records.${empId}.${date}.shortage`]      = '';
                updates[`records.${empId}.${date}.overtime`]      = '';
                updates[`records.${empId}.${date}.notes`]         = '';
            }
            if (field === 'status' && (value === 'absent' || value === 'vacation')) {
                updates[`records.${empId}.${date}.entry`] = '';
                updates[`records.${empId}.${date}.exit`] = '';
                updates[`records.${empId}.${date}.breakDuration`] = '0';
                updates[`records.${empId}.${date}.shortage`] = '';
                updates[`records.${empId}.${date}.overtime`] = '';
            }
            if (field === 'status' && value === 'present') {
                updates[`records.${empId}.${date}.breakDuration`] = '0.5';
            }
            if ((field === 'entry' || field === 'exit') && value && !record.status) {
                updates[`records.${empId}.${date}.status`] = 'present';
            }

            try {
                const docRef = getMonthDoc(year, month);
                await updateDoc(docRef, updates);
            } catch (e) {
                const docRef = getMonthDoc(year, month);
                const deepObj = { records: { [empId]: { [date]: record } } };
                await setDoc(docRef, deepObj, { merge: true });
            }
        };

        // ============================================
        //  نقل الوردية — Transfer Shift Feature
        // ============================================
        window.openTransferShiftModal = function(empId) {
            const emp = masterEmployees[empId];
            if (!emp || emp.deleted) return;
            document.getElementById('transferEmpId').value = empId;
            const currentShiftName = emp.shift === 'shift_A' ? t('val_shift_a') : t('val_shift_b');
            document.getElementById('transferEmpNameDisplay').innerHTML =
                `<span class="font-bold text-gray-800 dark:text-gray-100">${emp.name}</span>
                 &nbsp;|&nbsp;
                 <span class="text-indigo-600 dark:text-indigo-400">${currentShiftName}</span>`;
            // Default to the OTHER shift
            const sel = document.getElementById('transferShiftSelect');
            sel.value = emp.shift === 'shift_A' ? 'shift_B' : 'shift_A';
            toggleModal('transferShiftOverlay', true);
        };

        window.executeTransferShift = async function() {
            const empId = document.getElementById('transferEmpId').value;
            const newShift = document.getElementById('transferShiftSelect').value;
            const emp = masterEmployees[empId];
            if (!emp) return;

            if (emp.shift === newShift) {
                toggleModal('transferShiftOverlay', false);
                return;
            }

            document.getElementById('loadingText').innerText = 'جاري نقل الوردية...';
            document.getElementById('loadingScreen').classList.remove('hidden');
            try {
                const updates = {};
                updates[`list.${empId}.shift`] = newShift;
                await updateDoc(EMPLOYEES_DOC, updates);
                toggleModal('transferShiftOverlay', false);
            } catch (e) {
                try {
                    await setDoc(EMPLOYEES_DOC,
                        { list: { [empId]: { ...masterEmployees[empId], shift: newShift } } },
                        { merge: true }
                    );
                    toggleModal('transferShiftOverlay', false);
                } catch (err) {
                    alert('حدث خطأ: ' + err.message);
                }
            } finally {
                document.getElementById('loadingScreen').classList.add('hidden');
            }
        };

        window.openAddEmployeeModal = function() {
            document.getElementById('empModalTitle').innerText = t('add_emp_title');
            document.getElementById('editEmployeeId').value = '';
            document.getElementById('newEmployeeName').value = '';
            
            const shiftSelect = document.getElementById('newEmployeeShift');
            if (userRole === 'shift_b_manager') {
                shiftSelect.value = 'shift_B';
                shiftSelect.disabled = true;
            } else {
                shiftSelect.value = 'shift_A';
                shiftSelect.disabled = false;
            }
            
            toggleModal('addEmployeeOverlay', true);
        };

        window.openEditEmployeeModal = function(empId) {
            const emp = masterEmployees[empId];
            if(!emp) return;
            document.getElementById('empModalTitle').innerText = t('add_emp_title');
            document.getElementById('editEmployeeId').value = empId;
            document.getElementById('newEmployeeName').value = emp.name;
            
            const shiftSelect = document.getElementById('newEmployeeShift');
            shiftSelect.value = emp.shift || 'shift_A';
            
            if (userRole === 'shift_b_manager') {
                shiftSelect.disabled = true;
            } else {
                shiftSelect.disabled = false;
            }

            toggleModal('addEmployeeOverlay', true);
        };

        window.saveEmployeeToMasterList = async function() {
            const id = document.getElementById('editEmployeeId').value;
            const name = document.getElementById('newEmployeeName').value.trim();
            const shift = document.getElementById('newEmployeeShift').value;

            if (!name) return;

            let newOrder = 9999;
            if (!id) {
                 const orders = Object.values(masterEmployees).map(e => e.order || 0);
                 const maxOrder = Math.max(...orders, 0);
                 newOrder = maxOrder + 1;
            }

            const updates = {};
            if (id) {
                updates[`list.${id}.name`] = name;
                updates[`list.${id}.shift`] = shift;
            } else {
                const newId = 'emp_' + Date.now();
                // Add createdAt field for new employees
                updates[`list.${newId}`] = { 
                    name: name, 
                    shift: shift, 
                    order: newOrder,
                    createdAt: new Date().toISOString() // Save creation timestamp
                };
            }

            try {
                await updateDoc(EMPLOYEES_DOC, updates);
            } catch (e) {
                const deepObj = { list: {} };
                const newId = id || 'emp_' + Date.now();
                deepObj.list[newId] = { 
                    name: name, 
                    shift: shift, 
                    order: newOrder,
                    createdAt: new Date().toISOString() // Save creation timestamp
                };
                await setDoc(EMPLOYEES_DOC, deepObj, { merge: true });
            }
            toggleModal('addEmployeeOverlay', false);
        };

        // NEW: Soft Delete Logic
        window.deleteEmployee = async function(empId) {
            const emp = masterEmployees[empId];
            if (!emp) return;

            // If already deleted, restore logic could go here or separate function
            if (emp.deleted) {
                restoreEmployee(empId);
                return;
            }

            if (!confirm(t('msg_confirm_delete'))) return;
            
            const updates = {};
            updates[`list.${empId}.deleted`] = true;
            updates[`list.${empId}.deletedAt`] = new Date().toISOString();

            try {
                await updateDoc(EMPLOYEES_DOC, updates);
                // We don't remove locally immediately, onSnapshot will handle it
                await logAccess('Admin', `Soft Deleted: ${emp.name}`);
            } catch (e) {
                console.error("Delete failed", e);
            }
        };

        // NEW: Restore Employee
        window.restoreEmployee = async function(empId) {
            const emp = masterEmployees[empId];
            if (!emp) return;

            if (!confirm(`هل تريد استعادة الموظف: ${emp.name}؟`)) return;

            const updates = {};
            updates[`list.${empId}.deleted`] = false;
            updates[`list.${empId}.deletedAt`] = null;

            try {
                await updateDoc(EMPLOYEES_DOC, updates);
                await logAccess('Admin', `Restored: ${emp.name}`);
                openRecycleBin(); // Refresh list if open
            } catch (e) {
                console.error("Restore failed", e);
            }
        };

        // NEW: Recycle Bin Logic
        window.openRecycleBin = function() {
            toggleModal('dataManagerOverlay', false);
            const listContainer = document.getElementById('recycleBinList');
            listContainer.innerHTML = '';
            
            const deletedEmps = Object.entries(masterEmployees).filter(([id, data]) => data.deleted);
            
            if (deletedEmps.length === 0) {
                document.getElementById('emptyRecycleBin').classList.remove('hidden');
            } else {
                document.getElementById('emptyRecycleBin').classList.add('hidden');
                deletedEmps.forEach(([id, data]) => {
                    const date = new Date(data.deletedAt).toLocaleDateString('en-GB');
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center p-3 bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-800 rounded-lg";
                    div.innerHTML = `
                        <div>
                            <p class="font-bold text-gray-800 dark:text-gray-200">${data.name}</p>
                            <p class="text-xs text-red-500">${t('deleted_at')} ${date}</p>
                        </div>
                        <button onclick="restoreEmployee('${id}')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-bold shadow transition">
                            ${t('btn_restore')} ⟳
                        </button>
                    `;
                    listContainer.appendChild(div);
                });
            }
            
            toggleModal('recycleBinOverlay', true);
        };

        window.importLegacyEmployees = async function() {
            if(!confirm(t('msg_import_confirm'))) return;
            
            document.getElementById('loadingText').innerText = t('loading_importing');
            document.getElementById('loadingScreen').classList.remove('hidden');

            const currentYear = new Date().getFullYear(); 

            try {
                const legacyDocRef = getLegacyYearDoc(currentYear);
                const snap = await getDoc(legacyDocRef);
                
                if (!snap.exists()) {
                    alert(t('msg_no_legacy_data'));
                    document.getElementById('loadingScreen').classList.add('hidden');
                    return;
                }

                const legacyData = snap.data();
                const legacyEmployees = legacyData.employees || [];
                const legacyRecords = legacyData.records || {};

                const nameToIdMap = {};
                const empUpdates = {};
                let newEmpCount = 0;
                
                const orders = Object.values(masterEmployees).map(e => e.order || 0);
                let currentMaxOrder = Math.max(...orders, 0);

                Object.entries(masterEmployees).forEach(([id, data]) => {
                    nameToIdMap[data.name] = id;
                });

                legacyEmployees.forEach(name => {
                    if (!nameToIdMap[name]) {
                        const newId = 'emp_legacy_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
                        nameToIdMap[name] = newId;
                        currentMaxOrder++;
                        empUpdates[`list.${newId}`] = { name: name, shift: 'shift_A', order: currentMaxOrder };
                        newEmpCount++;
                    }
                });

                if (newEmpCount > 0) {
                     await updateDoc(EMPLOYEES_DOC, empUpdates).catch(async () => {
                         const deepObj = { list: {} };
                         Object.keys(empUpdates).forEach(k => {
                             const key = k.split('.')[1];
                             deepObj.list[key] = empUpdates[k];
                         });
                         await setDoc(EMPLOYEES_DOC, deepObj, { merge: true });
                     });
                     Object.keys(empUpdates).forEach(k => {
                         const id = k.split('.')[1];
                         masterEmployees[id] = empUpdates[k];
                     });
                }

                const monthlyUpdates = {}; 

                Object.keys(legacyRecords).forEach(empName => {
                    const empId = nameToIdMap[empName];
                    if (!empId) return;

                    const empDates = legacyRecords[empName];
                    Object.keys(empDates).forEach(date => {
                        const [y, m, d] = date.split('-');
                        if (y != currentYear) return;

                        if (!monthlyUpdates[m]) monthlyUpdates[m] = {};
                        if (!monthlyUpdates[m][empId]) monthlyUpdates[m][empId] = {};

                        monthlyUpdates[m][empId][date] = empDates[date];
                    });
                });

                const monthsToUpdate = Object.keys(monthlyUpdates);
                let recordsCount = 0;

                for (const m of monthsToUpdate) {
                    const monthDocRef = getMonthDoc(currentYear, m);
                    await setDoc(monthDocRef, { records: monthlyUpdates[m] }, { merge: true });
                    recordsCount += Object.keys(monthlyUpdates[m]).length;
                }
                
                // Log action
                await logAccess('Admin', `Imported Legacy Data`);

                alert(t('msg_import_success'));
                
                changeDate(); 

            } catch (e) {
                console.error(e);
                alert(t('msg_file_error') + e.message);
            } finally {
                document.getElementById('loadingScreen').classList.add('hidden');
                toggleModal('dataManagerOverlay', false);
            }
        };

        window.exportBackup = async function() {
            document.getElementById('loadingText').innerText = t('loading_backup');
            document.getElementById('loadingScreen').classList.remove('hidden');
            
            const backupData = {
                version: "3.0",
                date: new Date().toISOString(),
                employees: masterEmployees,
                months: {}
            };

            const year = new Date().getFullYear();
            for (let m = 1; m <= 12; m++) {
                const mm = String(m).padStart(2, '0');
                try {
                    const snap = await getDoc(getMonthDoc(year, mm));
                    if (snap.exists()) {
                        backupData.months[`${year}_${mm}`] = snap.data();
                    }
                } catch(e) {}
            }

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData));
            
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            const fileName = `backup_${yyyy}-${mm}-${dd}_${hh}-${min}.json`;

            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", fileName);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();

            document.getElementById('loadingScreen').classList.add('hidden');
        };

        window.restoreBackup = function(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const content = e.target.result;
                try {
                    const data = JSON.parse(content);
                    
                    // --- SECURITY VALIDATION CHECK ---
                    // التحقق من أن الملف يحتوي على بيانات الموظفين وبيانات الشهور
                    if (!data || typeof data !== 'object') throw new Error("الملف تالف أو فارغ");
                    if (!data.employees || typeof data.employees !== 'object') throw new Error("بيانات الموظفين غير موجودة أو غير صالحة");
                    if (!data.months || typeof data.months !== 'object') throw new Error("بيانات السجلات الشهرية غير موجودة أو غير صالحة");
                    // ---------------------------------

                    if (!confirm(t('msg_confirm_restore'))) return;

                    document.getElementById('loadingText').innerText = t('loading_restoring');
                    document.getElementById('loadingScreen').classList.remove('hidden');

                    await setDoc(EMPLOYEES_DOC, { list: data.employees });

                    const batch = writeBatch(db);
                    let opCount = 0;
                    
                    for (const [key, monthData] of Object.entries(data.months)) {
                        const [y, m] = key.split('_');
                        const docRef = getMonthDoc(y, m);
                        batch.set(docRef, monthData);
                        opCount++;
                    }
                    
                    if(opCount > 0) await batch.commit();

                    alert(t('msg_restore_success'));
                    location.reload();

                } catch (err) {
                    alert(t('msg_file_error') + err.message);
                    document.getElementById('loadingScreen').classList.add('hidden');
                }
            };
            reader.readAsText(file);
        };

        window.toggleModal = function(id, show) {
            const el = document.getElementById(id);
            if(show) { 
                el.classList.remove('hidden'); 
                document.body.style.overflow = 'hidden'; 
            } else { 
                el.classList.add('hidden'); 
                document.body.style.overflow = ''; 
            }
        };

        window.handleSmartTimeInput = function(input, empId, dateStr, field) {
            let val = input.value.trim();
            if(!val) { saveData(empId, dateStr, field, ''); return; }
            val = val.replace(/[^0-9:]/g, '');
            if (val.indexOf(':') === -1) {
                if (val.length <= 2) {
                    let hour = parseInt(val);
                    if (hour >= 0 && hour <= 23) val = val.padStart(2, '0') + ":00";
                } else if (val.length === 3) {
                    val = "0" + val.substring(0, 1) + ":" + val.substring(1);
                } else if (val.length === 4) {
                    val = val.substring(0, 2) + ":" + val.substring(2);
                }
            }
            if (/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(val)) {
                input.value = val;
                saveData(empId, dateStr, field, val);
            }
        };

        window.adjustRepYear = function(delta) {
            const input = document.getElementById('repYearInput');
            let val = parseInt(input.value) || new Date().getFullYear();
            input.value = val + delta;
        };

        window.openReportModal = function() {
            const today = new Date();
            document.getElementById('repYearInput').value = today.getFullYear();
            document.getElementById('repMonthSelect').value = String(today.getMonth() + 1).padStart(2, '0');
            toggleModal('monthlyReportOverlay', true);
            generateReport('monthly');
        };

        let currentReportType = 'monthly';

        window.generateReport = async function(type) {
            currentReportType = type;
            const year = document.getElementById('repYearInput').value;
            const month = document.getElementById('repMonthSelect').value;
            const tbody = document.getElementById('reportTableBody');
            
            tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4"><div class="loader mx-auto"></div></td></tr>';
            
            let reportData = {};
            
            Object.keys(masterEmployees).forEach(id => {
                const emp = masterEmployees[id];
                // SOFT DELETE LOGIC FOR REPORTS
                if (emp.deleted && emp.deletedAt) {
                    const deletionDate = new Date(emp.deletedAt);
                    const endOfDeletionMonth = new Date(deletionDate.getFullYear(), deletionDate.getMonth() + 1, 0); // End of month
                    const reportDateStart = new Date(year, parseInt(month) - 1, 1);
                    
                    // If Report Month START is AFTER Deletion Month END, Exclude Employee
                    if (type === 'monthly' && reportDateStart > endOfDeletionMonth) {
                        return; // Skip this deleted employee
                    }
                    
                    if (type === 'annual' && year > deletionDate.getFullYear()) {
                        return; // Skip if report year is after deletion year
                    }
                }

                reportData[id] = { 
                    name: emp.name, 
                    shift: emp.shift,
                    order: emp.order || 9999,
                    deleted: emp.deleted || false,
                    present: 0, absent: 0, vacation: 0, holiday: 0, sunday: 0, overtime: 0, delay: 0 
                };
            });

            let monthsToFetch = [];
            if (type === 'monthly') {
                monthsToFetch.push(month);
            } else {
                monthsToFetch = ['01','02','03','04','05','06','07','08','09','10','11','12'];
            }

            for (const m of monthsToFetch) {
                try {
                    const snap = await getDoc(getMonthDoc(year, m));
                    if (snap.exists()) {
                        const records = snap.data().records || {};
                        Object.keys(records).forEach(empId => {
                            if (!reportData[empId]) return;
                            const days = records[empId];
                            Object.values(days).forEach(day => {
                                if (day.status === 'present') reportData[empId].present++;
                                if (day.status === 'absent') reportData[empId].absent++;
                                if (day.status === 'vacation') reportData[empId].vacation++;
                                if (day.status === 'holiday') reportData[empId].holiday++;
                                if (day.status === 'sunday') reportData[empId].sunday++;
                                reportData[empId].overtime += parseFloat(day.overtime) || 0;
                                reportData[empId].delay += parseFloat(day.shortage) || 0;
                            });
                        });
                    }
                } catch(e) {}
            }

            tbody.innerHTML = '';
            document.getElementById('reportTitleDisplay').innerText = 
                type === 'monthly' ? `${t('monthly_report')} (${year}-${month})` : `${t('annual_report')} (${year})`;

            const sortedReportData = Object.values(reportData).sort((a, b) => {
                return (a.order || 0) - (b.order || 0) || a.name.localeCompare(b.name);
            });

            sortedReportData.forEach(d => {
                if (userRole === 'shift_b_manager' && d.shift !== 'shift_B') return;
                if ((userRole === 'admin' || userRole === 'viewer') && currentSelectedShift !== 'all' && d.shift !== currentSelectedShift) return;

                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 dark:hover:bg-gray-700 transition duration-150";
                
                // Add visual cue for deleted in report
                const displayName = d.deleted ? `<span class="text-red-500 italic">${d.name} (محذوف)</span>` : d.name;

                tr.innerHTML = `
                    <td class="p-3 border dark:border-gray-600 font-bold bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-200" data-label="${t('th_name')}" data-label-type="name">${displayName}</td>
                    <td class="p-3 border dark:border-gray-600 text-center text-green-700 dark:text-green-400 font-bold" data-label="${t('th_present')}">${d.present}</td>
                    <td class="p-3 border dark:border-gray-600 text-center text-red-700 dark:text-red-400 font-bold" data-label="${t('th_absent')}">${d.absent}</td>
                    <td class="p-3 border dark:border-gray-600 text-center text-yellow-700 dark:text-yellow-400 font-bold" data-label="${t('th_vacation')}">${d.vacation}</td>
                    <td class="p-3 border dark:border-gray-600 text-center text-purple-700 dark:text-purple-400 font-bold" data-label="${t('th_holiday')}">${d.holiday}</td>
                    <td class="p-3 border dark:border-gray-600 text-center text-cyan-700 dark:text-cyan-400 font-bold" data-label="${t('th_sunday')}">${d.sunday}</td>
                    <td class="p-3 border dark:border-gray-600 text-center text-blue-700 dark:text-blue-400 font-bold" data-label="${t('th_total_overtime')}">${d.overtime}</td>
                    <td class="p-3 border dark:border-gray-600 text-center text-red-600 dark:text-red-500 font-bold" data-label="${t('th_total_delay')}"><span dir="ltr">${Math.abs(d.delay)}</span></td>
                `;
                tbody.appendChild(tr);
            });
        };

        window.exportReportToCSV = function() {
            const rows = document.querySelectorAll('#reportTableBody tr');
            if (rows.length === 0) return;
            
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += `${t('th_name')},${t('th_present')},${t('th_absent')},${t('th_vacation')},${t('th_holiday')},${t('th_sunday')},${t('th_total_overtime')},${t('th_total_delay')}\n`;

            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                const rowData = Array.from(cols).map(c => `"${c.innerText}"`).join(",");
                csvContent += rowData + "\n";
            });

            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        window.showEmployeeSummary = function(empId) {
            const empName = masterEmployees[empId]?.name || 'Unknown';
            const dateStr = document.getElementById('currentDateInput').value;
            const currentMonth = dateStr.slice(0, 7); 
            
            let present = 0, absent = 0, vacation = 0, holiday = 0, sunday = 0, totalOvertime = 0, totalShortage = 0;
            const empData = currentMonthData[empId] || {};
            
            Object.values(empData).forEach(d => {
                if (d.status === 'present') present++;
                if (d.status === 'absent') absent++;
                if (d.status === 'vacation') vacation++;
                if (d.status === 'holiday') holiday++; 
                if (d.status === 'sunday') sunday++;
                totalOvertime += parseFloat(d.overtime) || 0;
                totalShortage += parseFloat(d.shortage) || 0;
            });
            
            const statsContainer = document.getElementById('employeeStatsCard');
            statsContainer.classList.remove('hidden');
            statsContainer.innerHTML = `
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <h3 class="font-bold text-xl text-blue-900 dark:text-blue-300 flex items-center gap-2">
                            <span class="bg-blue-100 dark:bg-blue-900 p-1 rounded text-blue-600 dark:text-blue-300">👤</span>
                            ${t('sum_title')} ${t('sum_emp')} <span class="text-indigo-600 dark:text-indigo-300 underline">${empName}</span>
                        </h3>
                    </div>
                    <div class="flex flex-wrap gap-4 text-sm font-bold">
                        <div class="bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 text-green-800 dark:text-green-300 px-4 py-2 rounded-lg text-center">
                            <span class="text-xs block text-green-500 dark:text-green-400">${t('th_present')}</span> ${present}
                        </div>
                        <div class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-800 dark:text-red-300 px-4 py-2 rounded-lg text-center">
                            <span class="text-xs block text-red-500 dark:text-red-400">${t('th_absent')}</span> ${absent}
                        </div>
                         <div class="bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-800 text-yellow-800 dark:text-yellow-300 px-4 py-2 rounded-lg text-center">
                            <span class="text-xs block text-yellow-600 dark:text-yellow-400">${t('th_vacation')}</span> ${vacation}
                        </div>
                        <div class="bg-purple-50 dark:bg-purple-900/30 border border-purple-200 dark:border-purple-800 text-purple-800 dark:text-purple-300 px-4 py-2 rounded-lg text-center">
                            <span class="text-xs block text-purple-600 dark:text-purple-400">${t('th_holiday')}</span> ${holiday}
                        </div>
                        <div class="bg-cyan-50 dark:bg-cyan-900/30 border border-cyan-200 dark:border-cyan-800 text-cyan-800 dark:text-cyan-300 px-4 py-2 rounded-lg text-center">
                            <span class="text-xs block text-cyan-600 dark:text-cyan-400">${t('th_sunday')}</span> ${sunday}
                        </div>
                        <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-300 px-4 py-2 rounded-lg text-center">
                            <span class="text-xs block text-blue-500 dark:text-blue-400">${t('th_overtime')}</span> ${totalOvertime}
                        </div>
                        <div class="bg-orange-50 dark:bg-orange-900/30 border border-orange-200 dark:border-orange-800 text-orange-800 dark:text-orange-300 px-4 py-2 rounded-lg text-center">
                            <span class="text-xs block text-orange-500 dark:text-orange-400">${t('th_delay')}</span> <span dir="ltr">${Math.abs(totalShortage)}</span>
                        </div>
                    </div>
                    <button onclick="document.getElementById('employeeStatsCard').classList.add('hidden')" class="bg-gray-100 dark:bg-gray-600 px-3 py-1 rounded text-gray-500 dark:text-gray-300">×</button>
                </div>
            `;
            statsContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        };

        document.getElementById('accessCode').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') window.checkLogin();
        });

        changeLanguage(currentLang);

    </script>

    <!-- SELECT ARROW: injected via JS to always win over Tailwind CDN -->
    <script>
        (function applySelectArrows() {
            var LA = "url(\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%2364748B'/%3E%3C/svg%3E\")";
            var DA = "url(\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%2394A3B8'/%3E%3C/svg%3E\")";

            // Move styleEl to END of head each time so it always wins the cascade
            var styleEl = document.createElement('style');
            styleEl.id = 'select-arrow-override';
            document.head.appendChild(styleEl);

            function updateArrows() {
                var isDark = document.documentElement.classList.contains('dark');
                var arrow = isDark ? DA : LA;
                // Move to end of head to beat any late-injected Tailwind styles
                if (styleEl.parentNode) styleEl.parentNode.removeChild(styleEl);
                document.head.appendChild(styleEl);
                styleEl.textContent =
                    'select, td select, #shiftFilter, #viewerPermission, #repMonthSelect, #transferShiftSelect, #newEmployeeShift {' +
                    '  -webkit-appearance: none !important;' +
                    '  -moz-appearance: none !important;' +
                    '  appearance: none !important;' +
                    '  background-image: ' + arrow + ' !important;' +
                    '  background-repeat: no-repeat !important;' +
                    '  background-size: 10px 6px !important;' +
                    '  background-position: left 9px center !important;' +
                    '  padding-left: 1.8rem !important;' +
                    '}' +
                    'select:disabled {' +
                    '  background-image: none !important;' +
                    '  padding-left: 0.5rem !important;' +
                    '}';
            }

            updateArrows();

            // Re-run on dark mode toggle
            new MutationObserver(function(m) {
                m.forEach(function(r) { if (r.attributeName === 'class') updateArrows(); });
            }).observe(document.documentElement, { attributes: true });

            // Re-run a few times after load to catch late Tailwind CDN injection
            [100, 300, 600, 1000, 2000].forEach(function(ms) {
                setTimeout(updateArrows, ms);
            });
        })();
    </script>

</body>
</html>
