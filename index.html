<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cloud Shift Register</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f3f4f6; }
        .table-container { overflow-x: auto; max-height: 70vh; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        thead th { position: sticky; top: 0; z-index: 10; background-color: #1e3a8a; color: white; }
        .select-none { user-select: none; -webkit-user-select: none; }
        .status-present { background-color: #dcfce7; color: #166534; }
        .status-absent { background-color: #fee2e2; color: #991b1b; }
        .status-vacation { background-color: #fef3c7; color: #92400e; }
        input:disabled, select:disabled { background-color: #f3f4f6; cursor: not-allowed; color: #9ca3af; border-color: #e5e7eb; }
        .overlay { position: fixed; inset: 0; background: rgba(17, 24, 39, 0.95); z-index: 50; display: flex; justify-content: center; align-items: center; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 40; display: flex; justify-content: center; align-items: center; padding: 1rem; }
        .hidden { display: none !important; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in-down { animation: fadeInDown 0.3s ease-out forwards; }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Mobile Card View */
        @media (max-width: 768px) {
            .table-container, .overflow-auto { background: transparent; box-shadow: none; overflow: visible !important; max-height: none !important; border: none; }
            #monthlyReportOverlay .overflow-auto { overflow-y: auto !important; -webkit-overflow-scrolling: touch; max-height: 70vh !important; }
            table, thead, tbody, th, td, tr { display: block; width: 100%; }
            thead { display: none; }
            tr { background: white; margin-bottom: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); padding: 0; border: 1px solid #e5e7eb; overflow: hidden; }
            td { padding: 0.8rem 1.2rem; border-bottom: 1px solid #f8f9fa; display: flex; justify-content: space-between; align-items: center; text-align: start; min-height: 50px; }
            td:last-child { border-bottom: none; }
            td::before { content: attr(data-label); font-weight: 600; color: #6b7280; font-size: 0.9rem; flex-basis: 40%; text-align: start; }
            td[data-label-type="name"] { background: linear-gradient(to left, #eff6ff, #ffffff); padding: 1rem; display: flex; justify-content: center; align-items: center; color: #1e40af; font-size: 1.1rem; font-weight: 800; border-bottom: 2px solid #dbeafe; border-top: 4px solid #3b82f6; }
            td[data-label-type="name"]::before { display: none; } 
            td[data-label-type="index"] { display: none; }
            td input, td select { width: 55% !important; max-width: none !important; padding: 0.6rem; border-radius: 0.5rem; border: 1px solid #d1d5db; text-align: center; background-color: #fff; }
            td.delete-col { background: #fef2f2; justify-content: center; padding: 0.8rem; }
            td.delete-col button { width: 100%; color: #ef4444; font-weight: bold; }
            td.delete-col::before { display: none; }
        }
    </style>
</head>
<body class="p-4 md:p-6 text-gray-800 transition-all duration-300">

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ø£Ø®Ø·Ø§Ø¡ -->
    <div id="loadingScreen" class="overlay" style="z-index: 60; background: white;">
        <div class="flex flex-col items-center text-center p-6" id="loadingContent">
            <div class="loader mb-4"></div>
            <p class="text-gray-600 font-bold" data-i18n="connecting">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        </div>
        <!-- Ø­Ø§ÙˆÙŠØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ -->
        <div id="errorContainer" class="hidden flex flex-col items-center justify-center p-6 max-w-lg w-full bg-red-50 border border-red-200 rounded-xl shadow-2xl mx-4">
            <div class="text-red-500 text-5xl mb-4">âš ï¸</div>
            <h3 class="text-xl font-bold text-red-700 mb-2">ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ / Connection Failed</h3>
            
            <div class="bg-white p-4 rounded border border-gray-300 w-full mb-4 text-left" style="direction: ltr;">
                <p class="text-xs text-gray-500 font-bold uppercase">Technical Error:</p>
                <p id="errorText" class="text-sm text-red-600 font-mono mb-2">Unknown</p>
                <p class="text-xs text-gray-500 font-bold uppercase">Error Code:</p>
                <p id="errorCode" class="text-sm text-gray-800 font-mono">N/A</p>
            </div>

            <div class="bg-blue-50 p-4 rounded border border-blue-200 w-full mb-4 text-left" style="direction: ltr;">
                <p class="text-sm text-blue-800 font-bold mb-1">Your Current Domain (Copy this):</p>
                <div class="flex items-center gap-2">
                    <code id="currentDomainDisplay" class="bg-white px-2 py-1 rounded border border-blue-300 flex-1 text-blue-700 font-bold"></code>
                </div>
                <p class="text-xs text-blue-600 mt-2">Add this domain to <b>Firebase Console > Auth > Settings > Authorized Domains</b></p>
                <a href="https://console.firebase.google.com/" target="_blank" class="block mt-2 text-center bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700">Open Firebase Console</a>
            </div>

            <button onclick="location.reload()" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition font-bold w-full">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© / Reload</button>
        </div>
    </div>

    <!-- 1. Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginOverlay" class="overlay hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center relative">
            <div class="absolute top-4 right-4 flex gap-3">
                <button id="btn-tr" onclick="changeLanguage('tr')" class="w-10 h-10 rounded-full overflow-hidden border-4 border-transparent transition-all duration-200 shadow-md">
                    <img src="https://flagcdn.com/w40/tr.png" alt="Turkish" class="w-full h-full object-cover">
                </button>
                <button id="btn-ar" onclick="changeLanguage('ar')" class="w-10 h-10 rounded-full overflow-hidden border-4 border-transparent transition-all duration-200 shadow-md">
                    <img src="https://flagcdn.com/w40/sy.png" alt="Arabic" class="w-full h-full object-cover">
                </button>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2 mt-8" data-i18n="login_title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <p class="text-gray-500 mb-6 text-sm" data-i18n="app_title">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ±Ø¯ÙŠØ§Øª</p>
            <input type="password" id="accessCode" class="w-full p-3 border border-gray-300 rounded-lg mb-4 text-center text-lg tracking-widest focus:ring-2 focus:ring-blue-500 outline-none">
            <button onclick="checkLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition mb-4" data-i18n="login_btn">Ø¯Ø®ÙˆÙ„</button>
            <div class="text-xs text-gray-400 bg-gray-50 p-2 rounded border text-start">
                <p><strong data-i18n="admin_role">Ø§Ù„Ù…Ø¯ÙŠØ±:</strong> 1111</p>
                <p><strong data-i18n="viewer_role">Ø§Ù„Ù…Ø­Ø§Ø³Ø¨:</strong> 2222</p>
            </div>
            <p id="loginError" class="text-red-500 text-sm mt-2 hidden" data-i18n="wrong_code">Ø±Ù…Ø² Ø®Ø§Ø·Ø¦</p>
        </div>
    </div>

    <!-- 2. Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù -->
    <div id="addEmployeeOverlay" class="modal-overlay hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4" data-i18n="add_emp_title">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</h3>
            <input type="text" id="newEmployeeName" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 outline-none">
            <div class="flex gap-2">
                <button onclick="confirmAddEmployee()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition" data-i18n="save">Ø­ÙØ¸</button>
                <button onclick="toggleModal('addEmployeeOverlay', false)" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 rounded-lg transition" data-i18n="cancel">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- 3. Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
    <div id="monthlyReportOverlay" class="modal-overlay hidden" style="align-items: flex-start; padding-top: 2rem;">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl flex flex-col max-h-[90vh] md:h-[90vh]">
            
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold text-gray-800" data-i18n="reports_title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h3>
                <button onclick="toggleModal('monthlyReportOverlay', false)" class="text-red-500 hover:bg-red-50 px-3 py-1 rounded" data-i18n="close">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
            
            <div class="flex flex-wrap gap-3 p-4 bg-gray-50 border-b">
                <div class="flex items-center gap-2">
                    <div class="flex flex-col">
                        <label class="text-xs font-bold text-gray-500" data-i18n="lbl_year">Ø§Ù„Ø³Ù†Ø©</label>
                        <input type="number" id="repYearInput" onchange="generateReport(currentReportType); handleReportYearChange()" class="p-2 border rounded w-20 text-center font-bold">
                    </div>
                    <div class="flex flex-col">
                        <label class="text-xs font-bold text-gray-500" data-i18n="lbl_month">Ø§Ù„Ø´Ù‡Ø±</label>
                        <select id="repMonthSelect" onchange="generateReport(currentReportType)" class="p-2 border rounded w-28 font-bold cursor-pointer">
                            <option value="01">01</option> <option value="02">02</option> <option value="03">03</option>
                            <option value="04">04</option> <option value="05">05</option> <option value="06">06</option>
                            <option value="07">07</option> <option value="08">08</option> <option value="09">09</option>
                            <option value="10">10</option> <option value="11">11</option> <option value="12">12</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-2 flex-grow justify-end">
                    <button onclick="generateReport('monthly')" class="bg-blue-600 text-white px-3 py-2 rounded text-xs md:text-sm hover:bg-blue-700 transition font-bold" data-i18n="btn_monthly_report">Ø´Ù‡Ø±ÙŠ</button>
                    <button onclick="generateReport('annual')" class="bg-indigo-600 text-white px-3 py-2 rounded text-xs md:text-sm hover:bg-indigo-700 transition font-bold" data-i18n="btn_annual_report">Ø³Ù†ÙˆÙŠ</button>
                    <button onclick="exportReportToCSV()" class="bg-green-600 text-white px-3 py-2 rounded text-xs md:text-sm hover:bg-green-700 transition font-bold" data-i18n="export_excel">Excel</button>
                </div>
            </div>

            <div id="reportTitleDisplay" class="text-center font-bold text-lg text-blue-900 py-2 border-b bg-blue-50/50"></div>

            <div class="flex-1 overflow-auto p-2 relative bg-gray-50">
                <div id="reportLoader" class="hidden absolute inset-0 bg-white bg-opacity-80 z-20 flex justify-center items-center">
                    <div class="loader"></div>
                </div>

                <table class="w-full text-start text-sm border-collapse bg-white shadow-sm rounded-lg">
                    <thead class="bg-blue-100 text-gray-800 sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="p-3 border border-gray-200 text-start" data-i18n="th_name">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                            <th class="p-3 border border-gray-200 text-center" data-i18n="th_present">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</th>
                            <th class="p-3 border border-gray-200 text-center" data-i18n="th_absent">Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨</th>
                            <th class="p-3 border border-gray-200 text-center" data-i18n="th_vacation">Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©</th>
                            <th class="p-3 border border-gray-200 text-center" data-i18n="th_total_overtime">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</th>
                            <th class="p-3 border border-gray-200 text-center text-red-600" data-i18n="th_total_delay">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ£Ø®ÙŠØ±</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 4. Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="appContainer" class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-4 md:p-6 hidden h-full md:h-auto min-h-screen md:min-h-0">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b pb-4 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-blue-900" data-i18n="app_title">Ø³Ø¬Ù„ Ø§Ù„ÙˆØ±Ø¯ÙŠØ§Øª</h1>
                <div class="flex items-center gap-2 mt-1">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <p class="text-green-600 text-xs font-bold" data-i18n="status_online">Ù…ØªØµÙ„</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                 <button onclick="openReportModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded shadow flex items-center gap-2 transition text-sm">
                    <span data-i18n="reports_title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
                </button>
                <button onclick="logout()" class="text-gray-500 hover:text-red-600 text-sm underline px-2" data-i18n="logout">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-end md:items-center mb-4 gap-4 bg-blue-50 p-4 rounded-lg border border-blue-100">
            <div class="flex flex-col gap-1 w-full md:w-auto">
                <label class="text-xs font-bold text-blue-800" data-i18n="shift_date">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ±Ø¯ÙŠØ©:</label>
                <input type="date" id="currentDateInput" onchange="changeDate()" class="p-2 border border-blue-300 rounded-lg text-lg font-bold text-gray-700 outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div id="dayInfo" class="text-center hidden md:block">
                <span id="dayNameDisplay" class="text-xl font-bold text-blue-900 block">--</span>
                <span id="dateDisplay" class="text-sm text-blue-600">--</span>
            </div>
            <div id="adminControls" class="flex gap-2">
                <button onclick="toggleModal('addEmployeeOverlay', true)" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded shadow text-sm transition flex items-center gap-1">
                    <span data-i18n="new_employee">+ Ù…ÙˆØ¸Ù</span>
                </button>
                <div id="viewerBadge" class="hidden bg-orange-100 text-orange-800 px-3 py-2 rounded border border-orange-200 font-bold text-sm" data-i18n="viewer_mode">Ù…Ø´Ø§Ù‡Ø¯Ø©</div>
            </div>
        </div>

        <div id="employeeStatsCard" class="hidden mb-4 bg-white border-r-4 ltr:border-r-0 ltr:border-l-4 border-indigo-500 shadow-lg p-5 rounded-lg fade-in-down border border-gray-100"></div>

        <div class="table-container border bg-white relative">
            <table class="w-full text-start border-collapse md:min-w-[1000px]">
                <thead>
                    <tr>
                        <th class="p-3 w-12 bg-blue-900 text-center">#</th>
                        <th class="p-3 w-48 bg-blue-900 text-start" data-i18n="th_name">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                        <th class="p-3 w-32 bg-blue-900 text-center" data-i18n="th_status">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th class="p-3 w-28 bg-blue-900 text-center" data-i18n="th_entry">Ø¯Ø®ÙˆÙ„</th>
                        <th class="p-3 w-28 bg-blue-900 text-center" data-i18n="th_exit">Ø®Ø±ÙˆØ¬</th>
                        <th class="p-3 w-24 bg-blue-900 text-center" data-i18n="th_break">Ø§Ø³ØªØ±Ø§Ø­Ø©</th>
                        <th class="p-3 w-24 bg-blue-900 text-red-200 text-center" data-i18n="th_delay">ØªØ£Ø®ÙŠØ±</th>
                        <th class="p-3 w-24 bg-blue-900 text-center" data-i18n="th_overtime">Ø¥Ø¶Ø§ÙÙŠ</th>
                        <th class="p-3 bg-blue-900 text-center" data-i18n="th_notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                        <th class="p-3 w-16 bg-blue-900 text-center delete-col" data-i18n="th_delete">Ø­Ø°Ù</th>
                    </tr>
                </thead>
                <tbody id="dailyTableBody" class="text-gray-700 text-sm font-medium"></tbody>
            </table>
            <div id="emptyState" class="hidden text-center p-8 text-gray-400" data-i18n="no_data">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</div>
        </div>
    </div>

    <!-- Firebase & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø·Ø£
        function showFatalError(msg, code) {
            document.getElementById('loadingContent').classList.add('hidden');
            document.getElementById('errorContainer').classList.remove('hidden');
            document.getElementById('errorText').innerText = msg;
            document.getElementById('errorCode').innerText = code || 'N/A';
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù†Ø³Ø®Ù‡
            const currentDomain = window.location.hostname;
            document.getElementById('currentDomainDisplay').innerText = currentDomain;
        }

        // ==========================================
        // 1. Ù†Ø¸Ø§Ù… Ø§Ù„Ù„ØºØ§Øª ÙˆØ§Ù„ØªØ±Ø¬Ù…Ø©
        // ==========================================
        const translations = {
            ar: {
                app_title: "Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ±Ø¯ÙŠØ§Øª ÙˆØ§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
                login_title: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
                login_btn: "Ø¯Ø®ÙˆÙ„",
                login_placeholder: "Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„",
                admin_role: "Ø§Ù„Ù…Ø¯ÙŠØ± (ØªØ¹Ø¯ÙŠÙ„):",
                viewer_role: "Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ (Ø¹Ø±Ø¶):",
                wrong_code: "Ø±Ù…Ø² Ø®Ø§Ø·Ø¦",
                connecting: "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...",
                status_online: "Ù…ØªØµÙ„: Cloud Shift Register",
                reports_title: "Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±",
                logout: "Ø®Ø±ÙˆØ¬",
                shift_date: "ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ±Ø¯ÙŠØ©:",
                new_employee: "+ Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯",
                viewer_mode: "ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© (Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·)",
                add_emp_title: "Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯",
                emp_placeholder: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ",
                save: "Ø­ÙØ¸",
                cancel: "Ø¥Ù„ØºØ§Ø¡",
                monthly_report: "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ",
                annual_report: "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù†ÙˆÙŠ Ø§Ù„Ø´Ø§Ù…Ù„",
                btn_monthly_report: "Ø´Ù‡Ø±ÙŠ",
                btn_annual_report: "Ø³Ù†ÙˆÙŠ",
                lbl_year: "Ø§Ù„Ø³Ù†Ø©",
                lbl_month: "Ø§Ù„Ø´Ù‡Ø±",
                close: "Ø¥ØºÙ„Ø§Ù‚",
                select_month: "Ø§Ø®ØªØ± Ø§Ù„ÙØªØ±Ø©:",
                export_excel: "ØªØµØ¯ÙŠØ± Excel",
                th_name: "Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù",
                th_present: "Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±",
                th_absent: "Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨",
                th_vacation: "Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©",
                th_total_overtime: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ (Ø³Ø§Ø¹Ø©)",
                th_total_delay: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ£Ø®ÙŠØ± (Ø³Ø§Ø¹Ø©)",
                th_status: "Ø§Ù„Ø­Ø§Ù„Ø©",
                th_entry: "Ø¯Ø®ÙˆÙ„",
                th_exit: "Ø®Ø±ÙˆØ¬",
                th_break: "Ø§Ø³ØªØ±Ø§Ø­Ø©",
                th_delay: "ØªØ£Ø®ÙŠØ±",
                th_overtime: "Ø¥Ø¶Ø§ÙÙŠ",
                th_notes: "Ù…Ù„Ø§Ø­Ø¸Ø§Øª",
                th_delete: "Ø­Ø°Ù",
                no_data: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.",
                val_present: "Ø­Ø¶ÙˆØ±", val_absent: "ØºÙŠØ§Ø¨", val_vacation: "Ø¥Ø¬Ø§Ø²Ø©", val_choose: "-- Ø§Ø®ØªØ± --",
                sum_title: "Ù…Ù„Ø®Øµ Ø´Ù‡Ø±", sum_emp: "Ù„Ù„Ù…ÙˆØ¸Ù:", sum_days: "ÙŠÙˆÙ…", sum_hrs: "Ø³",
                day_sunday: "Ø§Ù„Ø£Ø­Ø¯", day_monday: "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", day_tuesday: "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", day_wednesday: "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", day_thursday: "Ø§Ù„Ø®Ù…ÙŠØ³", day_friday: "Ø§Ù„Ø¬Ù…Ø¹Ø©", day_saturday: "Ø§Ù„Ø³Ø¨Øª"
            },
            tr: {
                app_title: "Vardiya ve Personel YÃ¶netim Sistemi",
                login_title: "GiriÅŸ Yap",
                login_btn: "GiriÅŸ",
                login_placeholder: "GiriÅŸ Kodu",
                admin_role: "YÃ¶netici (DÃ¼zenle):",
                viewer_role: "Muhasebe (Ä°zle):",
                wrong_code: "HatalÄ± Kod",
                connecting: "VeritabanÄ±na baÄŸlanÄ±lÄ±yor...",
                status_online: "Ã‡evrimiÃ§i: Cloud Shift Register",
                reports_title: "Raporlar",
                logout: "Ã‡Ä±kÄ±ÅŸ",
                shift_date: "Vardiya Tarihi:",
                new_employee: "+ Yeni Personel",
                viewer_mode: "Ä°zleme Modu (Sadece Okuma)",
                add_emp_title: "Yeni Personel Ekle",
                emp_placeholder: "Ad Soyad",
                save: "Kaydet",
                cancel: "Ä°ptal",
                monthly_report: "AylÄ±k Rapor",
                annual_report: "KapsamlÄ± YÄ±llÄ±k Rapor",
                btn_monthly_report: "AylÄ±k",
                btn_annual_report: "YÄ±llÄ±k",
                lbl_year: "YÄ±l",
                lbl_month: "Ay",
                close: "Kapat",
                select_month: "DÃ¶nem SeÃ§in:",
                export_excel: "Excel Ä°ndir",
                th_name: "Personel AdÄ±",
                th_present: "GeldiÄŸi GÃ¼nler",
                th_absent: "GelmediÄŸi GÃ¼nler",
                th_vacation: "Ä°zin GÃ¼nleri",
                th_total_overtime: "Toplam Mesai (Saat)",
                th_total_delay: "Toplam Gecikme (Saat)",
                th_status: "Durum",
                th_entry: "GiriÅŸ",
                th_exit: "Ã‡Ä±kÄ±ÅŸ",
                th_break: "Mola",
                th_delay: "Gecikme",
                th_overtime: "Mesai",
                th_notes: "Notlar",
                th_delete: "Sil",
                no_data: "HenÃ¼z kayÄ±tlÄ± personel yok.",
                val_present: "Mevcut", val_absent: "Yok", val_vacation: "Ä°zinli", val_choose: "-- SeÃ§ --",
                sum_title: "Ay Ã–zeti", sum_emp: "Personel:", sum_days: "GÃ¼n", sum_hrs: "S",
                day_sunday: "Pazar", day_monday: "Pazartesi", day_tuesday: "SalÄ±", day_wednesday: "Ã‡arÅŸamba", day_thursday: "PerÅŸembe", day_friday: "Cuma", day_saturday: "Cumartesi"
            }
        };

        let currentLang = 'tr'; 

        function detectLanguage() {
            const userLang = navigator.language || navigator.userLanguage;
            if (userLang.startsWith('ar')) { setLanguage('ar'); } else { setLanguage('tr'); }
        }

        window.changeLanguage = function(lang) {
            setLanguage(lang);
            if (!document.getElementById('appContainer').classList.contains('hidden')) { renderDailyTable(); }
        };

        function setLanguage(lang) {
            currentLang = lang;
            const dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.documentElement.lang = lang;
            document.documentElement.dir = dir;

            const btnAr = document.getElementById('btn-ar');
            const btnTr = document.getElementById('btn-tr');
            btnAr.classList.remove('border-green-500', 'border-transparent');
            btnTr.classList.remove('border-green-500', 'border-transparent');
            
            if (lang === 'ar') { btnAr.classList.add('border-green-500'); btnTr.classList.add('border-transparent'); } 
            else { btnTr.classList.add('border-green-500'); btnAr.classList.add('border-transparent'); }

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) { el.innerText = translations[lang][key]; }
            });
            document.getElementById('accessCode').placeholder = translations[lang].login_placeholder;
            document.getElementById('newEmployeeName').placeholder = translations[lang].emp_placeholder;
        }

        function t(key) { return translations[currentLang][key] || key; }

        // ==========================================
        // 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
        // ==========================================
        let firebaseConfig;
        let appId = 'cloud-shift-register';

        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            if(typeof __app_id !== 'undefined' && __app_id) appId = __app_id;
        } else {
            // Ù…ÙØ§ØªÙŠØ­ Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„Ø®Ø§ØµØ©
            firebaseConfig = {
                apiKey: "AIzaSyDzRczKA0tVr57TVFmnrr3F57REDTF4xHQ",
                authDomain: "cloud-shift-register.firebaseapp.com",
                projectId: "cloud-shift-register",
                storageBucket: "cloud-shift-register.firebasestorage.app",
                messagingSenderId: "823312208352",
                appId: "1:823312208352:web:fc0889a737e58482ce1b85",
                measurementId: "G-BTTC5LXB7S"
            };
        }

        let app, auth, dbFirestore;
        try {
            if (firebaseConfig.apiKey === "PASTE_YOUR_API_KEY_HERE" && typeof __firebase_config === 'undefined') {
                throw new Error("PLACEHOLDER_KEYS_DETECTED");
            }
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            dbFirestore = getFirestore(app);
            detectLanguage();
            initAuth();
        } catch (e) {
            showFatalError("Config Error: " + e.message);
        }

        let currentDataYear = new Date().getFullYear(); 
        let globalDb = {};
        let globalEmployees = [];
        let userRole = '';
        const collectionPath = `attendance_data/${targetAppId}/years`;
        let dataDocRef;
        let unsubscribeFirestore = null; 

        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                showFatalError(error.message, error.code);
            }
        }

        function loadYearData(year, callback) {
            if (!auth.currentUser) return;
            if (year === currentDataYear && unsubscribeFirestore && !callback) return;
            if (unsubscribeFirestore) unsubscribeFirestore();

            currentDataYear = parseInt(year);
            const dataDocPath = `data_${currentDataYear}`;
            dataDocRef = doc(dbFirestore, collectionPath, dataDocPath);

            document.getElementById('loadingScreen').classList.remove('hidden');

            unsubscribeFirestore = onSnapshot(dataDocRef, (docSnap) => {
                document.getElementById('loadingScreen').classList.add('hidden');
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    globalDb = data.records || {};
                    globalEmployees = data.employees || [];
                } else {
                    globalDb = {};
                    globalEmployees = [];
                }
                if (!document.getElementById('appContainer').classList.contains('hidden')) {
                    renderDailyTable();
                }
                if (callback) callback();
            }, (error) => {
                showFatalError(error.message, error.code);
            });
        }

        if(auth) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    const dateInput = document.getElementById('currentDateInput');
                    const today = new Date().toISOString().split('T')[0];
                    dateInput.value = today;
                    loadYearData(new Date().getFullYear());
                    document.getElementById('loginOverlay').classList.remove('hidden');
                }
            });
        }

        // App Functions
        window.checkLogin = function() {
            const code = document.getElementById('accessCode').value;
            if (code === '1111') { userRole = 'admin'; startApp(); }
            else if (code === '2222') { userRole = 'viewer'; startApp(); }
            else { document.getElementById('loginError').classList.remove('hidden'); }
        };

        window.logout = function() { location.reload(); };

        window.startApp = function() {
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            if (userRole === 'viewer') {
                document.getElementById('adminControls').innerHTML = 
                    `<div class="bg-orange-100 text-orange-800 px-3 py-2 rounded border border-orange-200 font-bold text-sm">${t('viewer_mode')}</div>`;
                const style = document.createElement('style');
                style.innerHTML = '.delete-col { display: none; }';
                document.head.appendChild(style);
            }
            renderDailyTable();
        };

        window.changeDate = function() {
            const dateStr = document.getElementById('currentDateInput').value;
            if(!dateStr) return;
            const newYear = new Date(dateStr).getFullYear();
            if (newYear !== currentDataYear) { loadYearData(newYear); } else { renderDailyTable(); }
            document.getElementById('employeeStatsCard').classList.add('hidden');
        };

        // Reports Logic
        let currentReportType = 'monthly'; 

        window.openReportModal = function() {
            const today = new Date();
            document.getElementById('repYearInput').value = currentDataYear; 
            document.getElementById('repMonthSelect').value = String(today.getMonth() + 1).padStart(2, '0');
            
            toggleModal('monthlyReportOverlay', true);
            // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
            generateReport('monthly'); 
        };

        window.handleReportYearChange = function() {
            const selectedYear = parseInt(document.getElementById('repYearInput').value);
            if (selectedYear && selectedYear !== currentDataYear) {
                document.getElementById('reportLoader').classList.remove('hidden');
                loadYearData(selectedYear, () => {
                    document.getElementById('reportLoader').classList.add('hidden');
                    const currentMonthDay = document.getElementById('currentDateInput').value.slice(5);
                    document.getElementById('currentDateInput').value = `${selectedYear}-${currentMonthDay}`;
                    renderDailyTable(); 
                    generateReport(currentReportType);
                });
            }
        };

        window.generateReport = function(type) {
            currentReportType = type;
            const year = document.getElementById('repYearInput').value;
            const month = document.getElementById('repMonthSelect').value;
            
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = '';

            let titleText = '';
            if (type === 'monthly') {
                titleText = `${t('monthly_report')} - ${year}/${month}`;
            } else {
                titleText = `${t('annual_report')} - ${year}`;
            }
            document.getElementById('reportTitleDisplay').innerText = titleText;

            const prefix = type === 'monthly' ? `${year}-${month}` : `${year}`;

            globalEmployees.forEach(empName => {
                let present = 0, absent = 0, vacation = 0, totalOvertime = 0, totalDelay = 0;
                const empData = globalDb[empName] || {};
                
                Object.keys(empData).forEach(dateKey => {
                    if (dateKey.startsWith(prefix)) {
                        const d = empData[dateKey];
                        if (d.status === 'present') present++;
                        if (d.status === 'absent') absent++;
                        if (d.status === 'vacation') vacation++;
                        if (d.overtime) totalOvertime += parseFloat(d.overtime) || 0;
                        if (d.shortage) totalDelay += parseFloat(d.shortage) || 0;
                    }
                });

                const tr = document.createElement('tr');
                // Added data-label for mobile view in reports
                tr.innerHTML = `
                    <td class="p-3 border border-gray-300 font-bold text-start bg-gray-50" data-label-type="name">${empName}</td>
                    <td class="p-3 border border-gray-300 text-center text-green-700 font-bold" data-label="${t('th_present')}">${present}</td>
                    <td class="p-3 border border-gray-300 text-center text-red-700 font-bold" data-label="${t('th_absent')}">${absent}</td>
                    <td class="p-3 border border-gray-300 text-center text-yellow-700 font-bold" data-label="${t('th_vacation')}">${vacation}</td>
                    <td class="p-3 border border-gray-300 text-center text-blue-700 font-bold" dir="ltr" data-label="${t('th_total_overtime')}">${totalOvertime}</td>
                    <td class="p-3 border border-gray-300 text-center text-red-600 font-bold" dir="ltr" data-label="${t('th_total_delay')}">${totalDelay}</td>
                `;
                tbody.appendChild(tr);
            });
        };

        window.exportReportToCSV = function() {
            const year = document.getElementById('repYearInput').value;
            const month = document.getElementById('repMonthSelect').value;
            const title = document.getElementById('reportTitleDisplay').innerText || 'Report';
            
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += `${title}\n`;
            csvContent += `${t('th_name')},${t('th_present')},${t('th_absent')},${t('th_vacation')},${t('th_total_overtime')},${t('th_total_delay')}\n`;
            
            const prefix = currentReportType === 'monthly' ? `${year}-${month}` : `${year}`;

            globalEmployees.forEach(empName => {
                let present = 0, absent = 0, vacation = 0, totalOvertime = 0, totalDelay = 0;
                const empData = globalDb[empName] || {};
                Object.keys(empData).forEach(dateKey => {
                    if (dateKey.startsWith(prefix)) {
                        const d = empData[dateKey];
                        if (d.status === 'present') present++;
                        if (d.status === 'absent') absent++;
                        if (d.status === 'vacation') vacation++;
                        if (d.overtime) totalOvertime += parseFloat(d.overtime) || 0;
                        if (d.shortage) totalDelay += parseFloat(d.shortage) || 0;
                    }
                });
                csvContent += `"${empName}",${present},${absent},${vacation},${totalOvertime},${totalDelay}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Report_${prefix}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        window.toggleModal = function(id, show) {
            const el = document.getElementById(id);
            if(show) { 
                el.classList.remove('hidden'); 
                document.body.style.overflow = 'hidden'; 
                if(id === 'addEmployeeOverlay') document.getElementById('newEmployeeName').focus(); 
            } else { 
                el.classList.add('hidden'); 
                document.body.style.overflow = ''; 
            }
        };

        // --- Ø¨Ø§Ù‚ÙŠ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ù…Ù†Ø·Ù‚ (ÙƒÙ…Ø§ Ù‡ÙŠ) ---
        // ... (showEmployeeSummary, handleSmartTimeInput, confirmAddEmployee, deleteEmployee, saveDataToCloud, renderDailyTable) ...
        // (ØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©)

        window.showEmployeeSummary = function(empName) {
            const dateStr = document.getElementById('currentDateInput').value;
            const currentMonth = dateStr.slice(0, 7); 
            const monthName = dateStr.slice(5, 7); 
            let present = 0, absent = 0, totalOvertime = 0, totalShortage = 0;
            const empData = globalDb[empName] || {};
            Object.keys(empData).forEach(dateKey => {
                if (dateKey.startsWith(currentMonth)) {
                    const d = empData[dateKey];
                    if (d.status === 'present') present++;
                    if (d.status === 'absent') absent++;
                    totalOvertime += parseFloat(d.overtime) || 0;
                    totalShortage += parseFloat(d.shortage) || 0;
                }
            });
            const statsContainer = document.getElementById('employeeStatsCard');
            statsContainer.classList.remove('hidden');
            statsContainer.innerHTML = `
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <h3 class="font-bold text-xl text-blue-900 flex items-center gap-2">
                            <span class="bg-blue-100 p-1 rounded text-blue-600">ğŸ‘¤</span>
                            ${t('sum_title')} (${monthName}) ${t('sum_emp')} <span class="text-indigo-600 underline decoration-indigo-300 mx-1">${empName}</span>
                        </h3>
                    </div>
                    <div class="flex flex-wrap gap-4 text-sm font-bold">
                        <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-2 rounded-lg flex flex-col items-center">
                            <span class="text-xs text-green-500 mb-1">${t('th_present')}</span>
                            <span class="text-lg">${present} ${t('sum_days')}</span>
                        </div>
                        <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-2 rounded-lg flex flex-col items-center">
                            <span class="text-xs text-red-500 mb-1">${t('th_absent')}</span>
                            <span class="text-lg">${absent} ${t('sum_days')}</span>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 text-blue-800 px-4 py-2 rounded-lg flex flex-col items-center">
                            <span class="text-xs text-blue-500 mb-1">${t('th_overtime')}</span>
                            <span class="text-lg">${totalOvertime} ${t('sum_hrs')}</span>
                        </div>
                        <div class="bg-orange-50 border border-orange-200 text-orange-800 px-4 py-2 rounded-lg flex flex-col items-center">
                            <span class="text-xs text-orange-500 mb-1">${t('th_delay')}</span>
                            <span class="text-lg" dir="ltr">${totalShortage} ${t('sum_hrs')}</span>
                        </div>
                    </div>
                    <button onclick="document.getElementById('employeeStatsCard').classList.add('hidden')" class="bg-gray-100 hover:bg-gray-200 text-gray-500 hover:text-red-500 w-8 h-8 rounded-full flex items-center justify-center transition-colors font-bold text-lg">Ã—</button>
                </div>
            `;
            statsContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        };

        window.handleSmartTimeInput = function(input, empName, dateStr, field) {
            let val = input.value.trim();
            if(!val) { saveDataToCloud(empName, dateStr, field, ''); return; }
            val = val.replace(/[^0-9:]/g, '');
            if (val.indexOf(':') === -1) {
                if (val.length === 1 || val.length === 2) {
                    let hour = parseInt(val);
                    if (hour >= 0 && hour <= 23) val = val.padStart(2, '0') + ":00";
                } else if (val.length === 3) {
                    val = "0" + val.substring(0, 1) + ":" + val.substring(1);
                } else if (val.length === 4) {
                    val = val.substring(0, 2) + ":" + val.substring(2);
                }
            }
            const timeRegex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
            if (timeRegex.test(val)) {
                input.value = val;
                saveDataToCloud(empName, dateStr, field, val);
            }
        };

        window.confirmAddEmployee = async function() {
            const name = document.getElementById('newEmployeeName').value.trim();
            if (!name) return;
            if (globalEmployees.includes(name)) { alert("Exists / Ù…ÙˆØ¬ÙˆØ¯"); return; }
            try {
                await setDoc(dataDocRef, { employees: arrayUnion(name) }, { merge: true });
                document.getElementById('newEmployeeName').value = '';
                toggleModal('addEmployeeOverlay', false);
            } catch (e) { console.error(e); }
        };

        window.deleteEmployee = async function(name) {
            if (userRole !== 'admin') return;
            if (!confirm(t('th_delete') + " ?")) return;
            try {
                await updateDoc(dataDocRef, { employees: arrayRemove(name) });
            } catch (e) { console.error(e); }
        };

        window.saveDataToCloud = async function(empName, date, field, value) {
            if (userRole !== 'admin') return;
            const updatePath = `records.${empName}.${date}`;
            let updates = {};
            updates[`${updatePath}.${field}`] = value;

            if (field === 'status' && (value === 'absent' || value === 'vacation')) {
                updates[`${updatePath}.entry`] = '';
                updates[`${updatePath}.exit`] = '';
                updates[`${updatePath}.breakDuration`] = '0';
                updates[`${updatePath}.shortage`] = '';
                updates[`${updatePath}.overtime`] = '';
            }
            if ((field === 'entry' || field === 'exit') && value) {
                const currentStatus = globalDb[empName]?.[date]?.status;
                if (!currentStatus) updates[`${updatePath}.status`] = 'present';
            }
            try {
                await updateDoc(dataDocRef, updates);
            } catch (e) {
                let deepObject = {};
                if(!deepObject[empName]) deepObject[empName] = {};
                if(!deepObject[empName][date]) deepObject[empName][date] = {};
                deepObject[empName][date][field] = value;
                await setDoc(dataDocRef, { records: deepObject }, { merge: true });
            }
        };

        window.renderDailyTable = function() {
            const dateStr = document.getElementById('currentDateInput').value;
            if(!dateStr) return;

            const dateObj = new Date(dateStr);
            const daysKey = ['day_sunday', 'day_monday', 'day_tuesday', 'day_wednesday', 'day_thursday', 'day_friday', 'day_saturday'];
            document.getElementById('dayNameDisplay').innerText = t(daysKey[dateObj.getDay()]);
            document.getElementById('dateDisplay').innerText = dateStr;

            const tbody = document.getElementById('dailyTableBody');
            tbody.innerHTML = '';

            if (!globalEmployees || globalEmployees.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }
            document.getElementById('emptyState').classList.add('hidden');

            globalEmployees.forEach((empName, index) => {
                const empRecords = globalDb[empName] || {};
                const dayData = empRecords[dateStr] || { status: '', entry: '', exit: '', breakDuration: '0', shortage: '', overtime: '', notes: '' };

                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 border-b transition duration-150";

                const isFrozen = (dayData.status === 'absent' || dayData.status === 'vacation');
                const isInputsFrozen = !dayData.status || dayData.status !== 'present';
                const isDisabled = (userRole === 'viewer') ? 'disabled' : '';
                const inputsDisabled = isInputsFrozen || userRole === 'viewer' ? 'disabled' : '';

                let rowBg = '';
                if(dayData.status === 'absent') rowBg = 'bg-red-50';
                if(dayData.status === 'vacation') rowBg = 'bg-yellow-50';
                if(dayData.status === 'present') rowBg = 'bg-green-50';
                if(rowBg) tr.classList.add(rowBg);

                const breakVal = dayData.breakDuration || '0';
                const shortageVal = dayData.shortage || '';

                tr.innerHTML = `
                    <td class="p-3 text-center text-gray-500" data-label="#" data-label-type="index">${index + 1}</td>
                    <td class="p-3 font-bold text-gray-800 cursor-pointer hover:text-blue-600 hover:bg-blue-50 transition-colors select-none" onclick="showEmployeeSummary('${empName}')" data-label="${t('th_name')}" data-label-type="name">${empName}</td>
                    <td class="p-3" data-label="${t('th_status')}">
                        <select onchange="saveDataToCloud('${empName}', '${dateStr}', 'status', this.value)" ${isDisabled}
                                class="w-full p-2 border rounded bg-white text-sm focus:ring-2 focus:ring-blue-400 outline-none cursor-pointer">
                            <option value="">${t('val_choose')}</option>
                            <option value="present" ${dayData.status === 'present' ? 'selected' : ''}>${t('val_present')}</option>
                            <option value="absent" ${dayData.status === 'absent' ? 'selected' : ''}>${t('val_absent')}</option>
                            <option value="vacation" ${dayData.status === 'vacation' ? 'selected' : ''}>${t('val_vacation')}</option>
                        </select>
                    </td>
                    <td class="p-3" data-label="${t('th_entry')}">
                        <input type="text" value="${dayData.entry || ''}" placeholder="--:--" onchange="handleSmartTimeInput(this, '${empName}', '${dateStr}', 'entry')" ${inputsDisabled} class="w-full p-2 border rounded bg-white text-sm text-center placeholder-gray-300 focus:ring-2 focus:ring-blue-400 outline-none ltr" style="direction: ltr;">
                    </td>
                    <td class="p-3" data-label="${t('th_exit')}">
                        <input type="text" value="${dayData.exit || ''}" placeholder="--:--" onchange="handleSmartTimeInput(this, '${empName}', '${dateStr}', 'exit')" ${inputsDisabled} class="w-full p-2 border rounded bg-white text-sm text-center placeholder-gray-300 focus:ring-2 focus:ring-blue-400 outline-none ltr" style="direction: ltr;">
                    </td>
                    <td class="p-3" data-label="${t('th_break')}">
                        <input type="number" step="0.5" min="0" value="${breakVal}" onchange="saveDataToCloud('${empName}', '${dateStr}', 'breakDuration', this.value)" ${inputsDisabled} class="w-full p-2 border rounded bg-white text-sm text-center focus:ring-2 focus:ring-blue-400 outline-none">
                    </td>
                    <td class="p-3" data-label="${t('th_delay')}">
                        <input type="number" step="0.5" max="0" value="${shortageVal}" onchange="if(this.value > 0) this.value = -this.value; saveDataToCloud('${empName}', '${dateStr}', 'shortage', this.value)" ${inputsDisabled} class="w-full p-2 border rounded bg-white text-sm text-center text-red-600 focus:ring-2 focus:ring-red-400 outline-none placeholder-red-300" placeholder="-">
                    </td>
                    <td class="p-3" data-label="${t('th_overtime')}"><input type="number" step="0.5" value="${dayData.overtime || ''}" onchange="saveDataToCloud('${empName}', '${dateStr}', 'overtime', this.value)" ${inputsDisabled} class="w-full p-2 border rounded bg-white text-sm text-center" placeholder="0"></td>
                    <td class="p-3" data-label="${t('th_notes')}"><input type="text" value="${dayData.notes || ''}" onchange="saveDataToCloud('${empName}', '${dateStr}', 'notes', this.value)" ${isDisabled} class="w-full p-2 border rounded bg-white text-sm" placeholder="..."></td>
                    ${userRole === 'admin' ? 
                    `<td class="p-3 text-center delete-col" data-label="${t('th_delete')}"><button onclick="deleteEmployee('${empName}')" class="text-red-400 hover:text-red-700 font-bold px-2">Ã—</button></td>` 
                    : '<td class="p-3"></td>'}
                `;
                tbody.appendChild(tr);
            });
        };

        document.getElementById('accessCode').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') window.checkLogin();
        });

    </script>
</body>
</html>
