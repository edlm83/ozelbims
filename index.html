<!DOCTYPE html>
<html lang="ar" dir="rtl" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- 1. Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„ÙƒØ¨ÙŠØ±Ø© -->
    <title>OZELBIMS</title>
    
    <!-- 2. Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…ØªØµÙØ­ (Favicon) -->
    <link rel="icon" type="image/png" href="https://i.imgur.com/623NMYe.png">
    
    <!-- 3. Ø£ÙŠÙ‚ÙˆÙ†Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©) -->
    <link rel="apple-touch-icon" href="https://i.imgur.com/623NMYe.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#111827',
                            card: '#1f2937',
                            text: '#f3f4f6',
                            border: '#374151',
                            input: '#374151'
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        body { font-family: 'Tajawal', sans-serif; transition: background-color 0.3s, color 0.3s; }
        
        /* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ --- */
        .table-container { overflow-x: auto; max-height: 70vh; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        thead th { position: sticky; top: 0; z-index: 10; background-color: #1e3a8a; color: white; }
        .dark thead th { background-color: #111827; border-bottom: 1px solid #374151; }

        .select-none { user-select: none; -webkit-user-select: none; }

        /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„Ø§Øª */
        .status-present { background-color: #dcfce7; color: #166534; }
        .status-absent { background-color: #fee2e2; color: #991b1b; }
        .status-vacation { background-color: #fef3c7; color: #92400e; }
        .status-holiday { background-color: #f3e8ff; color: #6b21a8; }
        .status-sunday { background-color: #cffafe; color: #0891b2; }

        .dark .status-present { background-color: #064e3b; color: #ecfccb; }
        .dark .status-absent { background-color: #7f1d1d; color: #fecaca; }
        .dark .status-vacation { background-color: #78350f; color: #fef3c7; }
        .dark .status-holiday { background-color: #581c87; color: #e9d5ff; }
        .dark .status-sunday { background-color: #164e63; color: #cffafe; }
        
        td input, td select { text-align: center !important; text-align-last: center !important; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø·Ù„Ø© (Disabled) - ÙŠØ·ØºÙ‰ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø¹Ø§Ø¯Ø© */
        input:disabled, select:disabled { 
            background-color: #f8fafc; cursor: default; color: #000000 !important; 
            border-color: #cbd5e1; opacity: 1 !important; -webkit-text-fill-color: #000000 !important; font-weight: 700; 
        }
        .dark input:disabled, .dark select:disabled {
            background-color: #374151; color: #d1d5db !important; -webkit-text-fill-color: #d1d5db !important; border-color: #4b5563;
        }

        /* --- Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø®Ø§Øµ Ù„Ø®Ø§Ù†Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Note Input) --- */
        /* ÙŠØ¬Ø¨Ø± Ø§Ù„Ù†Øµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø®Ø§Ù†Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù‚Ø§Ø¡ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª Ù…ØºÙ„Ù‚Ø© (ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨) Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠØ© */
        input.note-input:disabled {
            color: #dc2626 !important; /* red-600 */
            -webkit-text-fill-color: #dc2626 !important;
            background-color: #f8fafc !important; /* Ù†ÙØ³ Ø®Ù„ÙÙŠØ© Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ØºÙ„Ù‚Ø© */
        }
        .dark input.note-input:disabled {
            color: #ef4444 !important; /* red-500 */
            -webkit-text-fill-color: #ef4444 !important;
            background-color: #374151 !important; /* Ù†ÙØ³ Ø®Ù„ÙÙŠØ© Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ØºÙ„Ù‚Ø© ÙÙŠ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
        }

        select:disabled { appearance: none; background-image: none !important; }
        
        .overlay { position: fixed; inset: 0; background: rgba(17, 24, 39, 0.95); z-index: 50; display: flex; justify-content: center; align-items: center; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 40; display: flex; justify-content: center; align-items: center; padding: 1rem; }
        .hidden { display: none !important; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .fade-in-down { animation: fadeInDown 0.3s ease-out forwards; }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Ø²Ø± Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ - Ø«Ø§Ø¨Øª ÙŠØ³Ø§Ø±Ø§Ù‹ */
        .fixed-top-left {
            position: absolute;
            top: 1rem;
            left: 1rem !important; /* Force physical left */
            right: auto !important;
        }
        
        .draggable-row { cursor: grab; }
        .draggable-row.dragging { opacity: 0.5; background-color: #e0f2fe; }
        .dark .draggable-row.dragging { background-color: #1e3a8a; }
        .drag-handle { cursor: grab; color: #9ca3af; font-size: 1.2rem; margin-left: 0.5rem; }
        .drag-handle:hover { color: #2563eb; }
        .drag-over { border-top: 2px solid #2563eb; }

        .lang-btn {
            transition: all 0.3s ease;
            filter: grayscale(100%);
            opacity: 0.6;
            border: 2px solid transparent;
            transform: scale(0.9);
        }
        .lang-btn:hover {
            filter: grayscale(0%);
            opacity: 0.8;
            transform: scale(1);
        }
        .lang-active {
            filter: grayscale(0%) !important;
            opacity: 1 !important;
            border-color: #22c55e !important;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.3);
            animation: pulse-green 2s infinite;
            transform: scale(1.1) !important;
        }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        /* --- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø³Ù… (Name Card) --- */
        .mega-icon-card {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 12px 28px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            text-decoration: none;
            overflow: hidden;
            position: relative;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.3);
            cursor: default;
            direction: ltr; /* Ensure text is LTR */
        }

        .mega-icon-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
            transform: skewX(-25deg);
            pointer-events: none;
            animation: continuous-shine 3.5s infinite ease-in-out;
        }

        /* Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø³Ù… */
        @keyframes continuous-shine {
            0% { left: -150%; opacity: 0; }
            10% { opacity: 0.8; }
            20% { left: 150%; opacity: 0; }
            100% { left: 150%; opacity: 0; } /* ÙˆÙ‚ÙØ© */
        }

        .mega-icon-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
        }

        .mega-icon-card span {
            color: #ffffff;
            font-weight: 700;
            font-size: 0.9rem;
            letter-spacing: 1px;
            font-family: 'Segoe UI', sans-serif;
            text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .mega-icon-card.light-mode {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(240, 242, 245, 0.4));
            border: 1px solid rgba(255, 255, 255, 0.9);
            box-shadow: 
                0 10px 15px -3px rgba(0, 0, 0, 0.1), 
                0 4px 6px -2px rgba(0, 0, 0, 0.05),
                inset 0 0 20px rgba(255, 255, 255, 0.5); 
        }
        
        /* ØªØ¹Ø¯ÙŠÙ„ Ù„Ù…Ø¹Ø© Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ Ù„ØªÙƒÙˆÙ† Ù…Ø±Ø¦ÙŠØ© (ÙØ¶ÙŠ Ø®ÙÙŠÙ) */
        .mega-icon-card.light-mode::before {
             background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0), rgba(150, 150, 150, 0.4), rgba(255, 255, 255, 0), transparent);
        }
        
        .mega-icon-card.light-mode span {
            color: #475569;
            text-shadow: none;
            font-weight: 800;
        }

        /* --- Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© (Glass Social Bubbles) --- */
        .social-bubble {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            
            /* Glass Effect Default - Ø²Ø¬Ø§Ø¬ÙŠ Ø´ÙØ§Ù Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            
            color: white !important;
            font-size: 1.5rem;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
        }

        /* ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙÙˆÙ‚ Ø§Ù„Ù„Ù…Ø¹Ø© */
        .social-bubble i {
            position: relative;
            z-index: 20; 
        }

        /* ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ­ÙˆÙŠÙ… - ÙŠØ¸Ù‡Ø± Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ */
        .social-bubble:hover {
            transform: translateY(-5px) scale(1.15); 
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
            border-color: transparent;
        }

        /* 1. Facebook: Ø£Ø²Ø±Ù‚ */
        .social-bubble.fb:hover {
            background: #1877F2 !important;
        }

        /* 2. Instagram: ØªØ¯Ø±Ø¬ Ù„ÙˆÙ†ÙŠ */
        .social-bubble.ig:hover {
            background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285AEB 90%) !important;
        }

        /* 3. X (Twitter): Ø£Ø³ÙˆØ¯ */
        .social-bubble.x:hover {
            background: #000000 !important;
        }

        /* 4. Telegram: Ø£Ø²Ø±Ù‚ Ø³Ù…Ø§ÙˆÙŠ */
        .social-bubble.tg:hover {
            background: linear-gradient(135deg, #2AABEE, #229ED9) !important;
        }
        
        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ù„Ù…Ø¹Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø© */
        .social-bubble::after {
            content: '';
            position: absolute;
            top: 0;
            left: -200%;
            width: 100%;
            height: 100%;
            background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transform: skewX(-25deg);
            z-index: 1; 
            animation: icon-shine-continuous 3s infinite ease-in-out;
        }

        @keyframes icon-shine-continuous {
            0% { left: -150%; opacity: 0; }
            10% { opacity: 0.8; }
            20% { left: 150%; opacity: 0; }
            100% { left: 150%; opacity: 0; } /* ÙˆÙ‚ÙØ© */
        }

        /* --- ØªØ£Ø«ÙŠØ± Ù„Ù…Ø¹Ø© Ø§Ù„Ø´Ø¹Ø§Ø± (Logo Shine) --- */
        .logo-glow-container {
            position: relative;
            display: inline-block;
            border-radius: 20px; 
            overflow: hidden;
        }
        
        .logo-glow-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: -150%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            transform: skewX(-25deg);
            animation: logo-shine-anim 4s infinite ease-in-out;
            pointer-events: none;
            z-index: 20;
        }

        @keyframes logo-shine-anim {
            0% { left: -150%; }
            20% { left: 150%; } /* Ù…Ø±ÙˆØ± Ø³Ø±ÙŠØ¹ */
            100% { left: 150%; } /* Ø§Ù†ØªØ¸Ø§Ø± */
        }

        [data-aos="zoom-in"] {
            animation: zoomIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            opacity: 0;
        }
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .dark ::-webkit-scrollbar { width: 8px; height: 8px; }
        .dark ::-webkit-scrollbar-track { background: #1f2937; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        @media (max-width: 768px) {
            .table-container, .overflow-auto { background: transparent; box-shadow: none; overflow: visible !important; max-height: none !important; border: none; }
            #monthlyReportOverlay .overflow-auto { overflow-y: auto !important; -webkit-overflow-scrolling: touch; max-height: 70vh !important; }
            table, thead, tbody, th, td, tr { display: block; width: 100%; }
            thead { display: none; }
            
            tr { background: white; margin-bottom: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); padding: 0; border: 1px solid #e5e7eb; overflow: hidden; }
            .dark tr { background: #1f2937; border-color: #374151; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); }
            
            td { padding: 0.8rem 1.2rem; border-bottom: 1px solid #f8f9fa; display: flex; justify-content: space-between; align-items: center; text-align: start; min-height: 50px; }
            .dark td { border-bottom-color: #374151; color: #f3f4f6; }
            td:last-child { border-bottom: none; }
            
            td::before { 
                content: attr(data-label); 
                font-weight: 600; 
                color: #6b7280; 
                font-size: 0.9rem; 
                flex-basis: 40%; 
                text-align: start; 
            }
            .dark td::before { color: #9ca3af; }
            
            td[data-label-type="name"] { background: linear-gradient(to left, #eff6ff, #ffffff); padding: 1rem; justify-content: center; color: #1e40af; font-size: 1.1rem; font-weight: 800; border-bottom: 2px solid #dbeafe; border-top: 4px solid #3b82f6; }
            .dark td[data-label-type="name"] { background: linear-gradient(to left, #1e3a8a, #1f2937); color: #93c5fd; border-bottom-color: #1e40af; border-top-color: #60a5fa; }
            td[data-label-type="name"]::before { display: none; } 
            
            td[data-label-type="index"] { display: none; }
            td input, td select { width: 55% !important; max-width: none !important; padding: 0.6rem; background-color: #fff; }
            .dark td input, .dark td select { background-color: #374151; color: white; border-color: #4b5563; }
            
            td.delete-col { background: #fef2f2; justify-content: center; padding: 0.8rem; }
            .dark td.delete-col { background: #450a0a; }
            td.delete-col button { width: 100%; color: #ef4444; font-weight: bold; }
            td.delete-col::before { display: none; }

            #reportTableBody td[data-label*="Ø§Ù„Ø­Ø¶ÙˆØ±"]::before, #reportTableBody td[data-label*="Present"]::before { color: #15803d; } 
            #reportTableBody td[data-label*="Ø§Ù„ØºÙŠØ§Ø¨"]::before, #reportTableBody td[data-label*="Absent"]::before { color: #b91c1c; } 
            #reportTableBody td[data-label*="Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©"]::before, #reportTableBody td[data-label*="Vacation"]::before { color: #a16207; } 
            #reportTableBody td[data-label*="Ø§Ù„ØªØ£Ø®ÙŠØ±"]::before, #reportTableBody td[data-label*="Delay"]::before { color: #dc2626; } 
            
            .dark #reportTableBody td[data-label*="Ø§Ù„Ø­Ø¶ÙˆØ±"]::before { color: #4ade80; }
            .dark #reportTableBody td[data-label*="Ø§Ù„ØºÙŠØ§Ø¨"]::before { color: #f87171; }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 p-4 md:p-6 transition-colors duration-300">

    <div id="loadingScreen" class="overlay hidden" style="z-index: 60; background: rgba(255,255,255,0.9);">
        <div class="flex flex-col items-center">
            <div class="loader mb-4 border-t-blue-600"></div>
            <p class="text-blue-900 font-bold" id="loadingText" data-i18n="loading_processing">Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        </div>
    </div>

    <div id="loginOverlay" class="overlay flex-col gap-10 bg-gray-900">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl max-w-sm w-full text-center relative border border-gray-200 dark:border-gray-700">
            <!-- Ø²Ø± Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ -->
            <button onclick="toggleDarkMode()" class="fixed-top-left w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-yellow-400 flex items-center justify-center transition shadow-sm hover:bg-gray-200 dark:hover:bg-gray-600 z-10" title="Dark Mode">
                <i class="theme-toggle-icon fa-solid fa-moon"></i>
            </button>

            <div class="flex justify-center gap-4 mb-6">
                <button id="btn-tr" onclick="changeLanguage('tr')" class="lang-btn w-10 h-10 rounded-full bg-white dark:bg-gray-700 p-0.5 overflow-hidden" title="TÃ¼rkÃ§e">
                    <img src="https://flagcdn.com/w80/tr.png" class="w-full h-full object-cover rounded-full">
                </button>
                <button id="btn-ar" onclick="changeLanguage('ar')" class="lang-btn lang-active w-10 h-10 rounded-full bg-white dark:bg-gray-700 p-0.5 overflow-hidden" title="Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">
                    <img src="https://flagcdn.com/w80/sy.png" class="w-full h-full object-cover rounded-full">
                </button>
            </div>

            <!-- Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ© ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¹ ØªØ£Ø«ÙŠØ± Ø§Ù„Ù„Ù…Ø¹Ø© -->
            <div class="flex justify-center mb-4">
                <div class="logo-glow-container">
                    <img src="https://i.imgur.com/623NMYe.png" alt="ozelBims Logo" class="w-24 h-24 object-contain drop-shadow-lg relative z-10">
                </div>
            </div>

            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2" data-i18n="login_title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <p class="text-gray-500 dark:text-gray-400 mb-6 text-sm">Version <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full font-bold">V3.7</span></p>
            <input type="password" id="accessCode" inputmode="numeric" pattern="[0-9]*" class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg mb-4 text-center text-lg tracking-widest focus:ring-2 focus:ring-blue-500 outline-none transition-colors" placeholder="Code">
            <button onclick="checkLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition mb-4 shadow-lg" data-i18n="login_btn">Ø¯Ø®ÙˆÙ„</button>
            
            <p id="loginError" class="text-red-500 text-sm mt-2 hidden" data-i18n="msg_wrong_code">Ø±Ù…Ø² Ø®Ø§Ø·Ø¦</p>
        </div>

        <!-- ØªØ°ÙŠÙŠÙ„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª) -->
        <div class="flex flex-col items-center gap-3" data-aos="zoom-in">
            <div id="devCardLogin" class="mega-icon-card">
                <span>Developed by EMAD ALLAHAM</span>
            </div>
            <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ©: dir="ltr" ÙŠØ¬Ø¨Ø± Ø§Ù„ØªØ±ØªÙŠØ¨ ÙŠØ³Ø§Ø± Ù„ÙŠÙ…ÙŠÙ† Ø¯Ø§Ø¦Ù…Ø§Ù‹ -->
            <div class="flex gap-4" dir="ltr">
                <!-- Facebook -->
                <a href="https://www.facebook.com/emad.allahaam" target="_blank" class="social-bubble fb" title="Facebook">
                    <i class="fa-brands fa-facebook-f"></i>
                </a>
                <!-- X (Twitter) -->
                <a href="https://x.com/edlm83" target="_blank" class="social-bubble x" title="X (Twitter)">
                    <i class="fa-brands fa-x-twitter"></i>
                </a>
                <!-- Instagram -->
                <a href="https://www.instagram.com/edlm83" target="_blank" class="social-bubble ig" title="Instagram">
                    <i class="fa-brands fa-instagram"></i>
                </a>
                <!-- Telegram -->
                <a href="https://t.me/edlm83" target="_blank" class="social-bubble tg" title="Telegram">
                    <i class="fa-brands fa-telegram"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù -->
    <div id="addEmployeeOverlay" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border dark:border-gray-700">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4" id="empModalTitle" data-i18n="add_emp_title">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</h3>
            <input type="hidden" id="editEmployeeId">
            <input type="text" id="newEmployeeName" class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ" data-i18n-ph="ph_employee_name">
            
            <div class="mb-4">
                <label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block" data-i18n="lbl_shift">Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</label>
                <select id="newEmployeeShift" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg">
                    <option value="shift_A" data-i18n="val_shift_a">Ø§Ù„ÙˆØ±Ø¯ÙŠØ© A</option>
                    <option value="shift_B" data-i18n="val_shift_b">Ø§Ù„ÙˆØ±Ø¯ÙŠØ© B</option>
                </select>
            </div>

            <div class="flex gap-2">
                <button onclick="saveEmployeeToMasterList()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition" data-i18n="save">Ø­ÙØ¸</button>
                <button onclick="toggleModal('addEmployeeOverlay', false)" class="flex-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-bold py-2 rounded-lg transition" data-i18n="cancel">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªØ­ÙˆÙŠ Ø²Ø± Ø§Ù„Ø³Ø¬Ù„) -->
    <div id="dataManagerOverlay" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-md w-full border dark:border-gray-700">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
                <span>ğŸ’¾</span> <span data-i18n="data_management">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
            </h3>
            
            <!-- Ø²Ø± Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
            <button onclick="viewLoginLogs()" class="w-full mb-6 bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded flex justify-center items-center gap-2 shadow-sm transition">
                <span>ğŸ“œ</span> <span data-i18n="btn_login_log">Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
            </button>

            <div class="mb-6 bg-orange-50 dark:bg-orange-900/30 p-3 rounded border border-orange-200 dark:border-orange-800">
                <h4 class="font-bold text-orange-800 dark:text-orange-300 text-sm mb-2" data-i18n="legacy_import_title">ğŸ“¥ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… (V2)</h4>
                <p class="text-xs text-orange-600 dark:text-orange-400 mb-3" data-i18n="legacy_import_desc">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ù…Ù† Ù…Ù„ÙØ§Øª Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø§Ø¶ÙŠØ©.</p>
                <button onclick="importLegacyEmployees()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 rounded text-sm shadow" data-i18n="btn_import_legacy">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø³Ø¬Ù„Ø§Øª</button>
            </div>

            <div class="space-y-3">
                <button onclick="exportBackup()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded flex justify-center items-center gap-2">
                    <span>â¬‡ï¸</span> <span data-i18n="btn_backup_download">ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (JSON)</span>
                </button>
                
                <div class="relative">
                    <input type="file" id="restoreFile" class="hidden" onchange="restoreBackup(this)">
                    <button onclick="document.getElementById('restoreFile').click()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded flex justify-center items-center gap-2">
                        <span>â¬†ï¸</span> <span data-i18n="btn_restore_upload">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø© Ù…Ø­ÙÙˆØ¸Ø©</span>
                    </button>
                </div>
            </div>

            <button onclick="toggleModal('dataManagerOverlay', false)" class="w-full mt-4 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-400 py-2 rounded" data-i18n="close">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù…Ø¹Ø¯Ù„Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„) -->
    <div id="loginLogOverlay" class="modal-overlay hidden" style="align-items: flex-start; padding-top: 2rem;">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl flex flex-col max-h-[85vh] border dark:border-gray-700 overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b dark:border-gray-700 flex-shrink-0">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white" data-i18n="log_modal_title">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                <div class="flex gap-2">
                    <!-- Ø£Ø²Ø±Ø§Ø± Ø¬Ø¯ÙŠØ¯Ø©: ØªØµØ¯ÙŠØ± ÙˆÙ…Ø³Ø­ -->
                    <button id="btnExportLog" onclick="exportLoginLogs()" class="text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 px-3 py-1 rounded hidden" title="Export Excel">
                        <i class="fa-solid fa-download"></i>
                    </button>
                    <button id="btnClearLog" onclick="clearLoginLogs()" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 px-3 py-1 rounded hidden" title="Clear Logs">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                    <button onclick="toggleModal('loginLogOverlay', false)" class="text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-1 rounded" data-i18n="close">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
            <!-- ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ù„ØªØ³Ù…Ø­ Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
            <div class="flex-1 overflow-y-auto p-2 relative bg-gray-50 dark:bg-gray-900/50" style="overscroll-behavior: contain;">
                <table class="w-full text-start text-sm border-collapse bg-white dark:bg-gray-800 shadow-sm rounded-lg">
                    <thead class="bg-teal-100 dark:bg-teal-900 text-gray-800 dark:text-white sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-start" data-i18n="th_role">Ø§Ù„Ø±ØªØ¨Ø©</th>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-center ltr" data-i18n="th_time">Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-center" data-i18n="th_device">Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-start" data-i18n="th_browser">Ø§Ù„Ù…ØªØµÙØ­</th>
                        </tr>
                    </thead>
                    <tbody id="loginLogTableBody" class="text-gray-700 dark:text-gray-300"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="monthlyReportOverlay" class="modal-overlay hidden" style="align-items: flex-start; padding-top: 2rem;">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-5xl flex flex-col max-h-[90vh] md:h-[90vh] border dark:border-gray-700">
            <div class="flex justify-between items-center p-4 border-b dark:border-gray-700">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white" data-i18n="reports_title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h3>
                <button onclick="toggleModal('monthlyReportOverlay', false)" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 px-3 py-1 rounded" data-i18n="close">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
            <div class="flex flex-wrap gap-3 p-4 bg-gray-50 dark:bg-gray-900 border-b dark:border-gray-700 items-center">
                <div class="flex items-center gap-2">
                    <div class="flex flex-col">
                        <label class="text-xs font-bold text-gray-500 dark:text-gray-400" data-i18n="lbl_year">Ø§Ù„Ø³Ù†Ø©</label>
                        <div class="relative flex items-center">
                            <input type="number" id="repYearInput" class="p-2 pl-6 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded w-24 text-center font-bold" style="-moz-appearance: textfield;">
                            <div class="absolute left-0 inset-y-0 flex flex-col border-r dark:border-r-gray-600 w-6 rounded-l overflow-hidden">
                                <button onclick="adjustRepYear(1)" class="h-1/2 hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 flex items-center justify-center border-b border-gray-200 dark:border-gray-600 transition-colors bg-gray-50 dark:bg-gray-700">
                                    <i class="fa-solid fa-caret-up text-[10px]"></i>
                                </button>
                                <button onclick="adjustRepYear(-1)" class="h-1/2 hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 flex items-center justify-center transition-colors bg-gray-50 dark:bg-gray-700">
                                    <i class="fa-solid fa-caret-down text-[10px]"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <label class="text-xs font-bold text-gray-500 dark:text-gray-400" data-i18n="lbl_month">Ø§Ù„Ø´Ù‡Ø±</label>
                        <select id="repMonthSelect" onchange="generateReport('monthly')" class="p-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded w-28 font-bold cursor-pointer">
                            <option value="01">01</option> <option value="02">02</option> <option value="03">03</option>
                            <option value="04">04</option> <option value="05">05</option> <option value="06">06</option>
                            <option value="07">07</option> <option value="08">08</option> <option value="09">09</option>
                            <option value="10">10</option> <option value="11">11</option> <option value="12">12</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-2 flex-grow justify-end">
                    <button onclick="generateReport('monthly')" class="bg-blue-600 text-white px-3 py-2 rounded text-xs md:text-sm font-bold hover:bg-blue-700" data-i18n="btn_monthly_report">Ø´Ù‡Ø±ÙŠ</button>
                    <button onclick="generateReport('annual')" class="bg-indigo-600 text-white px-3 py-2 rounded text-xs md:text-sm font-bold hover:bg-indigo-700" data-i18n="btn_annual_report">Ø³Ù†ÙˆÙŠ</button>
                    <button onclick="exportReportToCSV()" class="bg-green-600 text-white px-3 py-2 rounded text-xs md:text-sm font-bold hover:bg-green-700" data-i18n="export_excel">Excel</button>
                </div>
            </div>
            <div id="reportTitleDisplay" class="text-center font-bold text-lg text-blue-900 dark:text-blue-300 py-2 border-b dark:border-gray-700 bg-blue-50/50 dark:bg-blue-900/20"></div>
            <div class="flex-1 overflow-auto p-2 relative bg-gray-50 dark:bg-gray-900/50">
                <table class="w-full text-start text-sm border-collapse bg-white dark:bg-gray-800 shadow-sm rounded-lg">
                    <thead class="bg-blue-100 dark:bg-gray-700 text-gray-800 dark:text-white sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-start" data-i18n="th_name">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-center" data-i18n="th_present">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</th>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-center" data-i18n="th_absent">Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨</th>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-center" data-i18n="th_vacation">Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©</th>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-center text-purple-700 dark:text-purple-300" data-i18n="th_holiday">Ø±Ø³Ù…ÙŠØ©</th>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-center text-cyan-700 dark:text-cyan-300" data-i18n="th_sunday">Ø§Ù„Ø£Ø­Ø¯</th>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-center" data-i18n="th_total_overtime">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</th>
                            <th class="p-3 border border-gray-200 dark:border-gray-600 text-center text-red-600 dark:text-red-400" data-i18n="th_total_delay">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ£Ø®ÙŠØ±</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody" class="dark:text-gray-300"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="appContainer" class="max-w-7xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 md:p-6 hidden h-full md:h-auto min-h-screen md:min-h-0 flex flex-col border dark:border-gray-700">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b dark:border-gray-700 pb-4 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-blue-900 dark:text-blue-300 flex items-center gap-2">
                    <span data-i18n="app_title">Ø³Ø¬Ù„ Ø§Ù„ÙˆØ±Ø¯ÙŠØ§Øª</span>
                    <span id="shiftBadge" class="hidden text-xs bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 px-2 py-1 rounded-full" data-i18n="badge_shift_b">Ø§Ù„ÙˆØ±Ø¯ÙŠØ© B</span>
                </h1>
                <div class="flex items-center gap-2 mt-1">
                    <span id="connectionDot" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <p id="connectionText" class="text-green-600 dark:text-green-400 text-xs font-bold" data-i18n="status_online">Ù…ØªØµÙ„ ÙˆØ¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                 <button onclick="toggleDarkMode()" class="p-2 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-yellow-400 hover:bg-gray-200 dark:hover:bg-gray-600 transition shadow-sm">
                    <i class="theme-toggle-icon fa-solid fa-moon"></i>
                </button>

                 <button id="dataBtn" onclick="toggleModal('dataManagerOverlay', true)" class="hidden bg-gray-700 hover:bg-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 text-white px-3 py-2 rounded shadow flex items-center gap-2 transition text-sm">
                    <span>ğŸ’¾</span> <span class="hidden md:inline" data-i18n="data_btn">Ø¨ÙŠØ§Ù†Ø§Øª</span>
                </button>
                 <button onclick="openReportModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded shadow flex items-center gap-2 transition text-sm">
                    <span data-i18n="reports_title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
                </button>
                <button onclick="logout()" class="text-gray-500 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-400 text-sm underline px-2" data-i18n="logout">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-end md:items-center mb-4 gap-4 bg-blue-50 dark:bg-gray-900 p-4 rounded-lg border border-blue-100 dark:border-gray-700">
            <div class="flex flex-wrap gap-4 items-end w-full md:w-auto">
                <div class="flex flex-col gap-1">
                    <label class="text-xs font-bold text-blue-800 dark:text-blue-300" data-i18n="shift_date">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ±Ø¯ÙŠØ©:</label>
                    <div class="relative flex items-center">
                        <input type="date" id="currentDateInput" onchange="changeDate()" class="p-2 pl-8 border border-blue-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg text-lg font-bold text-gray-700 outline-none focus:ring-2 focus:ring-blue-500">
                         <!-- Up/Down arrows for date -->
                        <div class="absolute left-0 inset-y-0 flex flex-col border-r dark:border-r-gray-600 w-6 rounded-l overflow-hidden">
                            <button onclick="adjustDate(1)" class="h-1/2 hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 flex items-center justify-center border-b border-gray-300 dark:border-gray-600 transition-colors bg-white dark:bg-gray-700">
                                <i class="fa-solid fa-caret-up text-[10px]"></i>
                            </button>
                            <button onclick="adjustDate(-1)" class="h-1/2 hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 flex items-center justify-center transition-colors bg-white dark:bg-gray-700">
                                <i class="fa-solid fa-caret-down text-[10px]"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="shiftSelectorContainer" class="flex flex-col gap-1 hidden">
                    <label class="text-xs font-bold text-blue-800 dark:text-blue-300" data-i18n="lbl_shift">Ø§Ù„ÙˆØ±Ø¯ÙŠØ© (ØªØµÙÙŠØ©):</label>
                    <select id="shiftFilter" onchange="applyShiftFilter()" class="p-2 border border-blue-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg font-bold text-gray-700 outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                        <option value="all" data-i18n="val_all_shifts">Ø§Ù„ÙƒÙ„</option>
                        <option value="shift_A" data-i18n="val_shift_a">Ø§Ù„ÙˆØ±Ø¯ÙŠØ© A</option>
                        <option value="shift_B" data-i18n="val_shift_b">Ø§Ù„ÙˆØ±Ø¯ÙŠØ© B</option>
                    </select>
                </div>

                <!-- NEW: Admin Viewer Control -->
                <div id="adminViewerControl" class="flex flex-col gap-1 hidden">
                    <label class="text-xs font-bold text-purple-800 dark:text-purple-300" data-i18n="lbl_viewer_control">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨:</label>
                    <select id="viewerPermission" onchange="updateViewerPermission(this.value)" class="p-2 border border-purple-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg font-bold text-purple-700 outline-none focus:ring-2 focus:ring-purple-500 bg-white">
                        <option value="all" data-i18n="val_all_shifts">Ø§Ù„ÙƒÙ„</option>
                        <option value="shift_A" data-i18n="val_shift_a">Ø§Ù„ÙˆØ±Ø¯ÙŠØ© A</option>
                        <option value="shift_B" data-i18n="val_shift_b">Ø§Ù„ÙˆØ±Ø¯ÙŠØ© B</option>
                    </select>
                </div>
                
                <div id="bulkControls" class="flex flex-wrap gap-2 items-end hidden">
                    <div class="flex flex-col items-center">
                        <button onclick="applyBulkAction('entry')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-t shadow text-xs font-bold w-full transition" data-i18n="bulk_entry">Ø¯Ø®ÙˆÙ„ Ø¬Ù…Ø§Ø¹ÙŠ</button>
                        <input type="tel" inputmode="numeric" pattern="[0-9]*" id="bulkEntryInput" placeholder="--:--" class="p-1 border border-green-300 dark:border-green-800 dark:bg-gray-700 dark:text-white rounded-b w-full text-center text-sm ltr placeholder-gray-400 focus:ring-2 focus:ring-green-500 outline-none" onchange="validateBulkInput(this)">
                    </div>
                    <div class="flex flex-col items-center">
                        <button onclick="applyBulkAction('exit')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-t shadow text-xs font-bold w-full transition" data-i18n="bulk_exit">Ø®Ø±ÙˆØ¬ Ø¬Ù…Ø§Ø¹ÙŠ</button>
                        <input type="tel" inputmode="numeric" pattern="[0-9]*" id="bulkExitInput" placeholder="--:--" class="p-1 border border-blue-300 dark:border-blue-800 dark:bg-gray-700 dark:text-white rounded-b w-full text-center text-sm ltr placeholder-gray-400 focus:ring-2 focus:ring-blue-500 outline-none" onchange="validateBulkInput(this)">
                    </div>
                </div>
            </div>

            <div id="dayInfo" class="text-center hidden md:block">
                <span id="dayNameDisplay" class="text-xl font-bold text-blue-900 dark:text-blue-300 block">--</span>
                <span id="dateDisplay" class="text-sm text-blue-600 dark:text-blue-400">--</span>
            </div>

            <div id="adminControls" class="flex gap-2">
                <button onclick="openAddEmployeeModal()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded shadow text-sm transition flex items-center gap-1">
                    <span data-i18n="new_employee">+ Ù…ÙˆØ¸Ù</span>
                </button>
            </div>
        </div>

        <div id="employeeStatsCard" class="hidden mb-4 bg-white dark:bg-gray-700 border-r-4 ltr:border-r-0 ltr:border-l-4 border-indigo-500 shadow-lg p-5 rounded-lg fade-in-down border border-gray-100 dark:border-gray-600"></div>

        <div class="table-container border bg-white dark:bg-gray-800 relative flex-grow dark:border-gray-700">
            <table class="w-full text-start border-collapse md:min-w-[1000px]">
                <thead>
                    <tr>
                        <th class="p-3 w-12 bg-blue-900 text-center">#</th>
                        <th class="p-3 w-48 bg-blue-900 text-start" data-i18n="th_name">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                        <th class="p-3 w-32 bg-blue-900 text-center" data-i18n="th_status">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th class="p-3 w-28 bg-blue-900 text-center" data-i18n="th_entry">Ø¯Ø®ÙˆÙ„</th>
                        <th class="p-3 w-28 bg-blue-900 text-center" data-i18n="th_exit">Ø®Ø±ÙˆØ¬</th>
                        <th class="p-3 w-24 bg-blue-900 text-center" data-i18n="th_break">Ø§Ø³ØªØ±Ø§Ø­Ø©</th>
                        <th class="p-3 w-24 bg-blue-900 text-red-200 text-center" data-i18n="th_delay">ØªØ£Ø®ÙŠØ±</th>
                        <th class="p-3 w-24 bg-blue-900 text-center" data-i18n="th_overtime">Ø¥Ø¶Ø§ÙÙŠ</th>
                        <th class="p-3 bg-blue-900 text-center" data-i18n="th_notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                        <th class="p-3 w-16 bg-blue-900 text-center delete-col" data-i18n="th_delete">Ø­Ø°Ù</th>
                    </tr>
                </thead>
                <tbody id="dailyTableBody" class="text-gray-700 dark:text-gray-300 text-sm font-medium"></tbody>
            </table>
            <div id="emptyState" class="hidden text-center p-8 text-gray-400 dark:text-gray-500" data-i18n="no_data">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ†.</div>
        </div>

        <!-- ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <div class="flex flex-col items-center gap-3 mt-8 mb-4" data-aos="zoom-in">
            <div id="devCardMain" class="mega-icon-card light-mode">
                <span>Developed by EMAD ALLAHAM</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, writeBatch, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const translations = {
            ar: {
                app_title: "Ø³Ø¬Ù„ Ø§Ù„ÙˆØ±Ø¯ÙŠØ§Øª",
                login_title: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
                login_btn: "Ø¯Ø®ÙˆÙ„",
                status_online: "Ù…ØªØµÙ„ ÙˆØ¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„",
                status_offline: "ØºÙŠØ± Ù…ØªØµÙ„",
                reports_title: "Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±",
                logout: "Ø®Ø±ÙˆØ¬",
                shift_date: "ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ±Ø¯ÙŠØ©:",
                new_employee: "+ Ù…ÙˆØ¸Ù",
                viewer_mode: "ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©",
                add_emp_title: "Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¸Ù",
                save: "Ø­ÙØ¸",
                cancel: "Ø¥Ù„ØºØ§Ø¡",
                monthly_report: "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ",
                annual_report: "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù†ÙˆÙŠ",
                btn_monthly_report: "Ø´Ù‡Ø±ÙŠ",
                btn_annual_report: "Ø³Ù†ÙˆÙŠ",
                lbl_year: "Ø§Ù„Ø³Ù†Ø©",
                lbl_month: "Ø§Ù„Ø´Ù‡Ø±",
                close: "Ø¥ØºÙ„Ø§Ù‚",
                export_excel: "ØªØµØ¯ÙŠØ± Excel",
                th_name: "Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù",
                th_status: "Ø§Ù„Ø­Ø§Ù„Ø©",
                th_entry: "Ø¯Ø®ÙˆÙ„",
                th_exit: "Ø®Ø±ÙˆØ¬",
                th_break: "Ø§Ø³ØªØ±Ø§Ø­Ø©",
                th_delay: "ØªØ£Ø®ÙŠØ±",
                th_overtime: "Ø¥Ø¶Ø§ÙÙŠ",
                th_notes: "Ù…Ù„Ø§Ø­Ø¸Ø§Øª",
                th_delete: "Ø­Ø°Ù",
                no_data: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ†.",
                val_present: "Ø­Ø¶ÙˆØ±", val_absent: "ØºÙŠØ§Ø¨", val_vacation: "Ø¥Ø¬Ø§Ø²Ø©", val_holiday: "Ø¹Ø·Ù„Ø© Ø±Ø³Ù…ÙŠØ©", val_sunday: "ÙŠÙˆÙ… Ø§Ù„Ø£Ø­Ø¯", val_choose: "--",
                th_present: "Ø­Ø¶ÙˆØ±", th_absent: "ØºÙŠØ§Ø¨", th_vacation: "Ø¥Ø¬Ø§Ø²Ø©", th_holiday: "Ø±Ø³Ù…ÙŠØ©", th_sunday: "Ø§Ù„Ø£Ø­Ø¯", th_total_overtime: "Ø³.Ø¥Ø¶Ø§ÙÙŠ", th_total_delay: "Ø³.ØªØ£Ø®ÙŠØ±",
                sum_title: "Ù…Ù„Ø®Øµ", sum_emp: "Ù„Ù€", sum_days: "ÙŠÙˆÙ…", sum_hrs: "Ø³",
                day_sunday: "Ø§Ù„Ø£Ø­Ø¯", day_monday: "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", day_tuesday: "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", day_wednesday: "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", day_thursday: "Ø§Ù„Ø®Ù…ÙŠØ³", day_friday: "Ø§Ù„Ø¬Ù…Ø¹Ø©", day_saturday: "Ø§Ù„Ø³Ø¨Øª",
                lbl_shift: "Ø§Ù„ÙˆØ±Ø¯ÙŠØ©", val_all_shifts: "Ø§Ù„ÙƒÙ„",
                val_shift_a: "Ø§Ù„ÙˆØ±Ø¯ÙŠØ© A", val_shift_b: "Ø§Ù„ÙˆØ±Ø¯ÙŠØ© B",
                role_admin: "Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…: 56401", role_shift_b_man: "Ù…Ø¯ÙŠØ± Ø§Ù„ÙˆØ±Ø¯ÙŠØ© B ÙÙ‚Ø·: 2222", role_accountant: "Ø§Ù„Ù…Ø­Ø§Ø³Ø¨: 3838",
                data_btn: "Ø¨ÙŠØ§Ù†Ø§Øª", data_management: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
                legacy_import_title: "ğŸ“¥ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… (V2)",
                legacy_import_desc: "Ø§Ø¶ØºØ· Ù‡Ù†Ø§ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ù…Ù† Ù…Ù„ÙØ§Øª Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø§Ø¶ÙŠØ©.",
                btn_import_legacy: "Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø³Ø¬Ù„Ø§Øª",
                btn_backup_download: "ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (JSON)",
                btn_restore_upload: "Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø© Ù…Ø­ÙÙˆØ¸Ø©",
                loading_processing: "Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...",
                msg_wrong_code: "Ø±Ù…Ø² Ø®Ø§Ø·Ø¦",
                msg_confirm_delete: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ",
                msg_confirm_restore: "ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø³ØªØ³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ",
                msg_restore_success: "ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.",
                msg_file_error: "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ù„Ù: ",
                msg_import_confirm: "Ø³ÙŠØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… (2026) Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯. Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¯ ØªØ£Ø®Ø° Ø«ÙˆØ§Ù†Ù. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ",
                msg_no_legacy_data: "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù….",
                msg_import_success: "ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ø¬Ø¯Ø¯ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!",
                loading_importing: "Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...",
                loading_backup: "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©...",
                loading_restoring: "Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...",
                badge_shift_b: "Ø§Ù„ÙˆØ±Ø¯ÙŠØ© B",
                ph_employee_name: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ",
                bulk_entry: "Ø¯Ø®ÙˆÙ„ Ø¬Ù…Ø§Ø¹ÙŠ",
                bulk_exit: "Ø®Ø±ÙˆØ¬ Ø¬Ù…Ø§Ø¹ÙŠ",
                lbl_viewer_control: "Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨",
                btn_login_log: "Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
                log_modal_title: "Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†",
                th_time: "Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®",
                th_role: "Ø§Ù„Ø±ØªØ¨Ø©",
                th_device: "Ø§Ù„Ø¬Ù‡Ø§Ø²",
                th_browser: "TarayÄ±cÄ±"
            },
            tr: {
                app_title: "Vardiya Sistemi",
                login_title: "GiriÅŸ",
                login_btn: "GiriÅŸ",
                status_online: "BaÄŸlÄ± ve HazÄ±r",
                status_offline: "BaÄŸlantÄ± Yok",
                reports_title: "Raporlar",
                logout: "Ã‡Ä±kÄ±ÅŸ",
                shift_date: "Tarih:",
                new_employee: "+ Personel",
                viewer_mode: "Ä°zleme",
                add_emp_title: "Personel Ekle/DÃ¼zenle",
                save: "Kaydet",
                cancel: "Ä°ptal",
                monthly_report: "AylÄ±k Rapor",
                annual_report: "YÄ±llÄ±k Rapor",
                btn_monthly_report: "AylÄ±k",
                btn_annual_report: "YÄ±llÄ±k",
                lbl_year: "YÄ±l",
                lbl_month: "Ay",
                close: "Kapat",
                export_excel: "Excel",
                th_name: "Personel",
                th_status: "Durum",
                th_entry: "GiriÅŸ",
                th_exit: "Ã‡Ä±kÄ±ÅŸ",
                th_break: "Mola",
                th_delay: "Gecikme",
                th_overtime: "Mesai",
                th_notes: "Not",
                th_delete: "Sil",
                no_data: "KayÄ±t yok.",
                val_present: "Mevcut", val_absent: "Yok", val_vacation: "Ä°zinli", val_holiday: "R.Tatil", val_sunday: "Pazar", val_choose: "--",
                th_present: "Geldi", th_absent: "Gelmedi", th_vacation: "Ä°zin", th_holiday: "R.Tatil", th_sunday: "Pazar", th_total_overtime: "Mesai", th_total_delay: "Gecikme",
                sum_title: "Ã–zet", sum_emp: "Personel:", sum_days: "GÃ¼n", sum_hrs: "S",
                day_sunday: "Pazar", day_monday: "Pazartesi", day_tuesday: "SalÄ±", day_wednesday: "Ã‡arÅŸamba", day_thursday: "PerÅŸembe", day_friday: "Cuma", day_saturday: "Cumartesi",
                lbl_shift: "Vardiya", val_all_shifts: "TÃ¼mÃ¼",
                val_shift_a: "Vardiya A", val_shift_b: "Vardiya B",
                role_admin: "Genel MÃ¼dÃ¼r: 56401", role_shift_b_man: "Sadece B Vardiya MÃ¼dÃ¼rÃ¼: 2222", role_accountant: "Muhasebeci: 3838",
                data_btn: "Veri", data_management: "Veri YÃ¶netimi",
                legacy_import_title: "ğŸ“¥ Eski Sistemden GeÃ§iÅŸ (V2)",
                legacy_import_desc: "Bu butonu sadece geÃ§en yÄ±lÄ±n dosyalarÄ±ndan personel ve devam verilerini getirmek istiyorsanÄ±z kullanÄ±n.",
                btn_import_legacy: "Personel ve KayÄ±tlarÄ± Ä°Ã§e Aktar",
                btn_backup_download: "Yedek Ä°ndir (JSON)",
                btn_restore_upload: "YedeÄŸi Geri YÃ¼kle",
                loading_processing: "Veriler iÅŸleniyor...",
                msg_wrong_code: "HatalÄ± Kod",
                msg_confirm_delete: "Bu personeli kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?",
                msg_confirm_restore: "UyarÄ±: Bu iÅŸlem mevcut verileri dosyadaki verilerle deÄŸiÅŸtirecektir. Emin misiniz?",
                msg_restore_success: "Geri yÃ¼kleme baÅŸarÄ±lÄ±! Sayfa yenilenecek.",
                msg_file_error: "Dosya hatasÄ±: ",
                msg_import_confirm: "Ä°simler ve devam kayÄ±tlarÄ± eski sistemden (2026) yeni sisteme aktarÄ±lacak. Ä°ÅŸlem birkaÃ§ saniye sÃ¼rebilir. Emin misiniz?",
                msg_no_legacy_data: "Bu yÄ±l iÃ§in eski sistemde veri bulunamadÄ±.",
                msg_import_success: "Yeni personeller iÃ§e aktarÄ±ldÄ± ve kayÄ±tlar baÅŸarÄ±yla gÃ¼ncellendi!",
                loading_importing: "Ä°simler ve veriler iÃ§e aktarÄ±lÄ±yor...",
                loading_backup: "Yedek hazÄ±rlanÄ±yor...",
                loading_restoring: "Veriler geri yÃ¼kleniyor...",
                badge_shift_b: "Vardiya B",
                ph_employee_name: "Ad Soyad",
                bulk_entry: "Toplu GiriÅŸ",
                bulk_exit: "Toplu Ã‡Ä±kÄ±ÅŸ",
                lbl_viewer_control: "Muhasebe GÃ¶rÃ¼nÃ¼mÃ¼",
                btn_login_log: "GiriÅŸ KaydÄ±",
                log_modal_title: "KullanÄ±cÄ± GiriÅŸ KaydÄ±",
                th_time: "Tarih ve Saat",
                th_role: "Rol",
                th_device: "Cihaz",
                th_browser: "TarayÄ±cÄ±"
            }
        };

        const browserLang = navigator.language || navigator.userLanguage || 'ar';
        let currentLang = browserLang.startsWith('ar') ? 'ar' : 'tr';

        function t(key) { return translations[currentLang][key] || key; }
        
        window.changeLanguage = function(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            
            const btnAr = document.getElementById('btn-ar');
            const btnTr = document.getElementById('btn-tr');
            
            if (lang === 'ar') { 
                btnAr.classList.add('lang-active');
                btnTr.classList.remove('lang-active');
            } else { 
                btnTr.classList.add('lang-active');
                btnAr.classList.remove('lang-active');
            }
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) el.innerText = translations[lang][key];
            });

            document.querySelectorAll('[data-i18n-ph]').forEach(el => {
                const key = el.getAttribute('data-i18n-ph');
                if (translations[lang][key]) el.placeholder = translations[lang][key];
            });

            renderDailyTable();
        };

        // Dark Mode Logic
        window.toggleDarkMode = function() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            const icons = document.querySelectorAll('.theme-toggle-icon');
            const devCardMain = document.getElementById('devCardMain');
            
            if (isDark) {
                icons.forEach(icon => {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                });
                localStorage.setItem('theme', 'dark');
                // Remove light-mode class to enable the dark glass effect
                devCardMain.classList.remove('light-mode');
            } else {
                icons.forEach(icon => {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                });
                localStorage.setItem('theme', 'light');
                // Add light-mode class for white background
                devCardMain.classList.add('light-mode');
            }
        };

        // Init Dark Mode
        const savedTheme = localStorage.getItem('theme');
        const icons = document.querySelectorAll('.theme-toggle-icon');
        if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark');
            icons.forEach(icon => {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            });
            document.getElementById('devCardMain').classList.remove('light-mode');
        } else {
            document.documentElement.classList.remove('dark');
            icons.forEach(icon => {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            });
            document.getElementById('devCardMain').classList.add('light-mode');
        }


        let firebaseConfig;
        let appId = 'cloud-shift-register';
        
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            if(typeof __app_id !== 'undefined' && __app_id) appId = __app_id;
        } else {
            firebaseConfig = {
                apiKey: "AIzaSyDzRczKA0tVr57TVFmnrr3F57REDTF4xHQ",
                authDomain: "cloud-shift-register.firebaseapp.com",
                projectId: "cloud-shift-register",
                storageBucket: "cloud-shift-register.firebasestorage.app",
                messagingSenderId: "823312208352",
                appId: "1:823312208352:web:fc0889a737e58482ce1b85"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userRole = '';
        let currentUserShift = 'all'; 
        let currentSelectedShift = 'all'; 
        let viewerPermissionFilter = 'all'; // What the admin sets for the viewer
        
        let masterEmployees = {}; 
        let currentMonthData = {}; 
        let loadedYearMonth = ''; 

        const EMPLOYEES_DOC = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'employees');
        const GLOBAL_SETTINGS_DOC = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global_config');
        const LOGS_DOC = doc(db, 'artifacts', appId, 'public', 'data', 'logs', 'access_history');
        const getMonthDoc = (year, month) => doc(db, 'artifacts', appId, 'public', 'data', 'months', `data_${year}_${month}`);
        const getLegacyYearDoc = (year) => doc(db, 'attendance_data', firebaseConfig.projectId === 'YOUR_PROJECT_ID' ? 'demo-app' : firebaseConfig.projectId, 'years', `data_${year}`);

        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                document.getElementById('loadingText').innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: " + error.message;
            }
        }
        initAuth();

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        function updateOnlineStatus() {
            const isOnline = navigator.onLine;
            const dot = document.getElementById('connectionDot');
            const text = document.getElementById('connectionText');
            
            if (isOnline) {
                dot.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
                text.className = "text-green-600 dark:text-green-400 text-xs font-bold";
                text.innerText = t('status_online');
                text.setAttribute('data-i18n', 'status_online');
            } else {
                dot.className = "w-2 h-2 rounded-full bg-red-500";
                text.className = "text-red-600 dark:text-red-400 text-xs font-bold";
                text.innerText = t('status_offline');
                text.setAttribute('data-i18n', 'status_offline');
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

        window.checkLogin = async function() {
            const code = document.getElementById('accessCode').value;
            const errorMsg = document.getElementById('loginError');
            
            const hashedCode = await sha256(code);
            
            const HASH_ADMIN = "c4a23934ebf78c703d11dae9ecb3bef502d930d585f53a2547d87e5099887729"; 
            const HASH_SHIFT_B = "edee29f882543b956620b26d0ee0e7e950399b1c4222f5de05e06425b4c995e9";
            const HASH_VIEWER = "d9cf8835e2a75f03b59e0371aacb3cdf2b71e0a471dc478742987f366cabeccc";

            document.getElementById('shiftSelectorContainer').classList.add('hidden');
            document.getElementById('dataBtn').classList.add('hidden');
            document.getElementById('shiftBadge').classList.add('hidden');
            document.getElementById('bulkControls').classList.add('hidden'); 
            document.getElementById('adminViewerControl').classList.add('hidden');
            
            let detectedRole = '';

            if (hashedCode === HASH_ADMIN) {
                userRole = 'admin';
                detectedRole = 'Admin';
                currentUserShift = 'all';
                document.getElementById('shiftSelectorContainer').classList.remove('hidden');
                document.getElementById('adminViewerControl').classList.remove('hidden'); 
                document.getElementById('dataBtn').classList.remove('hidden');
                document.getElementById('bulkControls').classList.remove('hidden'); 
                
                // Show Admin Only Buttons for Logs
                document.getElementById('btnExportLog').classList.remove('hidden');
                document.getElementById('btnClearLog').classList.remove('hidden');

                // Fetch current viewer permission setting
                getDoc(GLOBAL_SETTINGS_DOC).then(snap => {
                    if (snap.exists() && snap.data().viewerPermission) {
                        document.getElementById('viewerPermission').value = snap.data().viewerPermission;
                    }
                });

            } else if (hashedCode === HASH_SHIFT_B) {
                userRole = 'shift_b_manager';
                detectedRole = 'Shift B Manager';
                currentUserShift = 'shift_B';
                document.getElementById('shiftBadge').classList.remove('hidden');
                document.getElementById('shiftBadge').innerText = t('badge_shift_b');
                document.getElementById('bulkControls').classList.remove('hidden'); 
            } else if (hashedCode === HASH_VIEWER) {
                userRole = 'viewer';
                detectedRole = 'Accountant/Viewer';
                currentUserShift = 'all';
                setupViewerUI();
                listenToViewerPermission();
            } else {
                errorMsg.classList.remove('hidden');
                return;
            }

            // Log the successful login
            logAccess(detectedRole);

            document.getElementById('loadingScreen').classList.remove('hidden');
            
            const unsubEmp = onSnapshot(EMPLOYEES_DOC, (snap) => {
                if (snap.exists()) {
                    masterEmployees = snap.data().list || {};
                } else {
                    masterEmployees = {};
                }
                renderDailyTable();
            });

            const today = new Date();
            const dateInput = document.getElementById('currentDateInput');
            dateInput.value = today.toISOString().split('T')[0];
            
            changeDate();

            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
        };

        // Modified Log Access Function - Limit 20 and handles actions
        async function logAccess(role, action = null) {
            try {
                const now = new Date();
                const timestamp = now.toLocaleString('en-GB'); // DD/MM/YYYY, HH:MM:SS
                const userAgent = navigator.userAgent;
                const isMobile = /iPhone|iPad|iPod|Android/i.test(userAgent);
                const device = isMobile ? 'Mobile' : 'Desktop';
                
                let browser = 'Unknown';
                if(userAgent.indexOf("Chrome") != -1 && userAgent.indexOf("Edg") == -1) browser = 'Chrome';
                else if(userAgent.indexOf("Safari") != -1 && userAgent.indexOf("Chrome") == -1) browser = 'Safari';
                else if(userAgent.indexOf("Firefox") != -1) browser = 'Firefox';
                else if(userAgent.indexOf("Edg") != -1) browser = 'Edge';

                // If action is provided, append it to role for display purposes
                // Or store it separately. Here we keep it simple for the existing table structure
                let displayRole = role;
                if (action) {
                    displayRole = `${role} (${action})`;
                }

                const newEntry = {
                    role: displayRole,
                    time: timestamp,
                    device: device,
                    browser: browser,
                    agent: userAgent
                };

                const snap = await getDoc(LOGS_DOC);
                let history = [];
                if (snap.exists()) {
                    history = snap.data().entries || [];
                }

                history.unshift(newEntry);
                
                // REDUCED LIMIT TO 20
                if (history.length > 20) {
                    history = history.slice(0, 20);
                }

                await setDoc(LOGS_DOC, { entries: history }, { merge: true });

            } catch (e) {
                console.error("Logging failed", e);
            }
        }

        window.viewLoginLogs = async function() {
            const tbody = document.getElementById('loginLogTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4"><div class="loader mx-auto"></div></td></tr>';
            
            toggleModal('loginLogOverlay', true);

            try {
                const snap = await getDoc(LOGS_DOC);
                if (snap.exists() && snap.data().entries) {
                    const logs = snap.data().entries;
                    tbody.innerHTML = '';
                    
                    if(logs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">No logs found.</td></tr>';
                        return;
                    }

                    logs.forEach(log => {
                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition border-b dark:border-gray-700";
                        
                        let roleColor = 'text-gray-700';
                        if(log.role.includes('Admin')) roleColor = 'text-red-600 font-bold';
                        if(log.role.includes('Shift B')) roleColor = 'text-blue-600';
                        if(log.role.includes('Accountant')) roleColor = 'text-orange-600';

                        tr.innerHTML = `
                            <td class="p-3 ${roleColor} text-xs md:text-sm border-l dark:border-gray-600">${log.role}</td>
                            <td class="p-3 text-center ltr font-mono text-xs md:text-sm border-l dark:border-gray-600 text-gray-600 dark:text-gray-300">${log.time}</td>
                            <td class="p-3 text-center text-xs md:text-sm border-l dark:border-gray-600">${log.device === 'Mobile' ? 'ğŸ“±' : 'ğŸ’»'} <span class="hidden md:inline">${log.device}</span></td>
                            <td class="p-3 text-start text-xs md:text-sm text-gray-500 truncate max-w-[100px] md:max-w-none" title="${log.agent}">
                                ${log.browser}
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">No logs found.</td></tr>';
                }
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-red-500">Error: ${e.message}</td></tr>`;
            }
        };

        window.clearLoginLogs = async function() {
            if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) return;
            try {
                await setDoc(LOGS_DOC, { entries: [] });
                viewLoginLogs(); // Refresh
            } catch (e) {
                alert("Error clearing logs: " + e.message);
            }
        };

        window.exportLoginLogs = async function() {
            try {
                const snap = await getDoc(LOGS_DOC);
                if (!snap.exists() || !snap.data().entries) {
                    alert("No logs to export");
                    return;
                }
                const logs = snap.data().entries;
                
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
                csvContent += "Role,Time,Device,Browser,UserAgent\n";
                
                logs.forEach(log => {
                    const row = `"${log.role}","${log.time}","${log.device}","${log.browser}","${log.agent}"`;
                    csvContent += row + "\n";
                });

                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", "access_logs.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (e) {
                alert("Export failed: " + e.message);
            }
        };

        function setupViewerUI() {
            document.getElementById('adminControls').innerHTML = 
                `<div class="bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200 px-3 py-2 rounded border border-orange-200 dark:border-orange-800 font-bold text-sm">${t('viewer_mode')}</div>`;
            const style = document.createElement('style');
            style.innerHTML = '.delete-col { display: none; }';
            document.head.appendChild(style);
        }

        window.updateViewerPermission = async function(val) {
            try {
                await setDoc(GLOBAL_SETTINGS_DOC, { viewerPermission: val }, { merge: true });
            } catch (e) {
                console.error("Error saving permission", e);
            }
        };

        function listenToViewerPermission() {
             onSnapshot(GLOBAL_SETTINGS_DOC, (snap) => {
                if (snap.exists()) {
                    const perm = snap.data().viewerPermission || 'all';
                    const selector = document.getElementById('shiftSelectorContainer');
                    const filter = document.getElementById('shiftFilter');

                    if (perm === 'all') {
                        selector.classList.remove('hidden');
                        if (filter.value === '' || filter.value === 'all') {
                             currentSelectedShift = 'all';
                             filter.value = 'all';
                        }
                    } else {
                        selector.classList.add('hidden');
                        currentSelectedShift = perm;
                        filter.value = perm; 
                    }
                    renderDailyTable();
                }
            });
        }

        window.logout = function() { location.reload(); };

        let unsubscribeMonth = null;

        window.changeDate = function() {
            const dateStr = document.getElementById('currentDateInput').value;
            if(!dateStr) return;
            
            const dateObj = new Date(dateStr);
            const daysKey = ['day_sunday', 'day_monday', 'day_tuesday', 'day_wednesday', 'day_thursday', 'day_friday', 'day_saturday'];
            document.getElementById('dayNameDisplay').innerText = t(daysKey[dateObj.getDay()]);
            document.getElementById('dateDisplay').innerText = dateStr;

            const year = dateStr.split('-')[0];
            const month = dateStr.split('-')[1];
            const yearMonth = `${year}_${month}`;

            if (loadedYearMonth !== yearMonth) {
                loadMonthData(year, month);
            } else {
                renderDailyTable();
            }
        };

        window.adjustDate = function(days) {
            const input = document.getElementById('currentDateInput');
            if (!input.value) return;
            const date = new Date(input.value);
            date.setDate(date.getDate() + days);
            input.value = date.toISOString().split('T')[0];
            changeDate();
        };

        function loadMonthData(year, month) {
            if (unsubscribeMonth) unsubscribeMonth();
            
            document.getElementById('loadingText').innerText = t('loading_processing');
            document.getElementById('loadingScreen').classList.remove('hidden');
            loadedYearMonth = `${year}_${month}`;
            
            const monthDocRef = getMonthDoc(year, month);
            
            unsubscribeMonth = onSnapshot(monthDocRef, (snap) => {
                document.getElementById('loadingScreen').classList.add('hidden');
                if (snap.exists()) {
                    currentMonthData = snap.data().records || {};
                } else {
                    currentMonthData = {};
                }
                renderDailyTable();
            });
        }

        window.applyShiftFilter = function() {
            currentSelectedShift = document.getElementById('shiftFilter').value;
            renderDailyTable();
        };

        window.validateBulkInput = function(input) {
            let val = input.value.trim();
            if (!val) return;
            val = val.replace(/[^0-9:]/g, '');
            if (val.indexOf(':') === -1) {
                if (val.length <= 2) {
                    let hour = parseInt(val);
                    if (hour >= 0 && hour <= 23) val = val.padStart(2, '0') + ":00";
                } else if (val.length === 3) {
                    val = "0" + val.substring(0, 1) + ":" + val.substring(1);
                } else if (val.length === 4) {
                    val = val.substring(0, 2) + ":" + val.substring(2);
                }
            }
            if (/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(val)) {
                input.value = val;
            } else {
                input.value = ''; 
            }
        };

        window.applyBulkAction = async function(actionType) {
            const dateStr = document.getElementById('currentDateInput').value;
            const year = dateStr.split('-')[0];
            const month = dateStr.split('-')[1];
            
            let timeValue = '';
            if (actionType === 'entry') {
                timeValue = document.getElementById('bulkEntryInput').value;
            } else {
                timeValue = document.getElementById('bulkExitInput').value;
            }

            if (!timeValue) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ØªÙˆÙ‚ÙŠØª ØµØ­ÙŠØ­ Ø£ÙˆÙ„Ø§Ù‹");
                return;
            }

            let targetEmployees = [];
            
            Object.entries(masterEmployees).forEach(([id, data]) => {
                let shouldInclude = false;
                if (userRole === 'shift_b_manager') {
                    if (data.shift === 'shift_B') shouldInclude = true;
                } else if (userRole === 'admin') {
                    if (currentSelectedShift === 'all') shouldInclude = true;
                    else if (data.shift === currentSelectedShift) shouldInclude = true;
                }

                if (shouldInclude) {
                    targetEmployees.push(id);
                }
            });

            if (targetEmployees.length === 0) return;

            document.getElementById('loadingText').innerText = "Ø¬Ø§Ø±ÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ...";
            document.getElementById('loadingScreen').classList.remove('hidden');

            const updates = {};
            
            targetEmployees.forEach(empId => {
                const recordPath = `records.${empId}.${dateStr}`;
                
                if (!currentMonthData[empId]) currentMonthData[empId] = {};
                if (!currentMonthData[empId][dateStr]) currentMonthData[empId][dateStr] = {};
                
                updates[`${recordPath}.status`] = 'present';
                currentMonthData[empId][dateStr].status = 'present';

                if (actionType === 'entry') {
                    updates[`${recordPath}.entry`] = timeValue;
                    updates[`${recordPath}.breakDuration`] = '0.5'; 
                    currentMonthData[empId][dateStr].entry = timeValue;
                    currentMonthData[empId][dateStr].breakDuration = '0.5';
                } else {
                    updates[`${recordPath}.exit`] = timeValue;
                    currentMonthData[empId][dateStr].exit = timeValue;
                }
            });

            try {
                const docRef = getMonthDoc(year, month);
                await updateDoc(docRef, updates);
                renderDailyTable();
            } catch (e) {
                try {
                    const docRef = getMonthDoc(year, month);
                    const deepObj = { records: {} };
                    targetEmployees.forEach(empId => {
                        deepObj.records[empId] = { [dateStr]: currentMonthData[empId][dateStr] };
                    });
                    await setDoc(docRef, deepObj, { merge: true });
                    renderDailyTable();
                } catch (err) {
                    console.error("Bulk update failed", err);
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ");
                }
            } finally {
                document.getElementById('loadingScreen').classList.add('hidden');
                if (actionType === 'entry') document.getElementById('bulkEntryInput').value = '';
                else document.getElementById('bulkExitInput').value = '';
            }
        };

        let dragSrcEl = null;

        window.handleDragStart = function(e) {
            if (userRole !== 'admin') return;
            this.classList.add('dragging');
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.getAttribute('data-emp-id'));
        };

        window.handleDragOver = function(e) {
            if (e.preventDefault) e.preventDefault();
            if (userRole !== 'admin') return;
            this.classList.add('drag-over');
            e.dataTransfer.dropEffect = 'move';
            return false;
        };

        window.handleDragLeave = function(e) {
            this.classList.remove('drag-over');
        };

        window.handleDrop = function(e) {
            if (e.stopPropagation) e.stopPropagation();
            if (dragSrcEl === this || userRole !== 'admin') return;

            this.classList.remove('drag-over');
            dragSrcEl.classList.remove('dragging');

            const sourceId = e.dataTransfer.getData('text/plain');
            const targetId = this.getAttribute('data-emp-id');
            
            reorderEmployees(sourceId, targetId);

            return false;
        };

        async function reorderEmployees(sourceId, targetId) {
            let empArray = Object.entries(masterEmployees).map(([id, data]) => ({
                id: id,
                ...data,
                order: data.order || 9999
            })).sort((a, b) => (a.order || 0) - (b.order || 0) || a.name.localeCompare(b.name));

            const sourceIndex = empArray.findIndex(e => e.id === sourceId);
            const targetIndex = empArray.findIndex(e => e.id === targetId);

            if (sourceIndex > -1 && targetIndex > -1) {
                const [movedItem] = empArray.splice(sourceIndex, 1);
                empArray.splice(targetIndex, 0, movedItem);

                const updates = {};
                empArray.forEach((emp, index) => {
                    const newOrder = index + 1;
                    masterEmployees[emp.id].order = newOrder;
                    updates[`list.${emp.id}.order`] = newOrder;
                });

                renderDailyTable();
                
                try {
                    await updateDoc(EMPLOYEES_DOC, updates);
                } catch (e) {
                    console.error("Order save failed", e);
                }
            }
        }

        // Add this helper function to prevent XSS and HTML breaking
        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        window.renderDailyTable = function() {
            const tbody = document.getElementById('dailyTableBody');
            tbody.innerHTML = '';
            
            const dateStr = document.getElementById('currentDateInput').value;
            if (!dateStr) return;

            let empArray = Object.entries(masterEmployees).map(([id, data]) => ({
                id: id,
                name: data.name,
                shift: data.shift || 'shift_A',
                order: data.order || 9999
            }));

            if (userRole === 'shift_b_manager') {
                empArray = empArray.filter(e => e.shift === 'shift_B');
            } else if ((userRole === 'admin' || userRole === 'viewer') && currentSelectedShift !== 'all') {
                empArray = empArray.filter(e => e.shift === currentSelectedShift);
            }

            empArray.sort((a, b) => (a.order || 0) - (b.order || 0) || a.name.localeCompare(b.name));

            if (empArray.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }
            document.getElementById('emptyState').classList.add('hidden');

            empArray.forEach((emp, index) => {
                const empId = emp.id;
                const empName = emp.name;
                
                const empMonthRecord = currentMonthData[empId] || {};
                const dayData = empMonthRecord[dateStr] || { status: '', entry: '', exit: '', breakDuration: '0', shortage: '', overtime: '', notes: '' };

                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 dark:hover:bg-gray-700 border-b transition duration-150";
                
                if (userRole === 'admin') {
                    tr.setAttribute('draggable', 'true');
                    tr.classList.add('draggable-row');
                    tr.setAttribute('data-emp-id', empId);
                    tr.addEventListener('dragstart', handleDragStart);
                    tr.addEventListener('dragover', handleDragOver);
                    tr.addEventListener('dragleave', handleDragLeave);
                    tr.addEventListener('drop', handleDrop);
                }

                if(dayData.status === 'absent') tr.classList.add('bg-red-50', 'dark:bg-red-900/20');
                if(dayData.status === 'vacation') tr.classList.add('bg-yellow-50', 'dark:bg-yellow-900/20');
                if(dayData.status === 'present') tr.classList.add('bg-green-50', 'dark:bg-green-900/20');
                if(dayData.status === 'holiday') tr.classList.add('status-holiday');
                if(dayData.status === 'sunday') tr.classList.add('status-sunday');

                const isViewer = userRole === 'viewer';
                const isInputsFrozen = !dayData.status || (dayData.status !== 'present' && dayData.status !== 'holiday' && dayData.status !== 'sunday');
                const inputsDisabled = isInputsFrozen || isViewer ? 'disabled' : '';
                const isDisabled = isViewer ? 'disabled' : '';

                const dragIcon = userRole === 'admin' ? '<span class="drag-handle" title="Ø§Ø³Ø­Ø¨ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨">â˜°</span>' : '';

                // Use escapeHtml for user-input fields
                const escapedName = escapeHtml(empName);
                const escapedNotes = escapeHtml(dayData.notes || '');

                tr.innerHTML = `
                    <td class="p-3 text-center text-gray-500 dark:text-gray-400 flex justify-center items-center" data-label="#" data-label-type="index">
                        ${index + 1} ${dragIcon}
                    </td>
                    <td class="p-3 font-bold text-gray-800 dark:text-gray-200 cursor-pointer hover:bg-blue-50 dark:hover:bg-gray-700 transition-colors select-none group" 
                        onclick="showEmployeeSummary('${empId}')" 
                        data-label="${t('th_name')}" data-label-type="name">
                        <div class="flex items-center justify-between">
                            <span class="hover:text-blue-600 dark:hover:text-blue-400">${escapedName}</span>
                            ${userRole === 'admin' ? `
                            <button onclick="event.stopPropagation(); openEditEmployeeModal('${empId}')" class="text-gray-400 hover:text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity px-1 text-lg" title="ØªØ¹Ø¯ÙŠÙ„">
                                âœ
                            </button>
                            ` : ''}
                        </div>
                    </td>
                    
                    <td class="p-3" data-label="${t('th_status')}">
                        <select onchange="saveData('${empId}', '${dateStr}', 'status', this.value)" ${isDisabled}
                                class="w-full p-2 border rounded bg-white dark:bg-gray-700 text-sm focus:ring-2 focus:ring-blue-400 outline-none cursor-pointer border-gray-200 dark:border-gray-600 dark:text-white">
                            <option value="">${t('val_choose')}</option>
                            <option value="present" ${dayData.status === 'present' ? 'selected' : ''}>${t('val_present')}</option>
                            <option value="sunday" ${dayData.status === 'sunday' ? 'selected' : ''}>${t('val_sunday')}</option>
                            <option value="absent" ${dayData.status === 'absent' ? 'selected' : ''}>${t('val_absent')}</option>
                            <option value="vacation" ${dayData.status === 'vacation' ? 'selected' : ''}>${t('val_vacation')}</option>
                            <option value="holiday" ${dayData.status === 'holiday' ? 'selected' : ''}>${t('val_holiday')}</option>
                        </select>
                    </td>

                    <td class="p-3" data-label="${t('th_entry')}">
                        <input type="tel" inputmode="numeric" pattern="[0-9]*" value="${dayData.entry || ''}" placeholder="--:--" onchange="handleSmartTimeInput(this, '${empId}', '${dateStr}', 'entry')" ${inputsDisabled} class="w-full p-2 border rounded bg-white dark:bg-gray-700 text-sm text-center ltr placeholder-gray-300 dark:placeholder-gray-500 border-gray-200 dark:border-gray-600 dark:text-white">
                    </td>
                    <td class="p-3" data-label="${t('th_exit')}">
                        <input type="tel" inputmode="numeric" pattern="[0-9]*" value="${dayData.exit || ''}" placeholder="--:--" onchange="handleSmartTimeInput(this, '${empId}', '${dateStr}', 'exit')" ${inputsDisabled} class="w-full p-2 border rounded bg-white dark:bg-gray-700 text-sm text-center ltr placeholder-gray-300 dark:placeholder-gray-500 border-gray-200 dark:border-gray-600 dark:text-white">
                    </td>
                    <td class="p-3" data-label="${t('th_break')}">
                        <input type="number" inputmode="decimal" step="0.5" min="0" value="${dayData.breakDuration || '0'}" onchange="saveData('${empId}', '${dateStr}', 'breakDuration', this.value)" ${inputsDisabled} class="w-full p-2 border rounded bg-white dark:bg-gray-700 text-sm text-center border-gray-200 dark:border-gray-600 dark:text-white">
                    </td>
                    <td class="p-3" data-label="${t('th_delay')}">
                        <input type="number" inputmode="decimal" step="0.5" max="0" value="${dayData.shortage || ''}" onchange="if(this.value > 0) this.value = -this.value; saveData('${empId}', '${dateStr}', 'shortage', this.value)" ${inputsDisabled} class="w-full p-2 border rounded bg-white dark:bg-gray-700 text-sm text-center text-red-600 dark:text-red-400 placeholder-red-300 dark:placeholder-red-900 border-gray-200 dark:border-gray-600" placeholder="-">
                    </td>
                    <td class="p-3" data-label="${t('th_overtime')}">
                        <input type="number" inputmode="decimal" step="0.5" value="${dayData.overtime || ''}" onchange="saveData('${empId}', '${dateStr}', 'overtime', this.value)" ${inputsDisabled} class="w-full p-2 border rounded bg-white dark:bg-gray-700 text-sm text-center border-gray-200 dark:border-gray-600 dark:text-white" placeholder="0">
                    </td>
                    <td class="p-3" data-label="${t('th_notes')}">
                        <input 
                            type="text" 
                            value="${escapedNotes}" 
                            title="${escapedNotes}" 
                            dir="ltr"
                            onchange="saveData('${empId}', '${dateStr}', 'notes', this.value)" 
                            ${isDisabled} 
                            class="note-input w-full p-2 border rounded bg-white dark:bg-gray-700 text-sm border-gray-200 dark:border-gray-600 text-red-600 dark:text-red-400 font-bold text-left focus:bg-red-50 dark:focus:bg-red-900/10 transition-colors placeholder-red-200 dark:placeholder-red-900" 
                            placeholder="..."
                        >
                    </td>
                    
                    ${userRole === 'admin' ? 
                    `<td class="p-3 text-center delete-col" data-label="${t('th_delete')}"><button onclick="deleteEmployee('${empId}')" class="text-red-400 hover:text-red-700 font-bold px-2">Ã—</button></td>` 
                    : '<td class="p-3"></td>'}
                `;
                tbody.appendChild(tr);
            });
        };

        window.saveData = async function(empId, date, field, value) {
            if (userRole === 'viewer') return;
            const year = date.split('-')[0];
            const month = date.split('-')[1];
            
            if (!currentMonthData[empId]) currentMonthData[empId] = {};
            if (!currentMonthData[empId][date]) currentMonthData[empId][date] = {};
            currentMonthData[empId][date][field] = value;

            const record = currentMonthData[empId][date];
            if (field === 'status') {
                if (value === 'absent' || value === 'vacation') {
                    record.entry = ''; record.exit = ''; record.breakDuration = '0'; record.shortage = ''; record.overtime = '';
                }
                if (value === 'present') {
                    record.breakDuration = '0.5';
                }
            }

            const updates = {};
            updates[`records.${empId}.${date}.${field}`] = value;
            if (field === 'status' && (value === 'absent' || value === 'vacation')) {
                updates[`records.${empId}.${date}.entry`] = '';
                updates[`records.${empId}.${date}.exit`] = '';
                updates[`records.${empId}.${date}.breakDuration`] = '0';
                updates[`records.${empId}.${date}.shortage`] = '';
                updates[`records.${empId}.${date}.overtime`] = '';
            }
            if (field === 'status' && value === 'present') {
                updates[`records.${empId}.${date}.breakDuration`] = '0.5';
            }
            if ((field === 'entry' || field === 'exit') && value && !record.status) {
                updates[`records.${empId}.${date}.status`] = 'present';
            }

            try {
                const docRef = getMonthDoc(year, month);
                await updateDoc(docRef, updates);
            } catch (e) {
                const docRef = getMonthDoc(year, month);
                const deepObj = { records: { [empId]: { [date]: record } } };
                await setDoc(docRef, deepObj, { merge: true });
            }
        };

        window.openAddEmployeeModal = function() {
            document.getElementById('empModalTitle').innerText = t('add_emp_title');
            document.getElementById('editEmployeeId').value = '';
            document.getElementById('newEmployeeName').value = '';
            
            const shiftSelect = document.getElementById('newEmployeeShift');
            if (userRole === 'shift_b_manager') {
                shiftSelect.value = 'shift_B';
                shiftSelect.disabled = true;
            } else {
                shiftSelect.value = 'shift_A';
                shiftSelect.disabled = false;
            }
            
            toggleModal('addEmployeeOverlay', true);
        };

        window.openEditEmployeeModal = function(empId) {
            const emp = masterEmployees[empId];
            if(!emp) return;
            document.getElementById('empModalTitle').innerText = t('add_emp_title');
            document.getElementById('editEmployeeId').value = empId;
            document.getElementById('newEmployeeName').value = emp.name;
            
            const shiftSelect = document.getElementById('newEmployeeShift');
            shiftSelect.value = emp.shift || 'shift_A';
            
            if (userRole === 'shift_b_manager') {
                shiftSelect.disabled = true;
            } else {
                shiftSelect.disabled = false;
            }

            toggleModal('addEmployeeOverlay', true);
        };

        window.saveEmployeeToMasterList = async function() {
            const id = document.getElementById('editEmployeeId').value;
            const name = document.getElementById('newEmployeeName').value.trim();
            const shift = document.getElementById('newEmployeeShift').value;

            if (!name) return;

            let newOrder = 9999;
            if (!id) {
                 const orders = Object.values(masterEmployees).map(e => e.order || 0);
                 const maxOrder = Math.max(...orders, 0);
                 newOrder = maxOrder + 1;
            }

            const updates = {};
            if (id) {
                updates[`list.${id}.name`] = name;
                updates[`list.${id}.shift`] = shift;
            } else {
                const newId = 'emp_' + Date.now();
                updates[`list.${newId}`] = { name: name, shift: shift, order: newOrder };
            }

            try {
                await updateDoc(EMPLOYEES_DOC, updates);
            } catch (e) {
                const deepObj = { list: {} };
                const newId = id || 'emp_' + Date.now();
                deepObj.list[newId] = { name: name, shift: shift, order: newOrder };
                await setDoc(EMPLOYEES_DOC, deepObj, { merge: true });
            }
            toggleModal('addEmployeeOverlay', false);
        };

        window.deleteEmployee = async function(empId) {
            if (!confirm(t('msg_confirm_delete'))) return;
            const newMap = { ...masterEmployees };
            const name = newMap[empId]?.name || 'Unknown';
            delete newMap[empId];
            await setDoc(EMPLOYEES_DOC, { list: newMap });
            
            // Log this action
            await logAccess('Admin', `Deleted: ${name}`);
        };

        window.importLegacyEmployees = async function() {
            if(!confirm(t('msg_import_confirm'))) return;
            
            document.getElementById('loadingText').innerText = t('loading_importing');
            document.getElementById('loadingScreen').classList.remove('hidden');

            const currentYear = new Date().getFullYear(); 

            try {
                const legacyDocRef = getLegacyYearDoc(currentYear);
                const snap = await getDoc(legacyDocRef);
                
                if (!snap.exists()) {
                    alert(t('msg_no_legacy_data'));
                    document.getElementById('loadingScreen').classList.add('hidden');
                    return;
                }

                const legacyData = snap.data();
                const legacyEmployees = legacyData.employees || [];
                const legacyRecords = legacyData.records || {};

                const nameToIdMap = {};
                const empUpdates = {};
                let newEmpCount = 0;
                
                const orders = Object.values(masterEmployees).map(e => e.order || 0);
                let currentMaxOrder = Math.max(...orders, 0);

                Object.entries(masterEmployees).forEach(([id, data]) => {
                    nameToIdMap[data.name] = id;
                });

                legacyEmployees.forEach(name => {
                    if (!nameToIdMap[name]) {
                        const newId = 'emp_legacy_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
                        nameToIdMap[name] = newId;
                        currentMaxOrder++;
                        empUpdates[`list.${newId}`] = { name: name, shift: 'shift_A', order: currentMaxOrder };
                        newEmpCount++;
                    }
                });

                if (newEmpCount > 0) {
                     await updateDoc(EMPLOYEES_DOC, empUpdates).catch(async () => {
                         const deepObj = { list: {} };
                         Object.keys(empUpdates).forEach(k => {
                             const key = k.split('.')[1];
                             deepObj.list[key] = empUpdates[k];
                         });
                         await setDoc(EMPLOYEES_DOC, deepObj, { merge: true });
                     });
                     Object.keys(empUpdates).forEach(k => {
                         const id = k.split('.')[1];
                         masterEmployees[id] = empUpdates[k];
                     });
                }

                const monthlyUpdates = {}; 

                Object.keys(legacyRecords).forEach(empName => {
                    const empId = nameToIdMap[empName];
                    if (!empId) return;

                    const empDates = legacyRecords[empName];
                    Object.keys(empDates).forEach(date => {
                        const [y, m, d] = date.split('-');
                        if (y != currentYear) return;

                        if (!monthlyUpdates[m]) monthlyUpdates[m] = {};
                        if (!monthlyUpdates[m][empId]) monthlyUpdates[m][empId] = {};

                        monthlyUpdates[m][empId][date] = empDates[date];
                    });
                });

                const monthsToUpdate = Object.keys(monthlyUpdates);
                let recordsCount = 0;

                for (const m of monthsToUpdate) {
                    const monthDocRef = getMonthDoc(currentYear, m);
                    await setDoc(monthDocRef, { records: monthlyUpdates[m] }, { merge: true });
                    recordsCount += Object.keys(monthlyUpdates[m]).length;
                }
                
                // Log action
                await logAccess('Admin', `Imported Legacy Data`);

                alert(t('msg_import_success'));
                
                changeDate(); 

            } catch (e) {
                console.error(e);
                alert(t('msg_file_error') + e.message);
            } finally {
                document.getElementById('loadingScreen').classList.add('hidden');
                toggleModal('dataManagerOverlay', false);
            }
        };

        window.exportBackup = async function() {
            document.getElementById('loadingText').innerText = t('loading_backup');
            document.getElementById('loadingScreen').classList.remove('hidden');
            
            const backupData = {
                version: "3.0",
                date: new Date().toISOString(),
                employees: masterEmployees,
                months: {}
            };

            const year = new Date().getFullYear();
            for (let m = 1; m <= 12; m++) {
                const mm = String(m).padStart(2, '0');
                try {
                    const snap = await getDoc(getMonthDoc(year, mm));
                    if (snap.exists()) {
                        backupData.months[`${year}_${mm}`] = snap.data();
                    }
                } catch(e) {}
            }

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData));
            
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            const fileName = `backup_${yyyy}-${mm}-${dd}_${hh}-${min}.json`;

            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", fileName);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();

            document.getElementById('loadingScreen').classList.add('hidden');
        };

        window.restoreBackup = function(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const content = e.target.result;
                try {
                    const data = JSON.parse(content);
                    if (!data.employees) throw new Error("Invalid File");

                    if (!confirm(t('msg_confirm_restore'))) return;

                    document.getElementById('loadingText').innerText = t('loading_restoring');
                    document.getElementById('loadingScreen').classList.remove('hidden');

                    await setDoc(EMPLOYEES_DOC, { list: data.employees });

                    const batch = writeBatch(db);
                    let opCount = 0;
                    
                    for (const [key, monthData] of Object.entries(data.months)) {
                        const [y, m] = key.split('_');
                        const docRef = getMonthDoc(y, m);
                        batch.set(docRef, monthData);
                        opCount++;
                    }
                    
                    if(opCount > 0) await batch.commit();

                    alert(t('msg_restore_success'));
                    location.reload();

                } catch (err) {
                    alert(t('msg_file_error') + err.message);
                    document.getElementById('loadingScreen').classList.add('hidden');
                }
            };
            reader.readAsText(file);
        };

        window.toggleModal = function(id, show) {
            const el = document.getElementById(id);
            if(show) { 
                el.classList.remove('hidden'); 
                document.body.style.overflow = 'hidden'; 
            } else { 
                el.classList.add('hidden'); 
                document.body.style.overflow = ''; 
            }
        };

        window.handleSmartTimeInput = function(input, empId, dateStr, field) {
            let val = input.value.trim();
            if(!val) { saveData(empId, dateStr, field, ''); return; }
            val = val.replace(/[^0-9:]/g, '');
            if (val.indexOf(':') === -1) {
                if (val.length <= 2) {
                    let hour = parseInt(val);
                    if (hour >= 0 && hour <= 23) val = val.padStart(2, '0') + ":00";
                } else if (val.length === 3) {
                    val = "0" + val.substring(0, 1) + ":" + val.substring(1);
                } else if (val.length === 4) {
                    val = val.substring(0, 2) + ":" + val.substring(2);
                }
            }
            if (/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(val)) {
                input.value = val;
                saveData(empId, dateStr, field, val);
            }
        };

        window.adjustRepYear = function(delta) {
            const input = document.getElementById('repYearInput');
            let val = parseInt(input.value) || new Date().getFullYear();
            input.value = val + delta;
        };

        window.openReportModal = function() {
            const today = new Date();
            document.getElementById('repYearInput').value = today.getFullYear();
            document.getElementById('repMonthSelect').value = String(today.getMonth() + 1).padStart(2, '0');
            toggleModal('monthlyReportOverlay', true);
            generateReport('monthly');
        };

        let currentReportType = 'monthly';

        window.generateReport = async function(type) {
            currentReportType = type;
            const year = document.getElementById('repYearInput').value;
            const month = document.getElementById('repMonthSelect').value;
            const tbody = document.getElementById('reportTableBody');
            
            tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4"><div class="loader mx-auto"></div></td></tr>';
            
            let reportData = {};
            
            Object.keys(masterEmployees).forEach(id => {
                reportData[id] = { 
                    name: masterEmployees[id].name, 
                    shift: masterEmployees[id].shift,
                    order: masterEmployees[id].order || 9999,
                    present: 0, absent: 0, vacation: 0, holiday: 0, sunday: 0, overtime: 0, delay: 0 
                };
            });

            let monthsToFetch = [];
            if (type === 'monthly') {
                monthsToFetch.push(month);
            } else {
                monthsToFetch = ['01','02','03','04','05','06','07','08','09','10','11','12'];
            }

            for (const m of monthsToFetch) {
                try {
                    const snap = await getDoc(getMonthDoc(year, m));
                    if (snap.exists()) {
                        const records = snap.data().records || {};
                        Object.keys(records).forEach(empId => {
                            if (!reportData[empId]) return;
                            const days = records[empId];
                            Object.values(days).forEach(day => {
                                if (day.status === 'present') reportData[empId].present++;
                                if (day.status === 'absent') reportData[empId].absent++;
                                if (day.status === 'vacation') reportData[empId].vacation++;
                                if (day.status === 'holiday') reportData[empId].holiday++;
                                if (day.status === 'sunday') reportData[empId].sunday++;
                                reportData[empId].overtime += parseFloat(day.overtime) || 0;
                                reportData[empId].delay += parseFloat(day.shortage) || 0;
                            });
                        });
                    }
                } catch(e) {}
            }

            tbody.innerHTML = '';
            document.getElementById('reportTitleDisplay').innerText = 
                type === 'monthly' ? `${t('monthly_report')} (${year}-${month})` : `${t('annual_report')} (${year})`;

            const sortedReportData = Object.values(reportData).sort((a, b) => {
                return (a.order || 0) - (b.order || 0) || a.name.localeCompare(b.name);
            });

            sortedReportData.forEach(d => {
                if (userRole === 'shift_b_manager' && d.shift !== 'shift_B') return;
                if ((userRole === 'admin' || userRole === 'viewer') && currentSelectedShift !== 'all' && d.shift !== currentSelectedShift) return;

                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 dark:hover:bg-gray-700 transition duration-150";
                tr.innerHTML = `
                    <td class="p-3 border dark:border-gray-600 font-bold bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-200" data-label="${t('th_name')}" data-label-type="name">${d.name}</td>
                    <td class="p-3 border dark:border-gray-600 text-center text-green-700 dark:text-green-400 font-bold" data-label="${t('th_present')}">${d.present}</td>
                    <td class="p-3 border dark:border-gray-600 text-center text-red-700 dark:text-red-400 font-bold" data-label="${t('th_absent')}">${d.absent}</td>
                    <td class="p-3 border dark:border-gray-600 text-center text-yellow-700 dark:text-yellow-400 font-bold" data-label="${t('th_vacation')}">${d.vacation}</td>
                    <td class="p-3 border dark:border-gray-600 text-center text-purple-700 dark:text-purple-400 font-bold" data-label="${t('th_holiday')}">${d.holiday}</td>
                    <td class="p-3 border dark:border-gray-600 text-center text-cyan-700 dark:text-cyan-400 font-bold" data-label="${t('th_sunday')}">${d.sunday}</td>
                    <td class="p-3 border dark:border-gray-600 text-center text-blue-700 dark:text-blue-400 font-bold" data-label="${t('th_total_overtime')}">${d.overtime}</td>
                    <td class="p-3 border dark:border-gray-600 text-center text-red-600 dark:text-red-500 font-bold" data-label="${t('th_total_delay')}"><span dir="ltr">${Math.abs(d.delay)}</span></td>
                `;
                tbody.appendChild(tr);
            });
        };

        window.exportReportToCSV = function() {
            const rows = document.querySelectorAll('#reportTableBody tr');
            if (rows.length === 0) return;
            
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += `${t('th_name')},${t('th_present')},${t('th_absent')},${t('th_vacation')},${t('th_holiday')},${t('th_sunday')},${t('th_total_overtime')},${t('th_total_delay')}\n`;

            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                const rowData = Array.from(cols).map(c => `"${c.innerText}"`).join(",");
                csvContent += rowData + "\n";
            });

            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        window.showEmployeeSummary = function(empId) {
            const empName = masterEmployees[empId]?.name || 'Unknown';
            const dateStr = document.getElementById('currentDateInput').value;
            const currentMonth = dateStr.slice(0, 7); 
            
            let present = 0, absent = 0, vacation = 0, holiday = 0, sunday = 0, totalOvertime = 0, totalShortage = 0;
            const empData = currentMonthData[empId] || {};
            
            Object.values(empData).forEach(d => {
                if (d.status === 'present') present++;
                if (d.status === 'absent') absent++;
                if (d.status === 'vacation') vacation++;
                if (d.status === 'holiday') holiday++; 
                if (d.status === 'sunday') sunday++;
                totalOvertime += parseFloat(d.overtime) || 0;
                totalShortage += parseFloat(d.shortage) || 0;
            });
            
            const statsContainer = document.getElementById('employeeStatsCard');
            statsContainer.classList.remove('hidden');
            statsContainer.innerHTML = `
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <h3 class="font-bold text-xl text-blue-900 dark:text-blue-300 flex items-center gap-2">
                            <span class="bg-blue-100 dark:bg-blue-900 p-1 rounded text-blue-600 dark:text-blue-300">ğŸ‘¤</span>
                            ${t('sum_title')} ${t('sum_emp')} <span class="text-indigo-600 dark:text-indigo-300 underline">${empName}</span>
                        </h3>
                    </div>
                    <div class="flex flex-wrap gap-4 text-sm font-bold">
                        <div class="bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 text-green-800 dark:text-green-300 px-4 py-2 rounded-lg text-center">
                            <span class="text-xs block text-green-500 dark:text-green-400">${t('th_present')}</span> ${present}
                        </div>
                        <div class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-800 dark:text-red-300 px-4 py-2 rounded-lg text-center">
                            <span class="text-xs block text-red-500 dark:text-red-400">${t('th_absent')}</span> ${absent}
                        </div>
                         <div class="bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-800 text-yellow-800 dark:text-yellow-300 px-4 py-2 rounded-lg text-center">
                            <span class="text-xs block text-yellow-600 dark:text-yellow-400">${t('th_vacation')}</span> ${vacation}
                        </div>
                        <div class="bg-purple-50 dark:bg-purple-900/30 border border-purple-200 dark:border-purple-800 text-purple-800 dark:text-purple-300 px-4 py-2 rounded-lg text-center">
                            <span class="text-xs block text-purple-600 dark:text-purple-400">${t('th_holiday')}</span> ${holiday}
                        </div>
                        <div class="bg-cyan-50 dark:bg-cyan-900/30 border border-cyan-200 dark:border-cyan-800 text-cyan-800 dark:text-cyan-300 px-4 py-2 rounded-lg text-center">
                            <span class="text-xs block text-cyan-600 dark:text-cyan-400">${t('th_sunday')}</span> ${sunday}
                        </div>
                        <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-300 px-4 py-2 rounded-lg text-center">
                            <span class="text-xs block text-blue-500 dark:text-blue-400">${t('th_overtime')}</span> ${totalOvertime}
                        </div>
                        <div class="bg-orange-50 dark:bg-orange-900/30 border border-orange-200 dark:border-orange-800 text-orange-800 dark:text-orange-300 px-4 py-2 rounded-lg text-center">
                            <span class="text-xs block text-orange-500 dark:text-orange-400">${t('th_delay')}</span> <span dir="ltr">${Math.abs(totalShortage)}</span>
                        </div>
                    </div>
                    <button onclick="document.getElementById('employeeStatsCard').classList.add('hidden')" class="bg-gray-100 dark:bg-gray-600 px-3 py-1 rounded text-gray-500 dark:text-gray-300">Ã—</button>
                </div>
            `;
            statsContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        };

        document.getElementById('accessCode').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') window.checkLogin();
        });

        changeLanguage(currentLang);

    </script>
</body>
</html>
